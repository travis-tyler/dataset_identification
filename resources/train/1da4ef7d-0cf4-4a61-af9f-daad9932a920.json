[{"section_title": "Abstract", "text": "Abstract. The analysis of longitudinal trajectories is a longstanding problem in medical imaging which is often tackled in the context of Riemannian geometry: the set of observations is assumed to lie on an a priori known Riemannian manifold. When dealing with high-dimensional or complex data, it is in general not possible to design a Riemannian geometry of relevance. In this paper, we perform Riemannian manifold learning in association with the statistical task of longitudinal trajectory analysis. After inference, we obtain both a submanifold of observations and a Riemannian metric so that the observed progressions are geodesics. This is achieved using a deep generative network, which maps trajectories in a low-dimensional Euclidean space to the observation space."}, {"section_title": "Introduction", "text": "The analysis of the longitudinal aspects of a disease is key to understand its progression as well as to design prognosis and early diagnostic tools. Indeed, the time dynamic of a disease is more informative than static observations of the symptoms, especially for neuro-degenerative diseases whose progression span over years with early subtle changes. More specifically, we tackle in this paper the issue of disease modelling: we aim at building a time continuous reference of disease progression and at providing a low-dimensional representation of each subject encoding his position with respect to this reference. This task must be achieved using longitudinal datasets, which contain repeated observations of clinical measurements or medical images of subjects over time. In particular, we aim at being able to achieve this longitudinal modelling even when dealing with very high-dimensional data.\nThe framework of Riemannian geometry is well suited for the analysis of longitudinal trajectories. It allows for principled approaches which respect the nature of the data -e.g. explicit constraints-and can embody some a priori knowledge. When a Riemannian manifold of interest is identified for a given type of data, it is possible to formulate generative models of progression on this manifold directly. In [3, 10, 14] , the authors propose a mixed-effect model which assumes that each subject follows a trajectory which is parallel to a reference geodesic on a Riemannian manifold. In [16] , a similar approach is constructed with a hierarchical model of geodesic progressions. All these approaches make use of a predefined Riemannian geometry on the space of observations.\nA main limitation of these approaches is therefore the need of this known Riemannian manifold to work on. It may be possible to coin a relevant Riemannian manifold in low-dimensional cases and with expert knowledge, but it is nearly impossible in the more general case of high-dimensional data or when multiple modalities are present. Designing a Riemannian metric is in particular very challenging, as the space of Riemannian metrics on a manifold is vastly large and complex. A first possibility, popular in the literature, is to equip a submanifold of the observation space with the metric induced from a metric on the whole space of observations -e.g.\n2 on images. However, we argue here that this choice of larger metric is arbitrary and has no reason to be of particular relevance for the analysis at hand. Another possibility is to consider the space of observations as a product of simple manifolds, each equipped with a Riemannian metric. This is only possible in particular cases, and even so, the product structure constrains the shapes of the geodesics which need to be geodesics on each coordinate. Other constructions of Riemannian metrics exist in special cases, but there is no simple general procedure. Hence, there is a need for data-driven metric estimation.\nA few Riemannian metric learning approaches do exist in the litterature. In [6] , the authors propose to learn a Riemannian metric which is defined by interpolation of a finite set of tensors, and they optimize the tensors so as to separate a set of data according to known labels. This procedure is intractable as the dimension of the data increases. In [1] and in [17] , the authors estimate a Riemannian metric so that an observed set of data maximizes the likelihood of a generative model. Their approaches use simple forms for the metric. Finally, in [12] , the authors show how to use transformation of the observation space to pull-back a metric from a given space back to the observation space, and give a density criterion for the obtained metric and the data.\nWe propose in this paper a new approach to learn a smooth manifold and a Riemannian metric which are adapted to the modelling of disease progression. We describe each subject as following a straight line trajectory parallel to a reference trajectory in a low-dimensional latent space Z, which is mapped onto a submanifold of the observation space using a deep neural network \u03a8 , as seen in [15] . Using the mapping \u03a8 , the straight line trajectories are mapped onto geodesics of the manifold \u03a8 (Z) equipped with the push-forward of the Euclidean metric on Z. After inference, the neural network parametrizes a manifold which is close to the set of observations and a Riemannian metric on this manifold which is such that subjects follow geodesics on the obtained Riemannian manifold, which are all parallel to a common reference geodesic in the sense of [14] . This construction is motivated by the theorem proven in Appendix giving mild conditions under which there exists a Riemannian metric such that a family of curves are geodesics. Additionally, this particular construction of a Riemannian geometry allows very fast computations of Riemannian operations, since all of them can be done in closed form in Z.\nSection 2 describes the Riemannian structure considered, the model as well as the inference procedure. Section 3 shows the results on various features extracted from the ADNI data base [7] and illustrates the advantages of the method compared to the use of predefined simple Riemannian geometries.\n2 Propagation model and deep generative models"}, {"section_title": "Push-forward of a Riemannian metric", "text": "We explain here how to parametrize a family of Riemannian manifolds. We use deep neural networks, which we view as non-linear mappings, since they have the advantage of being flexible and computationally efficient.\nLet\nIt is shown in [15] that if the transfer functions of the neural network are smooth monotonic and the weight matrices of each layer are of full rank, then \u03a8 is differentiable and its differential is of full rank d everywhere.\nIt is only locally a submanifold: M w could have self intersections since \u03a8 w is in general not one-to-one. Note that using architectures as in [8] would ensure by construction the injectivity of \u03a8 w .\nA Riemannian metric on a smooth manifold is a smoothly varying inner product on the manifold tangent space. Let g be a metric on R d . The pushforward of g on M w is defined by, for any smooth vector fields X, Y on \u03a8 w (R d ):\nwhere (\u03a8 w ) * (X) and (\u03a8 w ) * (Y ) are the pull-back of X and\nw ) for any smooth function f : R d \u2192 R, and where \u03a8 \u22121 w is a local inverse of \u03a8 w , which exists by the local inversion theorem.\nBy definition, \u03a8 w is an isometry mapping a geodesic in (\nNote that the function \u03a8 w parametrizes both a submanifold M w of the space of observations and a metric \u03a8 * w (g) on this submanifold. In particular, there may be weights w 1 , w 2 for which the manifolds M w1 , M w2 are the same, but the metrics \u03a8 *\nIn what follows, we denote g w = \u03a8 * w (g) the push-forward of the Euclidean metric g.\nThis neither means that M w is flat for the induced metric from the Euclidean metric on R D nor that the obtained manifold is Euclidean (ruled surfaces like hyperbolic paraboloid are flat still non euclidean). A study of the variety of Riemannian manifolds obtained under this form would allow to better understand how vast or limiting this construction is."}, {"section_title": "Model for longitudinal progression", "text": "We denote here (y ij , t ij ) j=1,...,ni the observations and ages of the subject i, for i \u2208 {1, . . . , N } where N \u2208 N is the number of subjects and n i \u2208 N is the number of observation of the i-th subject. The observations lie in a D-dimensional space Y. We model each individual as following a straight trajectory in Z = R d with d \u2208 N:\nwhere (e 1 , . . . , e d ) is the canonical basis of R d . With this writing, on average, the subjects follow a trajectory in the latent space given by the direction e 1 . To account for inter-subject differences in patterns of progression, each subject follows a parallel to this direction in the direction\nFinally, we reparametrize the velocity of the subjects in the e 1 direction using \u03b7 i which encodes for the pace of progression and \u03c4 i which is a time shift. This writing is so that l i (\u03c4 i ) is in Vec(e 2 , . . . , e d ), the set of all possible states at the time \u03c4 i . Hence, after inference, all the subjects progression should be aligned with similar values at t = \u03c4 i . We denote, for each subject i,\n. \u03d5 i is a low-dimensional vector which encodes the progression of the subject.\nAs shown above, we map Z to Y using a deep neural network \u03a8 w . The subject reconstructed trajectories t \u2192 y i (t) = \u03a8 w (l i (t)) are geodesics in the submanifold (M w , g w ). The geodesics are parallel in the sense of [14] and [16] . Note that the apparently constrained form of latent space trajectories (1) is not restrictive: the family of functions parametrized by the neural network \u03a8 w allows to curve and move the image of the latent trajectories in the observation space, and for example to align the direction e 1 with any direction in Y."}, {"section_title": "Encoding the latent variables", "text": "To predict the variables \u03d5 for a given subject, we use a recurrent neural-network (RNN), which is to be thought as an encoder network. As noted in [4, 5] , the use of a recurrent network allows to work with sequences which have variable lengths. This is a significant advantage given the heterogeneity of the number of visits in medical longitudinals studies. In practice, the observations of the subject are not regularly spaced in time. To allow the network to adapt to this, we provide the ages of the visit at each update of the RNN.\nWe use an Elman network, which has a hidden state h \u2208 R H with H \u2208 N, initialized to h 0 = 0 and updated along the sequence according to h k = \u03c1 h (W h y ik + U h h k\u22121 + b h ) and the final value predicted by the network after a sequence of length f \u2208 N is \u03d5 = W \u03d5 \u03c1 \u03d5 (h f ) + b z where \u03c1 \u03d5 and \u03c1 h are activation functions and W h , U h , W \u03d5 , b h , b \u03d5 are the weights and biases of the network. We denote \u03b8 = (W h , U h , W \u03d5 , b \u03d5 ) the parameters of the encoder.\nWhen working with scalar data, we use this architecture directly. When working with images, we first use a convolutional neural network to extract relevant features from the images which are then fed to the RNN. In this case, both the convolutional network and the recurrent network are trained jointly by backpropagation. Figure 1 summarizes the whole procedure. Fig. 1 : The observed sequences are encoded into latent trajectories, which are then decoded into geodesics on a submanifold of the observation space."}, {"section_title": "Regularization", "text": "To impose some structure in the latent space Z, we impose a regularization on the individual variables\nThe regularization cost used is:\nThis regularization requires the individual variables \u03b7 and \u03c4 to be close to mean values \u03c4 , \u03b7. The parameters \u03b7, \u03c4 are estimated during the inference. \u03c3 \u03b7 > 0 is fixed but the estimation of \u03b7 allows to adjust the typical variation of \u03b7 with respect to the mean pace \u03b7, while the neural network \u03a8 w adjusts accordingly the actual velocity in the observation space in the e 1 direction. \u03c3 \u03c4 is set to the empirical standard deviation of the time distribution (t ij ) ij , meaning that we expect the delays between subjects to be of the same order as the standard deviation of the visit ages."}, {"section_title": "Cost function and inference", "text": "Overall, we optimize the cost function:\nwhere \u03c3 > 0 is a parameter controlling the trade-off reconstruction/regularity. The first term contains the requirements that the geometry (M w , g w ) be adapted to the observed progressions since it requires geodesics y i (t) to be good reconstructions of the individual trajectories. As shown in the Appendix, there exists solutions to problems of this kind: under mild conditions there exists a metric on a Riemannian manifold that the subjects progressions are geodesics. But this is only a partial constraint: there is a whole class of metrics which have geodesics in common (see [13] for the analysis of metrics which have a given family of trajectories as geodesics).\nWe infer the parameters of the model by stochastic gradient descent using the Adam optimizer [9] . After each batch of subjects B, we balance regularity and reconstruction by imposing a closed-form update on \u03c3:\nwhere N B = i\u2208B N i is the total number of observations in the batch b. This automatic update of the trade-off criterion \u03c3 is inspired from Bayesian generative models which estimate the variance of the residual noise, as in e.g. [14, 20] ."}, {"section_title": "Experimental results", "text": "The neural network architectures and the source code for these experiments is available at gitlab.icm-institute.org/maxime.louis/unsupervised_geometric_ longitudinal, tag IPMI 2019. For all experiments, the ages of the subjects are first normalized to have zero mean and unit variance. This allows the positions in the latent space to remain close to 0. We set \u03c3 \u03b7 = 0.5 and initialize \u03b7 to 0. To validate the proposed methodology, we first perform a set of experiments on a synthetic data set. We generate 64\u00d764 gray level images of a white cross on a black background. Each cross is described by the arms length and angles. We prescribe a mean scenario of progression for the arm lengths and sample the arm angles for each subject from a zero-centered normal distribution. Figure 2 shows subjects generated along this procedure. Note that with this setting, an image varies smoothly with respect to the arms lengths and angles and hence the whole set of generated images is a smooth manifold."}, {"section_title": "On a synthetic set of images", "text": "We generate 10 training sets of 150 subjects and 10 test sets of 50 subjects. The number of observation of each subject is randomly sampled from a Poisson distribution with mean 5. The times at which the subject are observed are equally spaced within a randomly selected time window. We add different level of white noise on the images. We then run the inference on the 10 training sets for each level of noise. We set the dimension of the latent space Z to 3 for all the experiments.\nFor each run, we estimate the reconstruction error on both training set and test set, as well as the reconstruction error to the de-noised images, which were not seen during training. Results are shown on Figure 3 . The model generalizes well to unseen data and successfully denoises the images, with a reconstruction error on the denoised images which does not vary with the scale of the added white noise. This means that the generated manifold of images is close to the manifold on which the original images lie. Besides, as shown on Figure 4 , the scenario of progression along the e 1 direction is well captured, while orthogonal directions e 2 , e 3 allow to change the arm positions. Finally, we compare the individual variables (b 2 i , b 3 i ) to the known arms angles which were used to generate the images. Figure 5 shows the results: the latent space is structured in a way that is faithful to the original arm angles."}, {"section_title": "On cognitive scores", "text": "We use the cognitive scores grading the subjects memory, praxis, language and concentration from the ADNI database as in [14] . Each score is renormalized to vary between 0 and 1, with large values indicating poor performances for the task. Overall, the data set consists of 223 subjects observed 6 times on average over 2.9 years. We perform a 10-fold estimation of the model. The measured mean squared reconstruction error is 0.079 \u00b1 1.1e \u2212 3 on the train sets, while it is of 0.085 \u00b1 1.5e \u2212 3 for the test sets. Both are close to the uncertainty in the estimation of these cognitive scores [18] . This illustrates the ability of the model to generalize to unseen observations. First, this indicates that M w is a submanifold which is close to all the observations. Second, it indicates how relevant the learned Riemannian metric is, since unobserved subject trajectories are very close to geodesics on the Riemannian manifold. Figure 6 shows obtained average trajectories t \u2192 \u03a8 w (e \u03b7 e 0 (t \u2212 \u03c4 )) for a 10-fold estimation of the model on the data set, with Z dimension set to 2. All of these trajectories are brought back to a common time reference frame using the estimated \u03c4 and \u03b7. All average trajectories are very similar, underlining the stability of the proposed method. Note that despite the small average observation Fig. 4 : First row is t \u2192 \u03a8 \u03b8 (e 1 t). Following rows are t \u2192 \u03a8 \u03b8 (e 1 t + e i ) for i \u2208 {2, 3}. These parallel directions of progression show the same arm length reduction with different arm positions. time of the subjects, the method proposed here allows to robustly obtain a mean scenario of progression over 30 years. Hence, despite all the flexibility that is provided through the different neural networks and the individual parameters, the model still exhibits a low variance.\nWe compare the results to the mean trajectory estimated by the model [14] , which is shown on Figure 8 . Both cases recover the expected order of onset of the different cognitive symptoms in the disease progression. Note that with our model the progression of the concentration score is much faster than the progression of the memory score, although it starts later: this type of behaviour is not allowed with the model described in [14] where the family of possible trajectories is much narrower. Indeed, because it is difficult to craft a relevant Riemannian metric for the data at hand, the authors modelled the data as lying on a product Riemannian manifold. In this case, a geodesic on the product manifold is a product of geodesics of each manifold. This strongly restricts the type of dynamics spanned by the model and hence gives it a high bias. The use of the product manifold also has an impact on the parallel variations around the mean scenario: they can only delay and slow/accelerate one of the component with respect to another, as shown on Figure 8 . Figure 7 illustrates the parallel variations \u03a8 (\u03b1e 0 (t \u2212 \u03c4 ) + e 1 ) one can observe with the proposed model. The variation is less trivial since complex interactions between each features are possible. In particular, the concentration score varies more in the early stages of the disease than in the late stages.\nThe individual variables \u03d5. To show that the individual variables \u03d5 i did capture information regarding the disease progression, we compare the distribution of the \u03c4 i between subjects who have at least one APOE4 allele of the APOE gene -an allele known to be a implicated in Alzheimer's disease-and subjects which have no APOE4 allele of this gene. We perform a Mann-Whitney test on the distributions to see if they differ. For all folds, a p-value lower than 5% is obtained. For all folds, carriers have a larger \u03c4 meaning that they have an earlier disease onset than non-carriers. This is in accordance with [2] . Similarly, women have on average an earlier disease onset for all folds, in accordance with [11] . A closer look at the geometry We look at the obtained Riemannian geometry by computing the latent position best mapped onto each of the observation by \u03a8 w . We then plot the obtained latent positions to look at the structure of the learned Riemannian manifold. We compare the obtained structure with a visualisation of the structure induced by the 2 on the space of observations produced by Isomap [19] . Isomap is a manifold learning technique which attempts to reconstruct in low dimensions the geodesic distances computed from a set of observations. The results are shown on Figure 9 . The geometry obtained after inference is clearly much more suited for disease progression modelling. Indeed, the e 1 direction does correspond to typical increases in the dif- ferent scores. The induced metric is not as adapted. This highlights the relevance of the learned geometry for disease modelling."}, {"section_title": "On anatomical MRIs", "text": "We propose here an estimation of the model on 3D MRIs preprocessed from the ADNI database, to check the behaviour of the proposed method in high dimension. We select subjects which ultimately convert to Alzheimer's disease. We obtain 325 subjects and a total of 1996 MRIs which we affinely align on the Colin-27 template and resample to 64x64x64. We run a 5-fold estimation of the model with dim Z = 10, using a GPU backend. We obtain a train mean squared error of 0.002 \u00b1 1e \u2212 5 and a test mean squared error of 0.0024 \u00b1 3e \u2212 5. Figure  10 shows one of the learned mean trajectory. Once the model is estimated, we compare the distributions of the pace of progressions \u03b7 i between the individuals who have at least one APOE4 allele of the APOE gene and the individuals who have no APOE4 allele. For all 5 folds, the distributions of the paces of progression significantly differ, with p-values lower than 5% and in each case, the APOE4 carriers have a greater pace of progression, in accordance with [2] . The same analysis between the individuals who have two APOE4 allele versus the individuals which have at maximum one APOE4 allele shows a significative difference for all folds for the \u03c4 variable: the APOE4 carriers have an earlier disease onset, as shown in [11] . This analysis further shows the value of the individual variables \u03d5 i learned for each subject."}, {"section_title": "Conclusion", "text": "We presented a way to perform Riemannian geometry learning in the context of longitudinal trajectory analysis. We showed that we could build a local Riemannian submanifold of the space of observations which is so that each subject follows a geodesic parallel to a main geodesic of progression on this manifold. We illustrated how the encoding of each subject into these trajectories is informative of the disease progression. The latent space Z built in this process is a low-dimensional description of the disease progression. There are several possible continuations of this work. First, there is the possibility to conduct the same analysis on multiple modalities of data simultaneously. Then, after estimation, the latent space Z could be useful to perform classification and prediction tasks.\nIn [13] , the authors deal with a more general case but obtain a less explicit existence result. This theorem motivates our approach even if in equation (3) we ask for more: we want the existence a system of coordinates adapted to the progression."}]