[{"section_title": "Abstract", "text": "Abstract. In this paper, a novel intermediate templates guided image registration algorithm is proposed to achieve accurate registration results with a more appropriate strategy for intermediate template selection. We first demonstrate that registration directions and paths play a key role in the intermediate template guided registration methods. In light of this, a directed graph is built based on the asymmetric distances defined on all ordered image-pairs in the dataset. The allocated directed path can be used to guide the pairwise registration by successively registering the underlying subject towards the template through all intermediate templates on the path. Moreover, for the groupwise registration, a minimum spanning arborescence (MSA) is built with both the template (the root) and the directed paths (from all images to the template) determined simultaneously. Experiments on synthetic and real datasets show that our method can achieve more accurate registration results than both the traditional pairwise registration and the undirected graph based registration methods."}, {"section_title": "Introduction", "text": "Non-rigid registration between images with large deformation is challenging due to the difficulty in establishing the precise and consistent correspondences and optimizing the highly non-linear energy function [1, 2] . Recently, several methods have been proposed to alleviate this difficulty by getting help from other images [3, 4] . For example, to warp subject S to template T in a dataset I, a set of intermediate templates (IT), , \u2026 , , can be selected to guide the registration from S to T, i.e., . The deformation between S and T is thus decomposed into a series of small ones, and the subject will travel through the path by accumulating these gentle deformations and finally arrive at the template space. Since the difference between neighboring images on the path is smaller than that between S and T, the registration from S to T along the path takes less risk of being trapped in local minima than their direct registration. Here, the registration from S to T is denoted by . It is worth noting that T is essentially an ordered set and the registration from to is also a directed process. That means only forward registrations (e.g., , , and , i = 1, \u2026, m-1) are directly related to the final result, while the registrations between other image pairs and backward registrations (e.g., ) are irrelevant. Moreover, the measures to evaluate the performance on are generally ly different from that of , and sometimes this difference is significant. Different ent selections of intermediate templates in T can also affect the registration accuracy greatly as we can see in the experiments below. Based on these observations, we introduce a new term, directionality, to describe the effect related to the registration paths and directions, which is proven to be a key factor and can facilitate the selection of more appropriate intermediate templates to better guide the registration.\nThe directionality exists in not only pairwise but also groupwise registration. For example, a graph based method is applied in [3, 4] to build a tree on the dataset, and each registration from one node to its neighbor is a directional warping procedure. To be consistent with the registration step, the directionality should also be taken into consideration in the tree-building step, e.g., constructing a directed graph with different weights assigned to the edges from S to T and from T to S. However, the metrics defined in [3, 4] are symmetric by averaging two directional registration results for building an undirected graph. Such non-negligible inconsistency may undermine the accuracy and robustness of the final registration results, since the directed registration step requires a corresponding directional-intermediate-templates-selection step during path formulation. Some previous works studied the effect of the order of moving subject and fixed template in the pairwise registration, e.g., the consistent image registration [1] that estimates an inverse consistent deformation field, the symmetric diffeomorphic registration [5] that warps two images towards an implicit space inbetween and the asymmetric image-template registration [6] that introduces a correction factor to the symmetric cost function. However, the directionality on image population has not been fully studied in the literature to our best knowledge.\nIn this paper, a novel directed graph based image registration method is proposed. First, we define an asymmetric similarity measure on ordered image pairs and construct a fully connected directed graph. To learn the local data structure, a directed kNN graph is then extracted and the optimal paths from one image to another are allocated. The pairwise registration can be done by registering the subject to the template along the allocated path. For the groupwise registration on an image population, the minimum spanning arborescence (MSA) [7] is built with the root node (template) determined automatically. Experimental results on synthetic dataset and real brain MR image datasets demonstrate that the proposed algorithm can achieve more consistent and robust registration results than other widely applied methods."}, {"section_title": "Method", "text": "In this section, the proposed directed graph based registration framework is detailed. We first explore the directionality in image registration and then apply it in both ITguided pairwise and groupwise registrations."}, {"section_title": "The Importance of Directionality in Registration", "text": "To register two images S and T together, either of them can serve as the fixed template and the other one as the moving subject. However, due to the non-existence of a To further quantitatively analyze this difference, we first define a directed distance on the ordered image pair , based on the result of . The optimal deformation field is obtained by maximizing the similarity between and the warped warped image . Two directed measures are defined on : the intensity difference, , , and the smoothness of the deformation field: , where \u03a6 is the image domain and is the Laplacian operator. The final directed difference can be calculated as a weighted average with 0, 1 , i.e.,\nThe two measurements are normalized into the same range before being used in Eq. 1. The directed difference defines an asymmetric measurement between two images, and it is different from a true metric which has to be symmetric. To quantitatively measure the directionality of a directed metric, we define the relative difference between two directed measurements as the directionality significance. For the measurement as defined above, its directionality significance sig d on the image pair , ,\nWe can also define in a similar way. For illustration, the directionality significances and are calculated for all image pairs in a dataset of 18 elderly brains brains with large shape difference. The distribution of the directionality significance is shown in Fig. 1 . We can see that the relative difference between the measurement on the forward and backward registration results can be up to 20% and 50% on and , respectively, implying that the ignorance of the directionality in image registration may lead to a sub-optimal solution."}, {"section_title": "Directed Graph Based Pairwise Registration", "text": "Given two subjects and in an image set | 1, 2, \u2026 , , 1 , , the goal of IT-guided pairwise registration is to warp to with the help of a selected subset of images in . After assigning the directed dissimilarity to each ordered image pair ( , ), we can build a directed graph by considering each subject as a node and weighting each directed edge with , as defined in Eq.1. To further learn the underlying structure, we construct a directed kNN graph and then approximate the directed distance on the image space by the shortest directed path from to on the kNN graph. The construction of directed kNN graph is similar to that of undirected kNN graph. The difference is that, in the directed kNN graph, two types of nearest neighbors are considered: 1) for each , we first sort all , 1 by , , then the nearest neighbors with the shortest distances are selected as k-out-NN (the edge direction is from to ); 2) another set of k-in-NN (from to ) is also selected. For each , only those directed edges from k-in-NN to the subject and those from the subject to k-out-NN are kept in the directed kNN graph. Next, we adopt the Floyd-Warshall algorithm to find the shortest paths between any ordered image pair on the directed kNN graph. For a given image pair , , the the registration can be implemented by following the determined directed registration path on the image space. It should be noted that the shortest directed path from to may be different from that in opposite direction, due to the characteristics of the directionality. For example, with an 18-elderly-brain dataset, we have detected totally 153 pairs of directed paths. Among them, only 40 pairs (26.1%) share exactly the same intermediate templates with each other, and all others (113 pairs, 73.9%) have different sets of intermediate templates to guide the respective directed registration. This shows the existence of the directionality in the pairwise registration problem of real images. Such an example on the elderly brain image set is given in Fig. 2 , which shows the different directed registration paths allocated between two images."}, {"section_title": "MSA Based Groupwise Registration", "text": "To solve the groupwise registration in a population, both the final template and the intermediate templates for each subject need to be determined. With the assigned asymmetric weights on the directed edges, the MST algorithm is no longer applicable since it is only defined on the undirected graph. Instead, we propose to build an MSA on the dataset. Note that in other tree-based groupwise registrations, the global template selection and respective registration paths allocation are two separate steps based on different criteria by focusing on either the importance of the final template representativeness or the overall registration error. We build MSA to solve the combinative optimization problem by simultaneously determining the best template and the optimal path to the template for each subject.\nIn graph theory, the MSA algorithm is first proposed by Zhu and Liu [7] to minimize the total length of the directed edges from all nodes to the root. The original MSA method can only construct a tree with a pre-specified root with complexity. However, if the template is predefined to guide the path allocation, we can only obtain a sub-optimal solution. To pursuit the global optimal solution of MSA, we have to set each of the subjects as the potential root and build N trees totally, and then choose the tree giving the shortest total path length as the final solution. Thus, the computational complexity increases to . Here, we take another strategy to find the global optimal solution in one run by adding a virtual node, which is designated as the fixed root in the extended graph. N extra directed edges from all existing N nodes to the virtual node are added with the same weight, which is assigned to be larger than the summation of all edge lengths in the original graph. An MSA is built on the extended graph with a fixed root (the virtual node). Then, the global optimal MSA on the original graph can be extracted by removing the virtual node from the extended tree. The reason to account for the mathematical equivalence between these two methods is that all directed edges connecting the virtual node have the same weight, and there is one and only one such edge can be selected in the extended tree due to the minimum total length requirement (see the supplementary file). The computational complexity of this new solution is 1 , i.e., at the same level as in the case of building MSA with a predefined root node."}, {"section_title": "Discussion", "text": "The proposed directed graph based registration has two major advantages compared with other methods. First, the IT selection step and the registration step are inherently consistent by considering the directionality. Second, the template in groupwise registration is determined together with the registration paths, which means our method can take both the final template's representativeness and the overall registration error into consideration within a single framework. Note that the computational complexity of the proposed algorithm is same as other tree-based algorithms. We need times of fast registrations for the graph construction and times of elaborated registrations for the final registration by sequentially compositing the deformation fields at each node along the path. In our experiments, the directed kNN graph built on the results of the elaborated registration is quite similar to that based on the fast registration, but the computing time is about 3~4 times longer."}, {"section_title": "Experiments", "text": "To demonstrate the advantage of the proposed directed graph based registration method, we evaluate it on both synthetic dataset and real brain MR images together with two highly related methods, i.e., the undirected graph based registration [3, 4] and the traditional pairwise registration, and two widely used groupwise registration methods, i.e., the group mean method [8] and the congealing method [9] . Throughout this paper, the diffeomorphic demons [2] is used as the basic pairwise registration tool. "}, {"section_title": "Synthetic Dataset", "text": "We first test on a synthetic samples shown in Fig. 3a . wise registration to evaluat ences. As shown in Fig. 3 different registration paths. by the traditional pairwise r provide much better results satisfactory in some cases w in this experiment clearly s base method can find more\nThe influence of the dir tration. The root in MST o shortest total length to all o 0.5 in Eq. 1. Each original Fig. 3b , and we can see that the population center than are also projected onto the be seen that the registration around the geometric center (b) a synthetic dataset by different methods to a pre-defined temp he data distribution on the 2D PCA space is illustrated in (b).\ner groupwise registration by the undirected (a) and directed wn together with their respective template. The quantitative c overlap rate, and entropy are also provided in (c).\nc dataset with 56 2D shapes simulating gyri and sulci w The top-left image is pre-selected as the template in p te the performance on registering images with large dif 3a, the registration results vary dramatically by follow . Several images even fail to be registered to the temp registration. On the contrary, the IT-guided registration s, although the undirected graph based method are not v when the shape difference is considerably large. The res show that even both with the guidance, the directed gr suitable paths than its undirected counterpart. rectionality is also validated in IT-guided groupwise re on the undirected graph is selected to be the node with other nodes. Here we choose the same weighting factor image is projected onto a 2D PCA space as illustrated t the root template of MSA is selected to be much close that of MST. The registered images of different meth same 2D space to visualize the registration results. It n results of directed graph based method are much den r of the underlying space. The mean aligned images by two methods are shown together with the respective template in Fig. 4a and 4b . The undirected method fails to register some images precisely thus giving a mean image with a much larger shaded area in the center (as indicated by the arrow). The proposed method can achieve more consistent registration. We also provide the quantitative comparisons in Fig.4c on the mean/max of all the pairwise distances among registered images ( ), the average overlap rate on the common space measured by Jaccard coefficient, and the average entropy on the region within the red circle in Fig. 4a and 4b . We can see that the proposed method consistently outperforms the undirected graph based method. The paired t-test on the pairwise distances between registered images also shows that the directed graph based method can generate a much more compact registered image set (with p < 10 -3 )."}, {"section_title": "Real Brain MR Image Datasets", "text": "We apply the proposed algorithm on ADNI dataset to further test its performance on a large dataset with real images. 60 brain MR images are selected with 20 from each category of normal control, MCI and AD. To show the influence of weighting factor in Eq. 1, both directed and undirected graph based methods are tested with = 0.0, 0.25, 0.5, 0.75 and 1.0, respectively. From Fig. 5 , we can see that the registration accuracy measured by the average overlap rate and entropy on all registered tissuesegmented images by the proposed method is consistently better than the undirected graph based method. Since both methods select the same template with = 0.5, we can fairly compare these two methods in this case. The quantitative comparison on tissue overlap rate and average entropy clearly shows the advantage of the proposed method in determining the registration paths. Our method gives 62.5% on the average tissue overlap rate, which is much higher than 60.5% given by the undirected graph based registration and 57.5% by the traditional pairwise registration to the same template. This result is also significantly higher than results of the group mean method [8] (58.7%) and the congealing method [9] (47.2%). We also measure the overlap rates on different tissues, GM, WM and CSF, on ADNI dataset in Table 1 , and our method achieved the top result on all three tissues. We also apply the proposed algorithm on LONI LPBA40 dataset including 40 brain images with 54 labeled ROIs. We set \u03b1 = 0.5 in Eq. 1 for all tests. Our method can increase the mean overlap rate on the aligned images to 68.2%, higher than the MST based method (66.3%). Moreover, our method is better for most ROIs (48 out of all 54 ROIs), and the paired t-test shows that it can achieve consistently better alignment than undirected graph based method (with p < 0.001). To fairly compare the performance of different registration methods, we use the same template to all three methods, i.e., the traditional pairwise registration, the undirected graph based registration, and the directed graph based registration. Specifically, the template determined by MSA is used as the common template, and the average overlap rate given by the direct pairwise registration and the undirected graph based method is 64.8% and 66.7%, respectively. Our method can still achieve the best result (68.2%) as listed in Table 2 . One possible reason is that, for the same template, MSA can find better registration paths than the undirected MST based solutions with the directionality being considered. We can also make comparison between the results by undirected graph based registration using different templates, to demonstrate the importance of selecting an appropriate template in registration. Even with the same undirected graph based tree building algorithm, the performance of the registration with the template selected by MSA is slightly better than that of the registration with the template selected by MST. This also implies the better representativeness of the template selected by the directed graph based method. "}, {"section_title": "Conclusion", "text": "A new image registration framework is proposed by taking advantages of the directionality in image registration. The pairwise registration is guided along the shortest path on the directed graph, and the groupwise registration is achieved by building an MSA with the automatically selected template. The proposed algorithm can determine more appropriate intermediate templates to facilitate more accurate registration. Our future work includes applying our method to the general groupwise registration of large clinical dataset for detecting disease related brain abnormalities."}]