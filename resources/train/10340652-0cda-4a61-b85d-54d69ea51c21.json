[{"section_title": "Abstract", "text": "We introduce SparseVM, a method that registers clinical-quality 3D MR scans both faster and more accurately than previously possible. Deformable alignment, or registration, of clinical scans is a fundamental task for many clinical neuroscience studies. However, most registration algorithms are designed for high-resolution researchquality scans. In contrast to research-quality scans, clinical scans are often sparse, missing up to 86% of the slices available in researchquality scans. Existing methods for registering these sparse images are either inaccurate or extremely slow. We present a learning-based registration method, SparseVM, that is more accurate and orders of magnitude faster than the most accurate clinical registration methods. To our knowledge, it is the first method to use deep learning specifically tailored to registering clinical images. We demonstrate our method on a clinically-acquired MRI dataset of stroke patients and on a simulated sparse MRI dataset. Our code is available as part of the VoxelMorph package at"}, {"section_title": "INTRODUCTION", "text": "For clinical neuroscience studies, accurate registration of clinical images is an important step in analysis [31] . Unfortunately, existing registration algorithms are either too slow to be feasible for large population studies [4, 13] or are not sufficiently accurate on clinical images.\nDeformable medical image registration provides a dense, nonlinear correspondence between a pair of medical scans. This correspondence, sometimes referred to as a flow field, can be used to warp one image to align with another image. Importantly the fields Permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page. Copyrights for components of this work owned by others than the author(s) must be honored. Abstracting with credit is permitted. To copy otherwise, or republish, to post on servers or to redistribute to lists, requires prior specific permission and/or a fee. Request permissions from permissions@acm.org. ACM CHIL '20, April 2-4, 2020, Toronto, ON, Canada themselves are used in clinical studies to understand anatomical differences between scans. Existing registration methods usually work well on high-resolution research-quality scans. However, scans acquired in clinical settings can be problematic for these methods. Clinical settings often require limited scanning time because of patient safety and financial constraints. For 3D imaging modalities such as structural MRI, this often means only a few 2D slices are acquired instead of a dense set of slices, leading to spatially sparse scans. Each 2D slice has high in-plane resolution (Fig. 1, left) , but the 3D volume can be missing up to 86% of the slices that are typically available in a full resolution scan ( Fig. 1, right) . While slice thickness tends to be higher in these scans as well, the often much higher slice separation is the predominant issue. The wide spacing between slices causes drastic discontinuities in anatomy between neighboring slices, and these discontinuities lead to a reduction in the registration accuracy.\nIn this paper, we present a new learning-based registration method, SparseVM, that adapts the recent VoxelMorph method [7, 8, 12] to clinical images. To our knowledge, this is the first use of deep learning based strategies specifically designed for registering sparse clinical images. We evaluate SparseVM on a neuroimaging study of stroke patients containing T2-FLAIR MR brain scans [31] and on a T1 MR brain dataset from the ADNI dataset [27] with simulated sparsity.\nThrough qualitative and quantitative analysis, we show that SparseVM provides significant improvements in both speed and accuracy over the current state-of-the-art methods. Specifically, SparseVM is 1) more accurate and 1000\u00d7 faster than the best classical registration methods [4, 13] while also having a higher accuracy, and 2) more accurate than current best learning-based methods [7] ."}, {"section_title": "RELATED WORK", "text": "Most classical registration methods are high-dimensional optimization algorithms designed for full-resolution scans rather than sparse clinical scans. Methods include elastic-type models [6, 15, 33] , statistical parametric mapping [3] , free-form deformations with b-splines [32] , discrete methods [20] , and Demons [28, 36] . Diffeomorphic transforms explicitly enforce topology constraints [2, 5, 9, 26, 37] . Applying these methods to clinical scans is problematic because they were developed to work on high resolution scans and require spatial continuity for smooth image gradients, which are not available in clinical scans. Additionally, these methods are extremely slow because they require solving an iterative optimization problem for each new pair of images.\nMore recently, patch-based registration (PBR) [13] builds on previous discrete registration methods [20] and adapts them to sparse data by using sparse 3-dimensional patches to measure image intensity similarities. PBR incorporates a mask that weights voxel contributions to the loss function in proportion to confidence in those voxels. This differentiates interpolated voxels from the voxels acquired from actual slices. PBR is a flexible, accurate method for registering clinical images, but it employs a pairwise optimization strategy, requiring on the order of two CPU hours to register a pair of images. This means that using it to register a large database of clinical images is very time-consuming.\nRecently developed learning-based methods can register dense scans significantly faster than optimization-based registration methods. They use neural networks to learn a function that takes in two scans as input and outputs a deformation field. Many are supervised, requiring ground truth warp fields during training [10, 29, 34, 38] . Unsupervised methods [16, 18, 24, 25] have been shown to work well on research quality, high resolution scans. VoxelMorph (VM) [7, 8, 12] , a recent unsupervised learning-based method, achieves state-of-the-art accuracy on 3D isotropic scans and is fast at test time. However, on clinical images, VoxelMorph does not achieve the same accuracy as PBR, as we illustrate in our experiments.\nIn this paper, we present a method that combines the fast runtimes of learning-based methods with insights derived from classical methods for sparse data, to achieve both high performance and state-of-the-art accuracy. Specifically, we design a new loss function, Sparse Local Cross Correlation (SLCC), for deep learning based registration that weights acquired voxels differently from interpolated voxels, and we analyze the hyper-parameters for this function. We demonstrate that this achieves the fast runtimes of learning-based methods and exceeds the accuracy of both classical and learning-based methods."}, {"section_title": "METHOD", "text": "We build on the learning-based method VoxelMorph to register clinical scans. VoxelMorph uses a convolutional neural network to learn a function, ( , ) = , where are network parameters, that computes a deformation field for a pair of scans { , }. At test time, VoxelMorph evaluates this function on two input scans and outputs the deformation field , as well as the registered image,\n\u2022 ( warped by ). The essential difference between our method and VoxelMorph is that we introduce and incorporate a novel loss function, sparse local cross correlation (SLCC), designed to compensate for the sparseness in the image. SLCC, described in detail below, uses two masks and weights the contributions of each input 3D image in proportion to values in the respective masks. This loss function can therefore be used in any application where sparsity (binary values) or confidence in observations (continuous values) can be defined via masks."}, {"section_title": "Loss Functions", "text": "In this section, we first describe the loss function used in Voxel-Morph. Let f, m be two volumes defined over a 3D spatial domain \u03a9 \u2282 R 3 . We assume f and m contain grayscale data and are affinely aligned (we do this using one of the publicly available affine alignment packages [19] ) as a preprocessing step, so that the scan pairs exhibit only non-rigid misalignments.\nImage registration methods optimize a loss function of the form:\nwhere is a regularization hyperparameter. This loss function balances an image matching term with a regularization or spatial smoothness term \u210e . The first term measures the similarity in appearance between the fixed image and the warped moving image \u2022 . The second term encourages the displacement field to be smooth and anatomically realistic. This loss is used in classical methods to optimize each deformation independently and in unsupervised learning-based methods to learn the global network parameter .\nThe \u210e term encourages neighboring voxels to move together. Without this loss, the optimization can lead to an anatomically meaningless deformation field that moves voxels from arbitrary locations to match the intensities of the fixed image. Specifically, the \u210e term penalizes the local spatial gradients of , \u25bd , where is the vector displacement such that = + and is the identity transform:\nwhere the notation ( ) indicates the value of at voxel location .\nIntensity mean-squared error (MSE) and cross correlation (CC) are the most commonly used similarity measures, . MSE compares intensities at each voxel:\nThis measure works well when the dataset contains images with similar intensity distributions without intensity anomalies or excessive noise.\nLocal normalized cross correlation has been shown to be more invariant than MSE to small differences in intensity distributions and noise across scans [5] . For a scan , let ( ) be the local neighborhood intensity mean around voxel : ( ) = 1 3 ( ), where 3 is the neighborhood size and iterates over the 3 volume of voxels surrounding voxel p. Let the local mean subtracted from a voxel in its neighborhood be defined as:\u00af( , ) = ( ) \u2212 ( ) and similarly\u00af( , ) = [ \u2022 ] ( ) \u2212 \u2022 ( ). The local normalized cross correlation is then:"}, {"section_title": "Sparse Method", "text": "We introduce two new image similarity losses that generalize Eq.\n(3) and Eq. (4) and lead to accurate registration on both clinical and high resolution scans. We start by up-sampling each clinical image to isotropic spatial resolution (equal resolution in all planes) by linearly interpolating between the acquired slices ( Fig. 1, right) . We define masks, and , corresponding to the fixed image and the moving image , respectively. In its simplest form, each voxel in a mask has a value of 0 (interpolated voxel) or 1 (acquired voxel). We explain other forms in the experiments section. We let = * be a combined mask that indicates voxels that are observed in both scans, where * denotes element-wise multiplication. Similar masks were first used in [13] to define patch-wise squared error similarities.\nSparse mean squared error (SMSE) generalizes Eq. (3) by computing the loss over only observed voxels:\nTo define a sparse version of local normalized cross correlation, we first consider the sparsity of each local neighborhood of voxels. For each image, we compute the local mean of each neighborhood over only the observed voxels, and then subtract the local mean from each pixel in the neighborhood:\nwith similar definitions for \u2022 . Finally we define the sparse local cross correlation as:\nSLCC computes the local correlation in each neighborhood between voxels that are observed in both scans. Since SLCC does not use values over unobserved (interpolated) voxels, the neighborhoods contain sparse observations. As in regular local normalized cross correlation, the neighborhood size 3 is an important hyperparameter. In SLCC, special care must be taken to ensure the neighborhoods are large enough to contain enough non-zero voxels, but small enough to capture statistics of specific regions of the scans.\nIn our experiments, we provide an analysis of this hyperparameter.\nThe smoothness constraint on the deformation field Eq. (2) remains the same regardless of whether the data is sparse or not, since we still want to regularize the underlying deformation field to be smooth and anatomically realistic at all voxel locations."}, {"section_title": "EXPERIMENTS", "text": "In our experiments, we focus on atlas-based registration, registering an atlas, or reference scan, to each subject scan. This is often done in population studies, where inter-subject registration is a core problem. We demonstrate our method on a clinically acquired MRI dataset for stroke patients [31] and on a simulated sparse dataset derived from the ADNI dataset [27] . We use full-resolution atlases computed for each modality [35] ."}, {"section_title": "Datasets", "text": "The clinically-acquired dataset contains T2-FLAIR MR scans acquired within 48 hours of stroke onset. The in-plane resolution is 0.85mm with varying slice thicknesses and the spacing between slices ranges from 5-7mm. The dataset contains manual segmentations of the ventricles for 104 of the subjects. The 237 subjects without manual segmentations were used for unsupervised registration training, while the 104 subjects with manual segmentations were split into validation (29 subjects) and held out test (75 subjects) sets.\nThe second dataset contains isotropic 1mm T1-weighted brain scans from the publicly available Alzheimer's Disease Neuroimaging Initiative (ADNI) dataset [27] . This dataset has the advantages of having segmentations of 30 different structures in the brain obtained using FreeSurfer [19] . We use this dataset to create simulated clinical scans as follows:\n(1) Simulating the variance in head positioning during acquisition by applying small, random affine changes to the isotropic image before creating sparse data. (2) Deleting 6 out of every 7 axial slices. The resulting images contain approximately 14% of the acquired voxels in the isotropic image. The number of slices deleted was chosen to emulate the wide spacing in the clinically acquired stroke dataset. (3) Simulating motion blur by combining, in the frequency domain, a simulated sparse image with a slightly shifted version of itself. These steps attempt to realistically mimic challenges that occur during clinical image acquisition. This enables more detailed analyses on a variety of anatomical regions than is possible with the clinical dataset. These images were affinely registered to a T1weighted atlas.\nDuring pre-processing the scans for both datasets were intensity normalized, affinely-aligned, and skull-stripped using existing toolboxes [4, 21, 35] ."}, {"section_title": "Masks", "text": "The atlas in each atlas-based registration experiment is isotropic, and therefore consists of the value 1 at each voxel. The clinical (or simulated clinical) images have approximately 14% of the number of acquired slices of an isotropic research scan. We linearly interpolate the remaining slices to achieve the same resolution as the atlas. The subject mask ( ) is set to 1 for voxels in the acquired slices and zero for voxels in the interpolated slices. While performing affine alignment, both and are resampled, and voxels are therefore linearly interpolated. The masks are also linearly interpolated, which means the final mask values in are continuous in the range [0, 1]. We interpret these values as weightings of confidence in the values of the voxels."}, {"section_title": "Baseline Methods", "text": "For the clinically-acquired stroke dataset, we compare our method to VoxelMorph (VM) [7] , Patch Based Registration (PBR) [13] , and the widely used Advanced Normalization Tools software package (ANTs) [4] .\nFor VM and PBR, we used the optimal parameters given in the original publications, except for the cross correlation neighborhood size. In the original VoxelMorph paper, a cross correlation neighborhood size of 9 3 is used. However, from our experiments we found a larger neighborhood size of 15 3 leads to better performance for clinical images, so we report results with a neighborhood size of 15 3 . This is likely because of the sparsity of the neighborhoods in clinical data. ANTs is used as a baseline in the original VoxelMorph and PBR papers. For ANTs, we use the cross correlation loss, and parameters optimized for Dice score: (SyN step size of 0.25 and Gaussian parameters (9,0.2) at three scales with a maximum of 201 iterations per scale)."}, {"section_title": "Evaluation Metric", "text": "We use the output deformation field to warp segmentation maps of the atlas to the subject and compare to the ground truth subject segmentations using the Dice score [17] . We compute the Dice score for acquired slices in the clinical scan. For the other two outliers, SparseVM is much worse than VM. Upon visual inspection, we find that these two scans were incorrectly skull-stripped with a significant part of the brain removed. . The Dice score measures the volume overlap of anatomical segmentations and ranges between 0 and 1, with 0 representing no overlap and 1 representing perfect overlap. However, when segmentations are manually annotated by humans, there can be considerable inter-rater variability. This often leads to lower Dice scores even for segmentation tasks. Furthermore, state-of-the-art registration studies on high-quality, high-resolution MRI modalities have reported at most a ventricle average Dice score of 0.9 [7, 23] ."}, {"section_title": "Implementation", "text": "We implemented SparseVM using Keras [11] with a TensorFlow backend [1] . We used the ADAM optimizer [22] with an value of 5 \u00d7 10 \u22125 and a learning rate of 5 \u00d7 10 \u22124 . We used a modified version of the U-Net-like [30] architecture proposed in the original Voxel-Morph paper [7] , which is publicly available online. The outputs of this model are a flow field and the corresponding warped moving image. We modified the inputs to this architecture to include the masks for the two input images. We implement SLCC efficiently using sparse convolutional layers [14] . Our code is available as part of the VoxelMorph package at http://voxelmorph.mit.edu/."}, {"section_title": "Experiment Setup", "text": "Since our primary aim is to achieve fast runtimes and high accuracy on clinical data, we first evaluate SparseVM and all baselines on the stroke MRI images. We also evaluate SparseVM and VoxelMorph on the simulated data enables us to analyze whether our loss function generalizes to anatomical structures other than the ventricles. We also use this data to do a direct comparison of the performance of our sparse version of cross correlation against the usual version of cross correlation. By analyzing the performance of these two learning-based methods, we provide insight into the relative performance of the sparse versions to their isotropic counterparts.\nFor the smoothness regularization hyperparameter , we used the value = 1 used in the original VoxelMorph papers to guide a parameter search. We then used the validation set to choose an optimal value, which was = 1.5. We also did a search over the neighborhood size hyperparameter for SLCC. We provide an analysis below for this value, and report results for SLCC with a neighborhood size =15, which we found to perform well given the sparsity in our data. Table 1 summarizes the average and median Dice scores for all test subjects on the ventricles, and the average test runtimes of each method. SparseVM has 1) the highest average and median Dice scores and 2) runtimes on par with VoxelMorph."}, {"section_title": "RESULTS", "text": ""}, {"section_title": "Clinically-acquired Dataset", "text": "Both ANTs and PBR take on the order of two hours on a CPU, while VoxelMorph and SparseVM take less than 10 seconds on a single-threaded CPU and less than half a second on a GPU. To our knowledge, there are no GPU implementations of ANTs or PBR.\nSince the registration results across subjects exhibit high variance, as shown by the standard deviations, we show the Dice score for each subject in Figure 3 . SparseVM using SLCC outperforms the much slower ANTs on 86.7% of test subjects and the much slower PBR on 69.3% of test subjects. It has higher accuracy than VoxelMorph on 90.7% of test subjects. We show two example of subject registration results in Figure 2 . This figure shows a warped atlas segmentation overlaid on a test subject scan for each method. We highlight that these overlaid images are useful for qualitatively showing the accuracy of the resulting flow fields, but the flow fields themselves are the clinically important output. The close-up view in Figure 2 shows that the warped segmentation from our method snaps to edges well. This means that the flow fields produced by our method are accurate near anatomical boundaries.\nWe find that SparseVM using SLCC tends to perform worse than PBR on subjects for which skull-stripping or affine alignment fails during pre-processing. Figure 5 shows an example of a test subject that has not been properly skull stripped. Since the atlas does not have a skull and most training subjects are properly skull-stripped, the learning-based methods don't generalize well to outlier subjects that fail skull stripping. The brain anatomy is pulled towards the skull, which suggests the learned models do not properly distinguish the brain from the skull. The stroke dataset was compiled as part of a study investigating white matter hyperintensity (WMH) in stroke patients [31] . WMH is a pathology, visible on T2 FLAIR scans, that impacts cerebrovascular health. The algorithm used to register images in the population study reported on in [31] used flow fields generated by ANTs, a method that we show is much slower and less accurate than ours. Since differences in intensities caused by WMH add to the difficulty of clinical registration, we visually investigate the registration performance of SparseVM near regions of significant WMH. Figure 6 shows registration results for test subjects, illustrating the intensity heterogeneity present in these patients. We observe that SparseVM provides registration that enables the ventricle segmentations to snap well to the anatomical boundaries even when there is high WMH. Consistent with our quantitative results, the close-up regions show that warped atlas segmentations using PBR, VM, and SparseVM outperform the popular toolbox ANTS, with SparseVM (SLCC) performing optimally among these methods. Since Spar-seVM is both fast and produces more accurate flow fields, its use in clinical studies, such as this one, can reduce errors in propagation of WMH maps and reduce the labor and computational resources needed.\nWe perform additional analyses on learning-based registration methods to compare the sparse and non-sparse loss functions. Spar-seVM on average has a Dice score that is approximately 0.02 higher than VoxelMorph's Dice score. The pairwise improvement in accuracy of SparseVM is statistically significant with a p-value of 1.60 \u00d7 10 \u221214 using a paired t-test. To highlight the magnitude and consistency of this result, Figure 4 shows the Dice score difference as SparseVM Dice score -VM Dice score Dice Max -VM Dice score . We use Dice max = 0.9 based on ventricle Dice scores from recent state-of-the-art registration results on isotropic scans [7, 23] . Since 0.9 is the highest reported Dice, we calculate how much closer SparseVM is able to get to that maximum, in terms of registration Dice, than VoxelMorph.\nWe also experiment with different neighborhood sizes for SLCC. Figure 7 shows that choosing the appropriate neighborhood size has an important impact on Dice-score performance. While a neighborhood size of 9 3 is often used as a good default for isotropic 1mm images, a larger neighborhood size clearly improves performance for clinical image registration for sparse images. Table 2 shows the average and median Dice scores for both Vox-elMorph and SparseVM with the cross correlation loss function. SparseVM outperforms VoxelMorph in both mean and median Dice scores. While the statistics for the stroke dataset shown in Table 1 were computed over the ventricle structures, the statistics for the simulated ADNI dataset were computed over 30 different anatomical structures as defined in the FreeSurfer protocol. In both cases, the sparse cross correlation function outperforms the standard cross correlation function. The average Dice score for the simulated ADNI dataset is lower than that found in the stroke dataset. We hypothesize this is because the simulated dataset averages the Dice score over several smaller anatomical structures in addition to the ventricles. Small mistakes on the boundaries for small structures can drastically decrease the Dice score."}, {"section_title": "Simulated Sparse Dataset", "text": "Since the variance is high between subjects, we also show the Dice score per subject in Figure 8 . SparseVM performs better than VoxelMorph on 81% of test subjects and on average has a 0.011 higher Dice score. The improvement is statistically significant when using a paired t-test (p-value is 2.34\u00d710 \u221212 ). Figure 8 also shows the percentage of possible improvement, based on the highest reported Dice score, over VoxelMorph that SparseVM achieves. We show this in order to give intuition about the difference in Dice score and the Dice score range. Figure 8 follows a trend similar to Figure 4 for the stroke data. Figure 9 shows a boxplot of the average Dice score per label for SparseVM and VoxelMorph. SparseVM has a higher average for 15 of the 17 structures. Eleven of these improvements are statistically significant with p-values < 2 \u00d7 10 \u22126 with a paired t test and three of these improvements are statistically significant with p-values < 0.02. VoxelMorph performs better on two of the smallest structures: the amgydala (statistically significant with p-value 5.95 \u00d7 10 \u221210 ) and caudate."}, {"section_title": "CONCLUSION", "text": "We introduced SparseVM, the first method to use neural networks to register sparse, low-resolution clinical scans. SparseVM is over 1000\u00d7 faster than classical methods that achieve similar accuracy for clinical image registration. On clinical images, SparseVM requires about the same runtime as the best learning-based method for registering scans, while also providing a statistically significant improvement in accuracy. SparseVM can accurately register pairs of clinical scans in under a second on the GPU, thus enabling clinical image analyses that were not previously feasible. Figure 9 : Boxplot of Dice scores for anatomical structures. The x-axis is sorted in increasing order of anatomical structure size. For easier visualization, the left and right side of each anatomical structure (e.g. the left and right lateral ventricles) were averaged together into one boxplot. SparseVM has a higher average for 15 out of the 17 anatomical structures. Fourteen of these differences are statistically significant with a paired t test. The Dice score of the choroid plexus is much lower than all other structures for both methods, and is left out of the boxplot to better visualize the other structures. The average Dice score on this structure was 0.236 for SparseVM and 0.231 for VoxelMorph."}]