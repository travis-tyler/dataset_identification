[{"section_title": "Abstract", "text": "Non-linear registration is a key instrument for computational anatomy to study the morphology of organs and tissues. However, in order to be an effective instrument for the clinical practice, registration algorithms must be computationally efficient, accurate and most importantly robust to the multiple biases affecting medical images. In this work we propose a fast and robust registration framework based on the log-Demons diffeomorphic registration algorithm. The transformation is parameterized by stationary velocity fields (SVFs), and the similarity metric implements a symmetric local correlation coefficient (LCC). Moreover, we show how the SVF setting provides a stable and consistent numerical scheme for the computation of the Jacobian determinant and the flux of the deformation across the boundaries of a given region. Thus, it provides a robust evaluation of spatial changes. We tested the LCC-Demons in the inter-subject registration setting, by comparing with state-of-the-art registration algorithms on public available datasets, and in the intra-subject longitudinal registration problem, for the statistically powered measurements of the longitudinal atrophy in Alzheimer's disease. Experimental results show that LCC-Demons is a generic, flexible, efficient and robust algorithm for the accurate non-linear registration of images, which can find several applications in the field of medical imaging. Without any additional optimization, it solves equally well intra & inter-subject registration problems, and compares favorably to state-of-the-art methods."}, {"section_title": "Introduction", "text": "In the recent past, computational anatomy acquired an increasing weight in the analysis of medical data and several methods have been developed to study organs in the cross-sectional and longitudinal settings. The cross-sectional approach evaluates the geometrical differences between subjects and highlights the morphological differences between clinical groups. The longitudinal perspective evaluates the changes in time from serial data of the same subject acting as his own control, and is more useful in detecting the subtle changes related to biological processes.\nThe key instrument of computational anatomy is non-linear registration, which allows to retrieve morphological differences as deformation fields. A great variety of registration techniques have been proposed in medical imaging, depending on the practical application and the theoretical requirements."}, {"section_title": "Non-linear registration in medical imaging: technical and clinical requirements", "text": "Assessing the performance of non-linear registration methods is a quite controversial issue, since there is not a univocal way to define registration accuracy and reliability. We can however define a general set of good properties that a registration method should satisfy for the successful use in research and clinic. For this purpose we identify two main applications of non-linear registration: analysis of correspondences and analysis of deformations.\nThe former application concerns the comparison of anatomical regions between different subjects. In this case the registration algorithm should provide a good alignment of homologous anatomical structures. This requirement is classically tested in the inter-subject registration setting, by providing overlap and similarity measures with respect to ground truth data, given for example by manual segmentation of selected anatomical regions.\nThe second application concerns the analysis and quantification of anatomical changes by studying the estimated deformations. A classical example of such an application is the Tensor Based Morphometry (TBM) (Riddle et al., 2004) based on the analysis of the Jacobian determinant of the deformations. In this case, rather than looking for a perfect alignment of anatomical regions, we are interested in working with smooth and plausible deformations. In fact, even though a good intensity matching of images can be obtained with very spiky and unregular deformations, they can hardly be used for reliable statistical comparisons and quantifications. For instance the statistical power in TBM studies largely depends on the smoothness of the Jacobian determinant maps associated to the deformations. On the same line, we are interested in the plausibility of the registration in the clinical context. When applied to the longitudinal setting, a reliable non-linear registration framework should provide meaningful and robust measures of anatomical changes. The issue was explained in an exemplary way in Fox et al. (2011) , where the authors discussed a clear example of plausible non-linear registration result in Alzheimer's disease, which however led to inconsistent quantifications of volume change. The problem is intrinsically linked to the robustness of the registration, to regularity issues, and more generally to the consistency of the numerical schemes adopted by the framework, for instance for the computation of the Jacobian determinant associated to the transformation. These points are seldom discussed when presenting novel registration methods.\nFinally, since non-linear registration is more and more applied to the analysis of large datasets, computational efficiency and flexibility are becoming important and desired requirements for the application in clinic and research.\nIn this work we present the LCC-demons, a reliable and general new registration framework aimed to jointly satisfy the following set of fundamental requirements: accuracy, robustness to bias, theoretical solidity coupled with numerical efficiency, and consistency of the anatomical measures. We detail in the following sections the above requirements and the related critical issues."}, {"section_title": "Similarity measures to robustly detect the anatomical differences", "text": "In non-linear registration the deformation is found by optimizing a measure of similarity between two images. Thus, the quality of the retrieved deformations greatly depends on the choice of this metric. A classical similarity measure is the sum of squared differences (SSD) of the intensities, which is completely driven by the global intensity differences (Bajcsy et al., 1993; Stefanescu, 2005) . Despite the simple numerical implementation, this metric is highly sensitive to the intensity biases which affect the medical images. Bias correction is often performed prior to image registration in order to remove global intensity inhomogeneity (Hou, 2006; Sled et al., 1998; Tustison et al., 2010) , but this is often not sufficient to remove local changes in the bias field. For this reason, more complex similarity criteria able to account for the bias have been proposed. For instance the (normalized) correlation criterion assumes a global affine relationship between the intensities in the images, to account for global multiplicative and additive bias (Collins et al., 1995; Dong and Boyer, 1995) , while the (normalized) mutual information (NMI) does not require any parametric assumption on the relationship between the intensities, and is based on the global joint intensity histogram (Maes et al., 1997; Studholme et al., 1996; Wells et al., 1996) . The robustness of NMI comes at the price of the computation of the histogram, and thus of complex optimization schemes.\nMore importantly, all the above criteria are global, i.e. they assume a uniform bias distribution over the image space. However in medical images the bias is frequently locally varying, and in this case a global similarity measure might lead to wrong estimations of the deformations. By assuming that the information in the image is locally sufficient to estimate the intensity bias, in Cachier et al. (2003) the authors proposed a local implementation of the correlation criteria. Interestingly, such a framework led to an efficient optimization scheme based on Gaussian convolutions and computed through the classical Demons registration setting.\nThe local correlation coefficient (or local cross correlation) is based on the implicit estimation of the local affine scaling parameters of the intensities (additive plus multiplicative), and was later used in several successful registration algorithms as a good trade-off between the SSD, in which there are no hidden parameters to estimate, and the very unconstrained Mutual Information, which requires the estimation of the joint probability distribution of the intensities in the images (Avants et al., 2008; Hermosillo and Faugeras, 2004; Jolly et al., 2010) . The local formulation of LCC is indeed possible thanks to the low number of hidden parameters which enable a reliable estimation in reasonably small neighborhoods, while this is not the case for MI."}, {"section_title": "Diffeomorphic registration: mathematical formulation and numerical efficiency", "text": "The new-generation non-linear registration algorithms perform diffeomorphic registration by parameterizing the deformations by the flow of time varying or stationary tangent velocity fields. The use of diffeomorphisms provides a rich mathematical setting for elegant and grounded methods for atlas building (Joshi et al., 2004) , group-wise (Bossa et al., 2007) , and longitudinal statistical analysis of deformations (Avants et al., 2007; Davis et al., 2007; Durrleman et al., 2012; Lorenzi et al., 2011) .\nDiffeomorphic registration was introduced with the large deformation diffeomorphic metric mapping setting (LDDMM) (Beg et al., 2005) , which parameterizes the deformations with time varying velocity fields, and in Avants et al. (2008) an implementation of the LDDMM based on the local cross correlation criteria was proposed. However, the LDDMM has high computational cost (usually reported in order of hours on standard computers) that might prevent the intensive application on large dataset, or on high resolution data.\nIn order to find an optimal compromise between accuracy and computational efficiency, it was proposed in Arsigny et al. (2006) to parameterize diffeomorphic transformations with stationary velocity fields (SVFs). The framework was used in different registration settings (Ashburner, 2007; Bossa et al., 2007; Modat et al., 2011; Vercauteren et al., 2008b) , and was applied to several clinical problems (Lombaert et al., 2012; Lorenzi et al., 2011; Mansi et al., 2011; McLeod et al., 2012; Seiler et al., 2011 Seiler et al., , 2012 Sweet and Pennec, 2010) . The computational time reported for the registration parameterized by SVF is usually of dozens of minutes. In light of these results, the SVF registration might represent a powerful clinical instrument for the evaluation of the morphological changes in organs, due to its high flexibility and efficiency. However, standard SVF based algorithms such as the log-Demons (Vercauteren et al., 2008b) are based on the sum of squared differences criteria (SSD), which is not robust to the intensity bias affecting the medical images and might limit the applicability of such a framework in the clinical context."}, {"section_title": "Consistent measures of spatial changes from local to regional scale", "text": "In order to provide a useful measure of anatomical changes for clinically oriented applications, a registration framework should be able to consistently quantify the changes at different spatial scales.\nClassically, non-linear registration was used to provide local measures of change at the finer scale (voxels, meshes) to be used in group-wise statistical analyses of morphological differences. Among the many techniques we can find the voxel compression maps (VCM) (Fox et al., 2001) , the voxel/tensor-based morphometry based on the Jacobian determinant of the deformation (VBM, TBM) (Ashburner and Friston, 2000; Riddle et al., 2004) , the RAVENS maps (Resnik et al., 2000) , and the cortical pattern analysis (Thompson et al., 2003) . However, measures at the voxel level are sensitive to biases and are variable across subjects.\nGlobal measures of regional changes are more commonly used in clinical practice, to quantify regional volumes on selected anatomical structures. These measures are usually quantified by segmentation: for instance, the boundary shift of anatomical regions of interest (ROI) (FreeBorough and Fox, 1997) is currently used to evaluate the longitudinal volume changes in time series of images (Leung et al., 2009) . As a drawback, methods based on segmentation do not allow to model the anatomical differences, for instance by voxel-wise statistical analysis or by extrapolating longitudinal observations, which is something that is possible with non-linear registration.\nGlobal measures of average volume change can be estimated from local measures by integration of the Jacobian determinant of the deformation in selected regions (Boyes et al., 2006; Camara et al., 2008) . Even though the Jacobian determinant is a largely used index of volume changes associated to anatomical deformations, it comes with some important issues that should be accounted for. First, the computation of the Jacobian matrix requires to evaluate spatial derivatives which are usually done by finite differences on the image grid, and it is well known that they are highly sensitive to the approximation introduced by the discretization. Moreover, the impact of the numerical approximations is even larger if we consider that the Jacobian determinant is basically a cubic polynomial of the values of the vector field. Second, experimental evidence showed that the logarithmic transformation of the Jacobian determinant might be more appropriate in morphometric studies, since it provides non-skewed quantities (Leow et al., 2007) . As a drawback, the log-Jacobian determinant does not represent anymore the volume change, and thus lacks a precise biological interpretation.\nOther quantifications of spatial changes might then be considered. For instance, the flux of the deformation across the boundary of a region is a measure of global morphological change that can be used for growth and longitudinal volume change analyses (Chung et al., 2001) . The flux should theoretically be less sensitive to discretization errors of the displacement field as it measures a linear polynomial of the vector across the boundaries. However, since the flux requires the computation of the vector's normal to the boundaries, the use of this measure was very limited in the past due to the high sensitivity to segmentation errors."}, {"section_title": "Paper organization and summary", "text": "The present work proposes a novel symmetric diffeomorphic registration framework based on SVFs, which implements the LCC as the similarity measure. We show that our registration is at the same time accurate, robust to the intensity biases and to the asymmetric image resampling. Moreover, we contribute with novel numerically stable and efficient methods to compute the Jacobian determinant and the flux of the deformation across boundaries, in order to provide consistent measures of anatomical changes from the local to the regional level.\nIn the section LCC-Demons: Symmetric Unbiased Diffeomorphic Registration we introduce the symmetric LCC-Demons, a registration framework based on the log-Demons which implements the symmetric local Correlation Criteria (LCC) as a similarity measure. While the LCC similarity metric is well known in the literature, our contribution is to propose a new intrinsically symmetric version of it. In the section Stable and consistent measures of brain changes: from voxel to regional level we derive from the resulting SVF a spatially robust and consistent evaluation of the morphological changes from the voxel to the regional level. In fact we show that the SVF framework provides both stable voxel-by-voxel estimations of the Jacobian determinant, and consistent measures of regional changes given by the flux of the deformation across boundaries, which is obtained by the integration of the log-Jacobian determinant. Interestingly, with our framework the flux of the deformation is computed by a volume integral, which consequently leads to more robust and reliable measures of volume change. The presented method is validated in the section Registration accuracy: evaluation on public datasets by comparing our algorithm against state-of-the-art registration algorithms for the accuracy in inter-subject registration, and in the section Measuring the longitudinal changes in Alzheimer's disease for the longitudinal atrophy measurements in Alzheimer's disease. The resulting longitudinal atrophy measures are compared to the ones obtained by the BSI algorithm (FreeBorough and Fox, 1997) , a validated measure of brain atrophy currently employed in the clinical setting."}, {"section_title": "LCC-Demons: symmetric unbiased diffeomorphic registration", "text": "The log-Demons algorithm"}, {"section_title": "Diffeomorphisms parameterized by stationary velocity fields (SVFs)", "text": "Let \u03a9 be the spatial domain of a given image F, and let consider the manifold Diff(\u03a9) of automorphisms of \u03a9. The log-Demons algorithm estimates the diffeomorphic transformation \u03d5 \u2208 Diff(\u03a9) which minimizes the intensity difference between a fixed image F and a moving image G (Vercauteren et al., 2008b) . Denote by T id Diff(\u03a9) the tangent space of Diff(\u03a9) at the identity. The deformation \u03d5 belongs to the one-parameter subgroup of diffeomorphisms generated by tangent SVFs of TDiff id (\u03a9). The one-parameter subgroup of a SVF v is the unique solution of:\nis an additive group with respect to the real parameter\nThe transformation \u03d5 is then defined as the Lie group exponential map exp(v) = \u03d5(x, 1) = \u03d5(x). The use of SVFs simplifies the LDDMM formulation and leads to a good compromise between theory and efficiency for computationally tractable registrations. For example, the exponential operation is efficiently implemented in the log-Demons algorithm with the \"scaling and squaring\" scheme (Arsigny et al., 2006) by taking advantage of the additive property of the elements of the one-parameter subgroups. This allows to compute the final parameterization as the recursive composition of successive exponentials (Algorithm 1).\nAlgorithm 1. Computing the transformation \u03d5 = exp(v) parameterized by a SVF v: Scaling and Squaring for the Lie group exponential."}, {"section_title": "Log-Demons registration energy", "text": "In the log-Demons framework, the registration of the images F and G is achieved through the alternate minimization of the following energy, which is optimized with respect to the transformation SVF v, and to the auxiliary correspondence field parameterized by a SVF v x (Vercauteren et al., 2008b) :\nHere the L 2 norm is the standard Euclidean norm, while the parameter \u03c3 i relates to the noise in the images, \u03c3 x controls the uncertainty of the matching in the coupling term, and \u03c3 T the regularization strength.\nThe Baker-Campbell-Hausdorff (BCH) formula describes the composition of transformations in the log-space (Bossa et al., 2007) :\nfor the so-called update field, we can rephrase the coupling term of (2) as \u2016\u03b4v\u2016 2 L 2 . The minimization of the above energy is alternatively operated with respect to the two variables v and v x in two steps:\n\u2022 Step1. Optimization of the similarity. Given v, the energy\nis optimized for \u03b4v, and hence for the correspondence parameter v x = BCH(v, \u03b4v), to find an un-regularized correspondence v x that matches the images F and G. The Gauss-Newton optimization leads to a closed form solution for the update \u03b4v, which is then efficiently composed with v by using the BCH formula.\nis optimized with respect to v. In the log-Demons the zeroth order approximation of the BCH formula \u03b4v\nis normally used. With this choice, by following Mansi et al. (2010) we obtain a closed form by convolution for the regularization step. When the criterion Reg is conveniently chosen, 2 the optimal v is obtained in the Fourier domain and corresponds to the Gaussian smoothing v = G \u03c3 * v x , which leads to Laplacian-like regularization of the velocity field v x . In addition to this, the standard log-Demons registration implements a fluid-like regularization of the update field G \u03c3 f \u00c3 \u03b4v, which corresponds to the choice of the projection of the update field into a smoother space of velocity fields."}, {"section_title": "Symmetric forces in the log-Demons", "text": "In the log-Demons algorithm, the estimation of the SVF v is unbiased with respect to the choice of fixed and moving image. In fact it is symmetrically computed by minimizing the energy E sym\nThe symmetrization comes straightforwardly from the SVF parameterization of the deformations, and is optimized by averaging the solutions given by the two separate terms. However the strategy requires the separated optimization of both correspondence terms, and might be computationally costly in case of similarity terms more complex than the standard sum of squared differences implemented in the log-Demons.\nIn this paper we propose to symmetrize a given criteria by optimizing in the half-way space, reached by resampling both fixed and moving images in a single energy term. This way the symmetric deformation can be simultaneously computed with a single optimization procedure. This can be easily formulated within the SVF framework\n\u00c0 \u00c1 be the symmetric difference of intensities for a transformation parameterized by the SVF v. Then the square of this residual image is the symmetric sum of squared difference (SSD) energy E SSD\nWe show in Appendix A that in this case the optimization of the proposed symmetric SSD is consistent with the symmetric optimization used in the standard log-Demons algorithm."}, {"section_title": "Symmetric LCC in the log-Demons", "text": "In the standard log-Demons algorithm the correspondence field is given by the minimization of the sum of squared difference (SSD) between the intensities of the two images, which is not robust to the local intensity biases. In order to avoid mistaking spurious intensity variations for morphological differences, we propose to adapt the log-Demons framework to the local correlation coefficient (LCC), by following Cachier et al. (2003) .\nConsider the image F, and let F \u00bc G \u03c3 \u00c3 F x \u00f0 \u00de be the local mean image defined by Gaussian smoothing G \u03c3 with a kernel size \u03c3. The LCC is defined as:\nThe LCC similarity \u03c1 measures how the intensities of the two images are correlated within the local Gaussian neighborhood of size \u03c3. Given a pair of images F\u2032 and G\u2032, let us consider the symmetric\nIf we replace the SSD in Eqs.\n(2) and (3) by the squared LCC, we obtain the new correspondence energy\nWe show in Appendix B that the optimization of Eq. (5) with respect to the symmetric update by exp \u03b4v 2 \u00f0 \u00de of F and G can be computed with a closed form formula:\nThus, our symmetric LCC criterion preserves the structure of the original log-Demons. Now that we have derived an efficient registration algorithm which is robust to intensity biases, let us turn to the robust measure of longitudinal changes for the resulting deformation parameters.\nStable and consistent measures of brain changes: from voxel to regional level\nThe quantification of the amount of warping applied at each voxel by the dense deformation field \u03d5 is usually locally derived from the 2 For instance by choosing the infinite order Tikhonov regularizer proposed in Cachier and Ayache (2004) :\nJacobian matrix \u2207\u03d5 of the deformation in terms of determinant det(\u2207\u03d5), log-determinant log(det(\u2207\u03d5)), trace Tr(\u2207\u03d5), and the strain tensor \u2207\u03d5\u2207\u03d5 T . A global index of change can be extracted from the local information by:\n\u2022 Integration of the Jacobian determinant on the region of interest R. This is an average measure of volume change. \u2022 Evaluation of the flux of the deformation field across the boundaries \u2202R of the region, i.e. the amount of vectors flowing through the boundaries during the registration procedure. This value represents the mean shift of the boundaries, i.e. how much do we move (in the mean) along the normal to the surface enclosing the region. This is the equivalent of the classical intensity based Boundary Shift Integral (FreeBorough and Fox, 1997) , in which the variation of the intensities, or the\"flow\", along the normal to the surface is considered.\nIf the flux of a specific region is known, we can derive the ratio of volume change by comparing the volume enclosed by the shifted boundaries relative to the original one. However, the direct computation of the flux of a deformation is usually highly sensitive to the segmentation of the boundaries. This limitation prevented the use of the vector flux in favor of the more robust Jacobian determinant integration, while surrogate measures of the boundary shift were proposed based on the comparison of regional segmentations (FreeBorough and Fox, 1997; Smith et al., 2002) ."}, {"section_title": "Flux across surfaces from the log-Jacobian integration", "text": "In this section we provide a robust method for computing the flux of the deformation within the log-Demons framework. By considering formula (1), we show in Appendix C that the following equality holds:\nEq. (6), specifies that the integral of the log-Jacobian determinant of the deformation over a region R is equal to the flux of the velocity field across the corresponding boundaries \u2202R, consistently computed along the exponential trajectory. Eq. (6) consistently computes the flow of the vector field during the evolution described by the SVF parameterization, and measures the flux of a vector field through the region boundaries (right side of Eq. (6)) by scalar integration of the log-Jacobian determinant in the region volume (left side of Eq. (6)).\nThe present framework replaces the surface integral with the more stable volume integration, which simplifies and robustifies the measure of the flux by attenuating the segmentation errors (and relative erroneous boundary detection). This allows to deal with anatomical uncertainties, for instance by scalar integration on probabilistic masks. The difference between the Jacobian and the log-Jacobian analysis becomes clear: the former quantifies the mean volume changes of a region (or of a voxel as limit case), while the latter quantifies the local mean shift of the boundaries of that region (or voxel)."}, {"section_title": "A stable numerical scheme for computing the Jacobian determinant", "text": "The computation of the Jacobian determinant det(\u2207\u03d5) of a transformation \u03d5 is usually performed by spatial differentiation of the transformation using finite differences (Algorithm 2).\nAlgorithm 2. Classical computation of the Jacobian determinant by finite differences Given a discrete sampling \u03d5 of the transformation over the image grid space {x i }:\n1. Compute the Jacobian matrix J \u03d5 via finite differences. For instance, with the forward scheme, the k, l entry is:\nwhere h is the scalar step size, \u03d5 l (x) is the l-th component of the transformation, and e k is the basis vector along the direction k. 2. Compute the determinant of \u2207\u03d5 with the preferred numerical method.\nHowever, finite differences are usually highly sensitive to the spatial noise. They also critically depend on the discrete sampling which might create instabilities in the case of large deformations, thus leading to incorrect Jacobian determinant estimation. For instance the sampling of the deformation field in the image grid space might introduce an unequal distribution of the vectors around a sink, and therefore induce negative Jacobian determinant estimations which are mis-interpreted as spurious folding effects.\nIn this section, we provide a stable and consistent computation of the Jacobian determinant according to the scaling and squaring method for the Lie group exponential (The log-Demons algorithm section). From the additive property of the elements of the one-parameter subgroups, exp(v) = exp(v/2) \u2218 exp(v/2), the following relationship for the Jacobian determinant holds:\nThe (log-)Jacobian determinant can then be recursively computed according to Eq. (7). If we reliably initialize the computation of the (log-)Jacobian determinant by finite differences on the scaled velocity field v 2 N , we can then recursively compute it as detailed in Algorithm 3. In this case, finite differences are used only on a sufficiently small vector field in order to minimize the discretization errors. Then the Jacobian determinant is evaluated accordingly to the exponential path and is thus consistent with the definition of diffeomorphisms parameterized by SVFs. Moreover, the log-Jacobian determinant is defined in terms of the divergence of the velocity and, by definition, the value of the corresponding Jacobian determinant always remains strictly positive. Choose N so that 2 \u2212N v is \"small\". 2. Compute a first approximation:\n3. Squaring step. For k = 1 to N do\nReturn the Jacobian determinant J N , and the log-Jacobian determinant L N ."}, {"section_title": "Experiments", "text": "In this section we demonstrate the numerical stability of the methods proposed in Stable and consistent measures of brain changes: from voxel to regional level section, and the accuracy of our new LCC registration algorithm."}, {"section_title": "Jacobian determinant: scaling and squaring vs finite differences", "text": "We consider here a practical example with a pair of longitudinal brain images from the ADNI dataset. As can be seen in the detail of Fig. 1 , even after bias correction (Tustison et al., 2010) and histogram equalization, a persistent difference between the two images on the white matter intensities is still appreciable. The intensity shift in the white matter is detected by the SSD criteria of the log-Demons as an anatomical difference which generates a sink at the center of the area. This highly localized large deformation leads to negative Jacobian determinants when estimated with the standard finite differences of the sampled values on the image grid. On the contrary, our method for computing the Jacobian determinant from SVF provides stable and consistent estimations."}, {"section_title": "Robustness to the intensity bias: a controlled example", "text": "We first tested the robustness of the LCC-Demons to the intensity biases on a controlled experiment. We created a realistic simulated anatomical deformation based on the deformation field that matched the baseline scan (I 0 ) of a patient to its 1-year follow-up, computed using the log-Demons algorithm. The ventricular expansion was extracted for the resulting SVF v in a box enclosing the ventricles. The deformations in the remaining areas of the brain were imposed to be negligible random noise. The resulting deformation field \u03c6 = Exp(v) was used to warp the baseline scan I 0 to generate the longitudinal image with increased ventricular expansions. This pair of images was then used as reference to test the robustness of the detection of the longitudinal changes in the ventricular reference region to the bias.\nFor this purpose, the intensities of the follow-up image were corrupted by introducing spatially smooth random additive (\u00b15% of the mean baseline intensities) and multiplicative noise (range [0.9-1.1]). The changes between baseline and generated follow-up were evaluated with the LCC-Demons and the standard log-Demons as average log-Jacobian determinant values measured in the ventricles mask. The regularization parameters were set for both methods as \u03c3 fluid = 0.5, and \u03c3 laplacion = 1.5, while the LCC smoothing parameters was \u03c3 LCC = 2. An histogram matching of the image intensities was applied prior to the standard log-Demons registration.\nAs can be seen in Fig. 2 , the LCC-Demons estimation remains stable regardless to the level of noise, while the standard SSD-based log-Demons appears to be highly sensitive. This is reflected by the regional integration of the log-Jacobian map in the ventricles mask: the SSD criteria lead to unstable evaluations while the LCC measures remain consistent."}, {"section_title": "Registration accuracy: evaluation on public datasets", "text": "In Klein et al. (2009) the authors benchmarked several registration algorithms on a collection of publicly available brain images, to compare the registration performance on the matching of a set of manually labeled anatomical regions. This work represents a valuable source of information for the comparison of new registration methods, since the detailed description of the registration results is freely available. 3 Interestingly, the authors found that the performance of the registration algorithms was little affected by the choice of subject population, labeling protocol, and type of overlap measure.\nIn order to test the LCC-Demons we replicated the registration pipeline proposed by Klein et al. (2009) on the data considered by the authors (CUMC12, MGH10, LPBA40 and IBSR12 datasets). Within each dataset, we non-linearly registered all the possible pairs of linearly aligned images, after an initial affine registration to the MNI reference space (Fonov et al., 2009 ). The registration parameters for the LCC-Demons were: \u03c3 LCC = 5, \u03c3 laplacian = 1.5, \u03c3 fluid = 0.5, and \u03c3 i /\u03c3 x = 0.05, with a multi resolution scheme of 30 \u00d7 99 \u00d7 10 iterations (coarser to finer). Fig. 1 . Stable computation of the Jacobian determinant in the SVF setting. Upper row: detail from a pair of anatomical fixed and moving brain images. The difference image denotes a mild non-stationary intensity bias detectable in the white matter. Even after bias field correction, the SSD criteria of the log-Demons models the general shift of the intensities by estimating a contracting deformation field towards the white matter. Bottom row: corresponding Jacobian determinant maps estimated by the standard finite differences on the final deformation field (left), and by the recursive scaling and squaring formula on the SVF (right). In the areas where the estimated deformation is maximal (crossing of blue and red axis) the standard finite differences lead to negative values for the Jacobian determinant.\nThe registration accuracy between each source S and target T was evaluated by the measures of target and union overlap, defined for a specific anatomical region r respectively as\nwhere j\u00b7j is the regional volume. In Fig. 5 we can observe the performance on the LPBA40 dataset in terms of resulting mean target and union overlap on the 56 labeled regions. The results produced by the LCC-Demons compare favorably with those provided by the state-of-art algorithms, and in particular improve the ones obtained by the classical Demons registration. In the LPBA40 dataset the LCC-Demons perform significantly better than most of the compared methods, except ART, and SyN. All the reported mean differences were significant to the standard paired t-test. When tested on the other datasets ( Figs. 6-8) , the only algorithms that consistently provided better overlaps were again ART, and SyN. The average registration time on the tested data was of 27 min (\u00b12.3) for a single core on a Xeon platform 2.66 GHz quad core, 4 Gb RAM.\nWe stress that the registration test was here performed without any specific optimization of the parameters. Moreover, even though high overlap ratios are usually indices of good registration accuracy, these values do not take into account the smoothness of the resulting transformation, nor the accuracy of the related measure of anatomical changes, e.g. of the associated Jacobian determinant. For instance, Fig. 3 shows a comparison of the registration results for Syn and the LCC-Demons for sample pairs of images of the IBSR18 dataset. Syn algorithm was applied by using the parameters specified in the paper of Klein et al. 4 It can be noticed that both algorithms provide reasonable results in terms of image matching. However, the Jacobian determinant map associated to the deformation estimated by Syn is more localized and looks more spiky (non-smooth). We recall that a smoother deformation potentially leads to more stable statistical analysis and often to higher statistical power in group-wise studies."}, {"section_title": "Measuring the longitudinal changes in Alzheimer's disease", "text": ""}, {"section_title": "Experimental data", "text": "Data used in the preparation of this article were obtained from the Alzheimer's Disease Neuroimaging Initiative (ADNI) database (adni.loni.ucla.edu). The ADNI was launched in 2003 by the National Institute on Aging (NIA), the National Institute of Biomedical Imaging and Bioengineering (NIBIB), the Food and Drug Administration (FDA), private pharmaceutical companies and non-profit organizations, as a $60 million, 5-year public-private partnership. The Principal Investigator of this initiative is Michael W. Weiner, MD, VA Medical Center and University of California -San Francisco. ADNI is the result of efforts of many coinvestigators from a broad range of academic institutions and private corporations, and subjects were recruited from over 50 sites across the U.S. and Canada. For up-to-date information, see www.adni-info.org."}, {"section_title": "Longitudinal pre-processing and registration", "text": "The baseline and one year follow-up brain images were collected from the ADNI dataset for a group of 200 healthy subjects and 141 patients affected by Alzheimer's disease. For each subject, the follow-up images were rigidly aligned to the baseline and the longitudinal changes were evaluated by registration with the LCC-Demons algorithm (smoothing sigma for the criteria \u03c3 LCC = 2, \u03c3 la placian = 1.5, and \u03c3 fluid = 0.5)."}, {"section_title": "Mask definition for regional measures", "text": "In standard deformation based morphometry, the amount of measured regional brain atrophy is usually quantified by the scalar integration of the average Jacobian determinant map of the deformation on a pre-defined region of interest (ROI).\nAs showed in Fig. 3 , morphological changes can be equally explained by different registration models. In particular, different registrations can provide very different results in terms of smoothness of the estimated deformations, which would finally lead to different localization and related quantification of the estimated volume changes.\nIn order to evaluate the anatomical changes consistently with respect to the registration model, we propose here to adapt a given anatomical ROI in order to maximize the vector flux across the boundaries. In this way the ROI is modified in order to account for the smoothness of the deformation. In Vasilevskiy and Siddiqi (2002) it was shown that, given a vector field v and a surface S, the maximal flux of v across S is obtained by evolving the region along the direction\nThus, given an initial brain mask and a longitudinal deformation, we can continuously deform the mask in order to maximize the flux of the longitudinal deformation through its boundaries, i.e. adapt the mask to the areas of significant longitudinal changes.\nIn our experiments we computed the gray-white matter tissue mask with an automated procedure based on the FSL package tools for the automatic brain extraction and the tissue class segmentation (Patenaude et al., 2011; Smith, 2002) . The estimated mask was then flowed along the longitudinal deformation according to Eq. (8) as M i\u00fe1 \u00bc M i \u2218 \u2202S \u2202t (15 iterations) and then used for the longitudinal quantification (Fig. 4) .\nThe whole brain changes were defined by the weighted Jacobian determinant, which represents the average volume change within the probabilistic mask, and by the weighted log-Jacobian determinant, which represents the expected flux of the deformation through the region's boundaries. If we approximate the region with a sphere S1 having the same volume, we can compute the flux-derived volume change by considering a radial field acting on the sphere S1 and having the same flux. We obtain then a volume change index by comparing the volume of the resulting shifted sphere S2 relatively to S1.\nFor sake of comparison the measurements were compared to the KNBSI 5 atrophy index (Leung et al., 2009 ) obtained using our initial brain masks on the same processed data."}, {"section_title": "Longitudinal atrophy estimation", "text": "The average measures for the one-year whole brain changes estimated by the LCC Demons are shown in Table 1 . The volume changes measured by the Jacobian determinant integration are consistent with those derived from the flux and are respectively of 1.8% per Fig. 4 . Deforming a volumetric mask in order to maximize the flux across the boundaries. From left: reference image, associated brain mask, and the deformed mask which maximizes the flux of the longitudinal deformation. The last picture shows the log-Jacobian determinant map of deformation. It can be seen that the deformed mask is adapted to the areas of maximum expansion.\nyear for the AD group and 1% per year for the healthy subjects. The proposed results are consistent with the KNBSI estimations (last column), obtained on the same data. The sample size analysis provided similar results, with the lowest score given by the flux associated to the deformation (552 subjects). We specify that the KNBSI algorithm was applied here using a different processing protocol than the one proposed in Leung et al. (2009) . In particular, the affine registration employed here was not symmetric, and there was no manual intervention in the segmentation of the brain masks. Therefore, the suboptimal processing protocol might explain the worse results in terms of sample size analysis when compared to those reported by the authors. Even though a detailed comparison of the processing procedures is out of the scope of this work, we notice that the methods performed similarly when applied to the same data. "}, {"section_title": "Conclusions and perspectives", "text": "In this work we proposed an efficient, accurate and robust registration framework for the estimation and quantification of anatomical changes in medical images. We first introduced the LCC-Demons, a diffeomorphic registration algorithm robust to intensity biases, which extends the standard log-Demons algorithm by preserving the simple numerical implementation and the related computational efficiency. Second, we provided a new numerical scheme for the computation of the Jacobian determinant of a deformation parameterized by a stationary velocity field, which prevents the numerical inaccuracies induced by the finite differences, and is consistent with the diffeomorphic parameterization. Finally, we explained the theoretical difference between log-Jacobian and Jacobian analysis of deformation fields, by showing that the surface integral of the flux of a stationary velocity field is the regional integration of log-Jacobian determinant associated to the deformations. This last contribution shows the complementary information provided by the Jacobian and the log-Jacobian determinant, and their different meaning when used as index of anatomical changes in morphometric studies.\nThe proposed methods were extensively tested on large publicly available dataset in both inter and intra-subject registration settings, and the results were comparable with those obtained by the most referenced methods for registration and atrophy quantification. The experiments demonstrate that LCC-Demons is a candidate instrument for both research and clinically oriented purposes, as already shown in scientific works based on the presented method (Lorenzi et al., 2012a,b,c) . a transformation parameterized by the SVF v, then the square of this image is the classical sum of squared difference (SSD) energy\nWe now recall the efficient second-order minimization scheme (ESM) of the standard SSD, \u2016D v; F; G \u00f0 \u00de \u2016 2 L 2 , employed in the symmetric log-Demons algorithm (Vercauteren et al., 2008a) . This optimization method is based on the implicit symmetry constraint which assumes an exact matching of the images for an optimal update exp(\u03b4u opt ) of the deformation. Indeed they imposed G \u2218 exp(v) \u2218 (\u03b4u opt ) = F, or equivalently that G \u2218 exp v \u00f0 \u00de \u2218 exp \u03b4u opt 2 \u00bc F \u2218 exp \u2212 \u03b4u opt 2 .\nLet w = BCH(v, \u03b4u) be the deformation parameters after an update of the SVF v by \u03b4u. The ESM optimization scheme proposed in Vercauteren et al. (2008a) is based on the following Hessian-free second order Taylor expansion of D: \u00de for the first order term of Eq. (A.2). The authors showed the practical advantages of using this term for the optimization of E SSD in terms of improved registration accuracy, and smoothness properties of the resulting deformation. We notice that this term is related to the one that we obtained with our symmetric update rule (Eq. (A.1)), since they both involve the average of the gradients of F and G. We notice however that with the ESM scheme only the image G is resampled, while our scheme is symmetric."}, {"section_title": "Appendix B. Optimization of the LCC-Demons correspondence", "text": "Given a pair of images F\u2032 and G\u2032, consider the symmetric resampling\nIn this section we derive the Table 1 Longitudinal whole brain changes in Alzheimer's disease and healthy aging measured by the LCC-Demons as the average Jacobian determinant, flux across the boundaries, and flux derived volume change (standard deviation on parenthesis). Last column: KNBSI atrophy rates obtained on the same data. Bottom row: estimated sample size associated to the measures for detecting a 25% change in the AD trend when controlled to normal aging (80% power, p b 0.05 (Fox et al., 2000) ). The symmetric LCC correspondence considers the symmetric resampling of the images, and is optimized with respect to the symmetric composition by the update field exp \u03b4v 2 \u00c0 \u00c1 . We have the following Taylor expansion:\nThe result states that, in the SVF framework, the log-Jacobian determinant of \u03d5(x) = \u03d5(x, 1) is the integral of the divergence of the velocity field along the path described by the exponential.\nAssuming now that R is a region volume in the domain of the vector field \u03d5(x), we can integrate Eq. (C.3) to obtain:\nWe recall now the Divergence (or Ostrogradsky's) theorem, which states that for a region R immersed in a vector field v the following relationship holds:\nwhere the second part of the equality represents the flux of the vector fields through the boundaries \u2202R. "}]