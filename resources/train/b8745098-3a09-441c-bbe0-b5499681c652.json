[{"section_title": "Abstract", "text": "Accurate registration of medical images is vital for doctor's diagnosis and quantitative analysis. In this paper, we propose a new deformable medical image registration method based on average geometric transformations and VoxelMorph CNN architecture. We compute the differential geometric information including Jacobian determinant(JD) and the curl vector(CV) of diffeomorphic registration field and use them as multi-channel of VoxelMorph CNN for second train. In addition, we use the average transformation to construct a standard brain MRI atlas which can be used as fixed image. We verify our method on two datasets including ADNI dataset and MRBrainS18 Challenge dataset, and obtain excellent improvement on MR image registration with average Dice scores and non-negative Jacobian locations compared with MITs original method. The experimental results show the method can achieve better performance in brain MRI diagnosis."}, {"section_title": "Introduction", "text": "Image registration is a common task in MR image analysis and has been an active research topic in many areas, which aligns the image space into a common anatomical space. The deformable registration strategy calculates the dense correspondence between two images and generates the affine transformations for global alignment, which are usually much slower and have higher degrees of freedom. There are two types of methods in deformable registration, including classical registration methods (non-learning-based) and learning-based methods. Classical registration methods solve the optimization problems on spatial of deformation (the space of displacement vector field), including elastic-type models [1] , b-splines [7] , statistical parameter mapping [17] , Demons [9] or discrete methods [5] . Diffeomorphic transformations have undergone extensive advancement, resulting in state-of-the-art tools such as LDDMM, DARTEL and SyN. But these tools demand amounts of time and computational resources for a given image pair on a CPU.\nThe emergence of deep learning enables neural networks to penetrate into medical image registration. Recently, some methods are proposed to train neural networks that map a pair of input images to output deformation. Balakrishnan et al. [11] performed a rigorous analysis of their method and presented the results on a complete MR volume. They studied MR brain image registration based on 3D slices and the computational efficiency of this method is also higher than the existing general methods. They proposed an unsupervised learning network called VoxelMorph [15] , using a pair of 160x192x224 3d images as input. They tested their method on eight publicly available MRI brain image datasets. They also present a probabilistic generative model and derive an unsupervised learning-based inference algorithm [3] [4] to provide diffeomorphic guarantees and uncertainty estimates.\nIn this paper, we propose a new deformable medical image registration method based on differential geometric information which trained on original network in [4] and get the state-of-the-art performance among else methods before to the best of our knowledge. The constructions of this paper are: 1. we propose a new deformable medical image registration method based on differential geometric information including the Jacobian determinant(JD) and the curl vector(CV) of diffeomorphic registration field on the VoxelMorph CNN architecture in the paper [4] .\n2.we also build a registration template for 7 MRI image samples according to average of differential geometric transformation."}, {"section_title": "Method", "text": "\nAvg Table 1 : Test average results of IBSR training set (10) (11) (12) (13) (14) for different N of JD images with three modalities(DC:%, HD: mm, AVD:%). Fig.5 shows representative results. We present the example MR slices (Two anatomical planes) of input moving image, atlas, and moved images for different experiments, with overlaid boundaries of ventricles (yellow). From the red box, according to atlas, our latter two methods get clearer details of moved images and better registration performance than VoxelMorph-diff. Fig.6 shows the registration fild \u03c6 for different experiments (RGB image and warped grid), the method VoxelMorphregistration get smoother diffeomorphic registration field \u03c6 than else two method. Based on FreeSurfer segmentation, we used three methods already trained to test the anatomical scans from the unseen anatomical structures of ADNI. This dataset contains expert manual delineations of anatomical structures, which is used for our evaluation. The following experiments shows the results of anatomical segmentation for different experiments. We can see VoxelMorphdeformation method performs better segmentation results than other methods from the different color regions. "}, {"section_title": "The Deformation Method", "text": "In deformable registration problem, it is essential to find diffeomorphic registration field \u03c6. Here, we introduce the deformation method that can generate JD and CV by the grid generation (namely registration field \u03c6), which will be used in our later methods. Diffeomorphism is an active research topic in differential geometry [13] . JD and CV play an important role in determining a diffeomorphism. Since JD has the same direct physical meaning in grid generation which represents the size of grid cell and CV represents the grid cell rotations, the deformation method was applied successfully to grid generation and registration problems of MRI brain image [2] .\nWe use MATLAB to generate the grid images (diffeomorphic registration field \u03c6) using the deformation method on the gradient and gray value of original image. And we extract the images formed by JD and CV information from the grid images ( Fig.1(c)(d) ). The following Fig.1(b)(c)(d) show the grid image, JD and CV image of MRI brain respectively, which present geometric deformation features of the image, especially highlight the change of morphological features of CSF, GM, WM. According to manifold learning [10] , CNN can extract the manifold features from images. So, we extract JD and CV images from generated known \u03c6 and use them as input of CNN for better extracting manifold features."}, {"section_title": "Variational Method for Image Registration", "text": "Here, we use variational method to construct diffeomorphisms \u03c6, through controlling directly the Jacobian determinant and the curl vector of a transformation, which shows the important role of the JD and the CV in determining a diffeomorphism. It is called the Variational Method [13] . Let\nwe define the similarity measure in 3D as:\nHere, f 0 is the prescribed Jacobian determinant monitor function, and g 0 is the prescribed curl vector monitor function. So, the problem we study now is to construct numerically a transformation \u03c6 : \u2126 \u2192 \u2126, namely, J(\u03c6) = f 0 , curl(\u03c6) = g 0 .\nFor two different images I 1 (x, y, z) and I 2 (x, y, z), image registration process is to fnd a transformation \u03c6 such that I 1 (\u03c6) = I 2 . Here, a new registration algorithm based on variational method is developed. Given the moving image T and the fixed image R in 3D, we determine a registration transformation \u03c6 by iteratively minimizing a similarity measure:\n3 Proposed Framework"}, {"section_title": "Training Strategy Based on Average JD and CV", "text": "The following Fig.2 shows the proposed framework and the training strategy of our method. Given a same atlas or reference volume, N volumes of our training set (y 1 , y 2 , ..., y N ) were used as the input of the network, and output the approximate posterior probability parameters including the velocity field mean \u00b5 (z|x,y) and variance \u03a3 z|x,y . The velocity field z is sampled and transformed to a diffeomorphic deformation field \u03c6 z using squaring and scaling layers. Finally, we use a spatial transform function warps y i to y i \u2022 \u03c6 z . At registration stage, we generate the image of deformation filed \u03c6 z by evaluating def \u03c6 (x, y) during registration between original each two volumes (x,y i ). As for known generated registration filed \u03c6, we extract JD and CV images (note CV images have 3 volumes) in the first training stage and use them as channels of original networks for second train. So, we can generate N pairs of (JD i , CV i 1, CV i 2, CV i 3), for each moving image subject of train set, and combine them with corresponding JD and CV generated from \u03c6 zi as 5 channels, and for fixed image subject, we combine it with the average image of\nas 5 channels, finally combined moving and fixed images are input into Voxelmorph to train again and then we test registration between pairs of unseen subjects from testing set. The loss can also be the original composed of two terms by estimating the variational lower bound using SGD methods in MIT's paper. To make comparison in following experiment, we also get JD and CV from diffeomorphisms \u03c6 which generated directly using deformation method on the gradient and gray value of input moving volumes described in section 2.1, but not from the registration filed \u03c6 in the first training stage, then perform the same process as above.\nThe following Fig.3 shows the deformation filed \u03c6 of initial training stage and generated JD and CV image from \u03c6. Fig.3 (a) shows the RGB image of \u03c6 and Fig.3 (b)(c)(d) shows each channel of Fig.3(a) . Fig.3 (e) shows the generated JD of \u03c6. It is important to note that the curl of the image has three components(channels) coming from different axes in 3D. Fig.3(f) represents the RGB image of generated CV and each channel of it is shown in Fig.3 (g)(h)(i). In this work, we use generated JD and CV as channels of the training model to train again based on the VoxelMorph CNN architecture and we get better performance than train only once in MIT's paper [21] which we describe in the following section. "}, {"section_title": "Average Transformations", "text": "We use average a set of transformations [16] by averaging their JD and CV. Given a series of transformations \u03c6 i for i = 1, 2, ..., N , we construct their average in the following steps: The average deformation has certain geometric meaning: the local size change ratios modeled by J(\u03c6 i ) and the local rotations modeled by curl(\u03c6 i ) are averaged to average transformation. So, we apply average transformations to medical image registration. This is also the reason why we combine average of JD and CV with Fixed image as 5 channels in the above framework to predict better registration filed \u03c6. Because it synthesizes all the information of \u03c6 i which are obtained in the first training stage and it can improve the accuracy of medical image registration. Figure 2 : The proposed framework of our method."}, {"section_title": "Construction of Atlas(Template)", "text": "Here, we want to construct an unbiased template using average of transformations according to Step1: for our dataset with N subjects, we take one subject y i out as the initial template, then register y i to all N images y j for j = 1, 2, ..., i, ..., N to get all deformation filed \u03c6 ij with Voxelmorph CNN.\nStep2: find the average transformation avg i =avg(\u03c6 ij )(j = 1, 2, ..., i, ..., N ) of all the deformation filed by the Average of Transformations method described in above. This step will get N average transformations avg i for i = 1, 2, ..., N .\nStep3: Warp y i on the average transformation avg i to get the temporary template\u015d T emplate i =y i (avg i (\u03c6 ij )) for i = 1, 2, ..., N . This step will get N temporary templatesT emplate i .\nStep 4: repeat Step-1 to Step-3 on biased temporary templatesT emplate i to reduce their bias. So we get a new group of average transformation Avg i and new temporary templatesT i = T emplate i (Avg i ).And we will do above steps until the average transformation avg i is close to the identify map Id (unit orthogonal grid which corresponds to unit orthogonal map)."}, {"section_title": "Experiments", "text": ""}, {"section_title": "Datasets, Preprocessing and Evaluation Criteria", "text": ""}, {"section_title": "Datasets and Preprocessing", "text": "We validate our method on two datasets including ADNI [8] and MRBrainS18. ADNI We use one dataset from ADNI including 199 T1-weighted brain MRI scans. And we split the dataset into 159,20 and 20(8:1:1) volumes for train, validation, and test sets respectively."}, {"section_title": "MRBrainS18", "text": "We apply the average transformation method on this dataset. Seven brain MRI scans (size:240x240x48) of MRBrainS18 with manual segmentations are provided for training and no data are provided publicly for testing. The data can be downloaded from http://mrbrains18.isi.uu.nl/.\nBefore the CNN training stage, standard preprocessing steps for structural brain MRI include the following steps, including skull stripping, resampling and affine spatial normalization using FreeSurfer [6] . Segmentation maps including 29 anatomical structures obtained using FreeSurfer for evaluation."}, {"section_title": "Evaluation Criteria", "text": "In this paper, Dice Score(DS) is the most used criteria for volume overlap of anatomical segmentations. We expect the regions in M (\u03c6) and F according to the same anatomical structure to overlap \nDice score is between 0 and 1, and Dice score is closer to 1 indicates that the structures are more identical. And vice, a score of 0 indicates that there is no overlap. We also evaluate the regularity of the registration field \u03c6. The Jacobian matrix J \u03c6 (p) = \u03c6(p) \u2208 R 3x3 captures the local properties of \u03c6.We compute the number of all non-background voxels for which |J \u03c6 (p)| \u2264 0, where \u03c6 is not diffeomorphic."}, {"section_title": "Implementation", "text": "Our implementation uses Keras [18] with a Tesorflow backend [12] and the Adam optimizer [14] with a learning rate of 1e \u22124 . We used MATLAB to generate the images formed by JD and CV information based on brain MRI, and saved it as nii image format. We set the epochs as 1500, batchsize as 1, steps of per epoch as 100 using one GeForce GTX 1080 Ti GPU. Each training batch consists of one pair of volumes to reduce the memory usage. We choose the model that optimizes Dice on validation set and get results on test set. Algorithm runtime were computed for a GeForce GTX 1080 Ti GPU and an Intel Core i7-6800k CPU."}, {"section_title": "Results", "text": ""}, {"section_title": "Experiments on Test Set", "text": "We present the following experiments demonstrating the results of our proposed method compared with state-of-the-arts methods. Specifically, we register each scan to an atlas computed using external data [6] which is also used on MIT's paper. Table 1 gives a summary of the results on test sets. According to Fig.2 , we get JD and CV from two different \u03c6, one \u03c6 is directly generated using deformation method on the gradient and gray value of input moving volume described in section 2.1 and another is the registration filed \u03c6 in the first training stage, which we refer to two methods as VoxelMorph-deformation and VoxelMorph-registration. We compare them with state-of-the-arts methods the original VoxelMorph and VoxelMorph-diff from MIT's work [15] [4] . The first method VoxelMorph-deformation get the best average Dice with 0.764. The latter three method have comparable runtimes but all faster and yield uncertainty estimates than original VoxelMorph. However, our second method, VoxelMorph-registration produces better diffeomorphic registration fields(having lower numbers of non-negative Jacobian locations) than other methods."}, {"section_title": "Analysis of Velocity Sampling and Uncertainty", "text": "In this section, we evaluate generated velocity sampling and uncertainty for different experiments.\nFrom the bottom row, we can see the VoxelMorph-registration method learns smaller values for \u03a3 z|x,y approximation and yields smoother velocity sample z k than other two methods, namely the diagonal covariance \u03a3 z|x,y has the less potential to add noise to z k , so, the loss function coupled with the squaring and scaling layers lead to smoother and more accurate registration field \u03c6 as Fig.6 shows. And this also testify the result that it can generate better diffeomorphic registration fields which shown in Table 1 ."}, {"section_title": "Experiments on Atlas", "text": "We test the average transformation method using MRBrainS18 dataset to construct a template(atlas) for 7 samples and use it as fixed images for medical registration based on above original VoxelMorph-diff network. We do average transformation method for two iterations, the two average registration field are shown in Fig.9 (a)(b) respectively. Because the average transformation avg 2 is close to the identify map Id, so we stop the iteration step and use one of the Template as fixed image for original VoxelMorph-diff network. From the Table 1 , we refer this experiment as VoxelMorphatlas, compared with VoxelMorph-diff, it has comparable average Dice scores, runtimes and yield uncertainty estimates but produces better diffeomorphic registration fields(having lower numbers of non-negative Jacobian locations, 0.487(0.194)% for VoxelMorph-atlas and 0.511(0.182)% for VoxelMorph-diff). Moving, fixed image(atlas), fixed image and generated registration field \u03c6 are shown in Fig.9 (c)(d)(e)(f) respectively."}, {"section_title": "Conclusions", "text": "In conclusion, we propose a new deformable medical image registration method based on differential geometry and VoxelMorph CNN architecture. We compute the differential geometric information including the Jacobian determinant (JD) and the curl vector(CV) of diffeomorphic registration field and use them as channels of the model to train again. We get JD and CV from two sources, generated diffeomorphisms \u03c6 directly by original MR images and the registration filed \u03c6 in the first training stage, we test our method on two datasets including ADNI dataset and the results show our method VoxelMorph-deformation has better Dice and VoxelMorph-registration has better diffeomorphic registration fields than MIT's result. However, our method needs amounts of iterations and mathematical computation when generating JD and CV.\nWe also build a registration template for 7 testing samples according to average transformation method based on MRBrainS18 Challenge dataset, and obtain excellent improvement on medical image registration with non-negative Jacobian locations compared with MIT's VoxelMorph-diff. However, it also needs some iteration and computing resource which depends on the volume numbers of dataset. It may be useful to construct an enormous atlas dataset for medical registration. We believe the proposed method can advance the performance in medical image registration and clinical diagnosis."}]