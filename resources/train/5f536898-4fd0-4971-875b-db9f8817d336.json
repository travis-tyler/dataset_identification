[{"section_title": "Abstract", "text": "This paper presents DeepFLASH, a novel network with efficient training and inference for learning-based medical image registration. In contrast to existing approaches that learn spatial transformations from training data in the high dimensional imaging space, we develop a new registration network entirely in a low dimensional bandlimited space. This dramatically reduces the computational cost and memory footprint of an expensive training and inference. To achieve this goal, we first introduce complex-valued operations and representations of neural architectures that provide key components for learning-based registration models. We then construct an explicit loss function of transformation fields fully characterized in a bandlimited space with much fewer parameterizations. Experimental results show that our method is significantly faster than the stateof-the-art deep learning based image registration methods, while producing equally accurate alignment. We demonstrate our algorithm in two different applications of image registration: 2D synthetic data and 3D real brain magnetic resonance (MR) images. Our code is available at https://github.com/jw4hv/deepflash."}, {"section_title": "Introduction", "text": "Image registration has been widely used in medical image analysis, for instance, atlas-based image segmentation [2, 16] , anatomical shape analysis [20, 33] , and motion correction in dynamic imaging [18] . The problem of deformable image registration is typically formulated as an optimization, seeking for a nonlinear and dense (voxelwise) spatial transformation between images. In many applications, it is desirable that such transformations be diffeomorphisms, i.e., differentiable, bijective mappings with differentiable inverses. In this paper, we focus on diffeomorphic image registration highlighting with a set of critical features: (i) it captures large deformations that often occur in brain shape variations, lung motions, or fetal movements;\n(ii) the topology of objects in the image remain intact; and (iii) no non-differentiable artifacts, such as creases or sharp corners, are introduced. However, achieving an optimal solution of diffeomorphic image registration, especially for large-scale or high-resolution images (e.g., a 3D brain MRI scan with the size of 256 3 ), is computationally intensive and time-consuming.\nAttempts at speeding up diffeomorphic image registration have been made in recent works by improving numerical approximation schemes. For example, Ashburner and Friston [3] employ a Gauss-Newton method to accelerate the convergence of large deformation diffeomorphic metric mapping (LDDMM) algorithm [8] . Zhang et al. propose a low dimensional approximation of diffeomorphic transformations, resulting in fast computation of the gradients for iterative optimization [32, 27] . While these methods have led to substantial reductions in running time, such gradientbased optimization still takes minutes to finish. Instead of minimizing a complex registration energy function [8, 31] , an alternative approach has leveraged deep learning techniques to improve registration speed by building prediction models of transformation parameters. Such algorithms typically adopt convolutional neural networks (CNNs) to learn a mapping between pairwise images and associated spatial transformations in training dataset [28, 21, 7, 10, 9] . Registration of new testing images is then achieved rapidly by evaluating the learned mapping on given volumes. While the aforementioned deep learning approaches are able to fast predict the deformation parameters in testing, the training process is extremely slow and memory intensive due to the high dimensionality of deformation parameters in imaging space. In addition, enforcing the smoothness constraints of transformations when large deformation occurs is challenging in neural networks.\nTo address this issue, we propose a novel learning-based registration framework DeepFLASH in a low dimensional bandlimited space, where the diffeomorphic transformations are fully characterized with much fewer dimensions. Our work is inspired by a recent registration algorithm FLASH (Fourier-approximated Lie Algebras for Shoot-ing) [31] with the novelty of (i) developing a learning-based predictive model that further speeds up the current registration algorithms; (ii) defining a set of complex-valued operations (e.g., complex convolution, complex-valued rectifier, etc.) and complex-valued loss function of transformations entirely in a bandlimited space; and (iii) proving that our model can be easily implemented by a dualnetwork in the space of real-valued functions with a careful design of the network architecture. To the best of our knowledge, we are the first to introduce the low dimensional Fourier representations of diffeomorphic transformations to learning-based registration algorithms. In contrast to traditional methods that learn spatial transformations in a high dimensional imaging space, our method dramatically reduces the computational complexity of the training process where iterative computation of gradient terms are required. This greatly alleviates the problem of time-consuming and expensive training for deep learning based registration networks. Another major benefit of DeepFLASH is that the smoothness of diffeomorphic transformations is naturally preserved in the bandlimited space with low frequency components. Note that while we implement DeepFLASH in the context of convolutional neural network (CNN), it can be easily adapted to a variety of other neural networks, such as fully connected network (FCN), or recurrent neural network (RNN). We demonstrate the effectiveness of our model in both 2D synthetic and 3D real brain MRI data."}, {"section_title": "Background: Deformable Image Registration", "text": "In this section, we briefly review the fundamentals of deformable image registration in the setting of LDDMM algorithm with geodesic shooting [26, 29] . While this paper focuses on LDDMM, the theoretical tool developed in our model is widely applicable to various registration frameworks, for example, stationary velocity fields.\nConsider a source image S and a target image T as square-integrable functions defined on a torus domain \u2126 = R d /Z d (S(x), T (x) : \u2126 \u2192 R). The problem of diffeomorphic image registration is to find the shortest path (also known as geodesic) of diffeomorphic transformations 1] , such that the deformed image S \u2022 \u03c8 1 at time point t = 1 is similar to T . An explicit energy function of LDDMM with geodesic shooting is formulated as an image matching term plus a regularization term that guarantees the smoothness of the transformation fields\nwhere \u03b3 is a positive weight parameter, D denotes a Ja-cobian matrix, and Dist(\u00b7, \u00b7) is a distance function that measures the similarity between images. Commonly used distance metrics include sum-of-squared difference (L2norm) of image intensities [8] , normalized cross correlation (NCC) [4] , and mutual information (MI) [17] . The deformation \u03c6 is defined as an integral flow of the time-varying Eulerian velocity field v t that lies in the tangent space of diffeomorphisms V = T Diff(\u2126). Here L : V \u2192 V * is a symmetric, positive-definite differential operator that maps a tangent vector v \u2208 V into the dual space m \u2208 V * , with its inverse K : V * \u2192 V . The (\u00b7, \u00b7) denotes a paring of a momentum vector m \u2208 V * with a tangent vector v \u2208 V . The geodesic at the minimum of (1) is uniquely determined by integrating the geodesic constraint, a.k.a. Euler-Poincar\u00e9 differential equation (EPDiff) [1, 19] , which is computationally expensive in high dimensional image spaces. A recent model FLASH demonstrated that the entire optimization of LDDMM with geodesic shooting can be efficiently carried in a low dimensional bandlimited space with dramatic speed improvement [31] . This is based on the fact that the velocity fields do not develop high frequencies in the Fourier domain (as shown in Fig. 1 ). We briefly review the basic concepts below. Let Diff(\u2126) and\u1e7c denote the space of Fourier representations of diffeomorphisms and velocity fields respectively. Given time-dependent velocity field\u1e7d t \u2208\u1e7c , the diffeomorphism\u03c8 t \u2208 Diff(\u2126) in the finite-dimensional Fourier domain can be computed as\nwhere\u1ebd is the frequency of an identity element,D\u0169 t is a tensor productD \u2297\u0169 t , representing the Fourier frequencies of a Jacobian matrixD with central difference approximation, and * is a circular convolution with zero padding to avoid aliasing 1 .\nThe Fourier representation of the geodesic constraint (EPDiff) is defined as\nwhere is the truncated matrix-vector field autocorrelation. The operator\u2207\u00b7 is the discrete divergence of a vector field. HereK is a smoothing operator with its inverseL, which is the Fourier transform of a commonly used Laplacian operator (\u2212\u03b1\u2206 + I) c , with a positive weight parameter \u03b1 and a smoothness parameter c. The Fourier coefficients ofL is, i.e.,L(\u03be 1 , . . . ,"}, {"section_title": "Our Method: DeepFLASH", "text": "We introduce a learning-based registration network DeepFLASH in a low dimensional bandlimited space\u1e7c , with newly defined operators and functions in a complex vector space C n . Since the spatial transformations can be uniquely determined by an initial velocity\u1e7d 0 (as introduced in Eq. (3)), we naturally integrate this new parameterization in the architecture of DeepFLASH. To simplify the notation, we drop the time index of\u1e7d 0 in remaining sections.\nAnalogous to [28] , we use optimal registration results, denoted as\u1e7d opt , estimated by numerical optimization of the LDDMM algorithm as part of the training data. Our goal is then to predict an initial velocity\u1e7d pre from image patches of the moving and target images. Before introducing Deep-FLASH, we first define a set of complex-valued operations and functions that provide key components of the neural architecture.\nConsider a Q-dimensional complex-valued vector of input signalX and a real-valued kernel H, we have a complex-valued convolution as\nwhere R(\u00b7) denotes the real part of a complex-valued vector, and I (\u00b7) denotes an imaginary part. Following a recent work on complex networks [25] , we define a complex-valued activation function based on Rectified Linear Unit (ReLU). We apply real-valued ReLU separately on both of the real and imaginary part of a neuron\u1ef8 in the output layer, i.e.,"}, {"section_title": "Loss function", "text": "Let a labeled training dataset including pairwise images and their associated optimal initial velocity fields be {S n , T n ,\u1e7d opt n } N n=1 , where N is the number of pairwise images. We model a prediction function f (S n , T n ; W ) by using a convolutional neural network (CNN), with W being a real-valued weight matrix for convolutional layers. We then define a loss function as\nwhere \u03bb is a positive parameter balancing between function f and a regularity term Reg(\u00b7) on the weight matrix W . While we use L 2 norm as regularity in this paper, it is generic to other commonly used operators such as L 1 , or L 0 norm. The optimization problem of Eq. (6) is typically solved by using gradient-based methods. The weight matrix W is updated by moving in the direction of the loss functions steepest descent, found by its gradient \u2207 W ."}, {"section_title": "Network Architecture: Decoupled Complexvalued Network", "text": "While we are ready to design a complex-valued registration network based on CNN, the implementation of such network is not straightforward. Trabelsi et al. developed deep complex networks to specifically handle complexvalued inputs at the cost of computational efficiency [25] . In this section, we present an efficient way to decouple the proposed complex-valued registration network into a combination of regular real-valued networks. More specifically, we construct a dual-net that separates the real and imaginary part of complex-valued network in an equivalent manner.\nGiven the fact that the computation of real and imaginary parts in the convolution (Eq. (4)) and the activation function (Eq. (5)) are separable, we next show that the loss defined in Eq. (6) can be equivalently constructed by the real and imaginary part individually. To simplify the notation, we define the predicted initial velocity\u1e7d pre n \u2206 = f (S n , T n ; W ) and rewrite Eq. (6) as\nLet\u1e7d opt n = \u03b2 n + i\u00b5 n and\u1e7d pre n = \u03b4 n + i\u03b7 n in Eq. (7), we then obtain We train real and imaginary parts in two individual neural networks R net and I net . The optimization stays in a low dimensional bandlimited space without converting the coefficients (R(\u1e7d pre ), I (\u1e7d pre )) to high dimensional imaging domain back and forth. It is worthy to mention that our decoupled network is not constrained by any specific architecture. The CNN network in Fig. 2 can be easily replaced by a variety of the state-of-the-art models, e.g., U-net [22] , or fully connected neural network."}, {"section_title": "Computational complexity", "text": "It has been previously shown that the time complexity of convolutional layers [14] is O(\n, where p is the index of a convolutional layer and P denotes the number of convolutional layers. The b p\u22121 , b p h p are defined as the number of input channels, output channels and the kernel size of the p-th layer respectively. Here Z p is the output dimension of the p-th layer, i.e., Z p = 128 3 when the last layer predicts transformation fields for 3D images with the dimension of 128 3 .\nCurrent learning approaches for image registration have been performed in the original high dimensional image space [7, 28] . In contrast, our proposed model DeepFLASH significantly reduces the dimension of Z p into a low dimensional bandlimited space z p (where z p Z p ). This makes the training of traditional registration networks much more efficient in terms of both time and memory consumption."}, {"section_title": "Experimental Evaluation", "text": "We demonstrate the effectiveness of our model by training and testing on both 2D synthetic data and 3D real brain MRI scans."}, {"section_title": "Data", "text": "2D synthetic data. We first simulate 3000 \"bull-eye\" synthetic data (as shown in Fig 3) by manipulating the width a and height b of an ellipse equation, formulated as\nWe draw the parameter a, b randomly from a Gaussian distribution N (4, 2 2 ) for inner ellipse, and a, b \u223c N (13, 4 2 ) for outer ellipse. 3D brain MRI. We include 3200 public T1-weighted 3D brain MRI scans from Alzheimers Disease Neuroimaging Initiative (ADNI) [15] , Open Access Series of Imaging Studies (OASIS) [13] , Autism Brain Imaging Data Ex-change (ABIDE) [11] , and LONI Probabilistic Brain Atlas Individual Subject Data (LPBA40) [23] with 1000 subjects. Due to the difficulty of preserving the diffeomorphic property across individual subjects particularly with large age variations, we carefully evaluate images from subjects aged from 60 to 90. All MRIs were all pre-processed as 128\u00d7128\u00d7128, 1.25mm 3 isotropic voxels, and underwent skull-stripped, intensity normalized, bias field corrected and pre-aligned with affine transformation.\nTo further validate our model accuracy through segmentation labels, we use manually delineated anatomical structures in LPBA40 dataset. We randomly select 100 pairs of MR images with segmentation labels from LPBA40. We then carefully down-sampled all images and labels from the dimension of 181 \u00d7 217 \u00d7 181 to 128 \u00d7 128 \u00d7 128."}, {"section_title": "Experiments", "text": "To validate the registration performance of DeepFLASH on both 2D and 3D data, we run a recent state-of-the-art image registration algorithm FLASH [30, 32] on 1000 2D synthetic data and 2000 pairs of 3D MR images to optimal solutions, which are used as ground truth. We then randomly choose 500 pairs of 2D data and 1000 pairs of 3D MRIs from the rest of the data as testing cases. We set registration parameter \u03b1 = 3, c = 6 for the operator\u02dc , the number of time steps for Euler integration in geodesic shooting as 10.\nWe adopt the band-limited dimension of the initial velocity field\u1e7d opt as 16, which has been shown to produce comparable registration accuracy [30] . We set the batch size as 64 with learning rate \u03b7 = 1e \u2212 4 for network training, then run 2000 epochs for 2D synthetic training and 5000 epochs for 3D brain training.\nNext, we compare our 2D prediction with registration performed in full-spatial domain. For 3D testing, we compare our method with three baseline algorithms, including FLASH [31] (a fast optimization-based image registration method), Voxelmorph [6] (an unsupervised registration in image space) and Quicksilver [28] (a supervised method that predicts transformations in a momentum space). We also compare the registration time of DeepFLASH with traditional optimization-based methods, such as vector momenta LDDMM (VM-LDDMM) [24] , and symmetric diffeomorphic image registration with cross-correlation (SyN) from ANTs [5] . For fair comparison, we train all baseline algorithms on the same dataset and report their best performance from published source codes (e.g., https://github.com/rkwitt/quicksilver, https://github.com/balakg/voxelmorph).\nTo better validate the transformations generated by DeepFLASH, we perform registration-based segmentation and examine the resulting segmentation accuracy over eight brain structures, including Putamen (Puta), Cerebellum (Cer), Caudate (Caud), Hippocampus (Hipp), Insular cor-tex (Cor), Cuneus (Cune), brain stem (Stem) and superior frontal gyrus (Gyrus). We evaluate a volume-overlapping similarity measurement, also known as S\u00f8rensen\u2212Dice coefficient, between the propagated segmentation and the manual segmentation [12] .\nWe demonstrate the efficiency of our model by comparing quantitative time and GPU memory consumption across all methods. All optimal solutions for training data are generated on an i7, 9700K CPU with 32 GB internal memory. The training and prediction procedure of all learning-based methods are performed on Nvidia GTX 1080Ti GPUs. Fig.3 visualizes the deformed images, transformation fields, and the determinant of Jacobian (DetJac) of transformations estimated by DeepFLASH and a registration method that performed in full-spatial image domain. Note that the value of DetJac indicates how volume changes, for instance, there is no volume change when DetJac = 1, while volume shrinks when DetJac < 1 and expands when DetJac > 1. The value of DetJac smaller than zero indicates an artifact or singularity in the transformation field, i.e., a failure to preserve the diffeomorphic property when the effect of folding occurs. Both methods show similar patterns of volume changes over transformation fields. Our predicted results are fairly close to the estimates from registration algorithms in full spatial domain. Fig.4 visualizes the deformed images and the determinant of Jacobian with pairwise registration on 3D brain MRIs for all methods. It demonstrates that our method DeepFLASH is able to produce comparable registration results with little to no loss of the accuracy. In addition, our method gracefully guarantees the smoothness of transformation fields without artifacts and singularities."}, {"section_title": "Results", "text": "The left panel of Fig.5 displays an example of the comparison between the manually labeled segmentation and propagated segmentation deformed by transformation field estimated from our algorithm. It clearly shows that our generated segmentations align fairly well with the manual delineations. The right panel of Fig.5 compares quantitative results of the average dice for all methods, with the observations that our method slightly outperforms the baseline algorithms. Fig. 6 reports the statistics of dice scores (mean and variance) of all methods over eight brain structures from 100 registration pairs. Our method DeepFLASH produces comparable dice scores with significantly fast training of the neural networks. Figure 6 . Dice score evaluation by propagating the deformation field to the segmentation labels for four methods on eight brain structures (Putamen(Puta), Cerebellum (Cer), Caudate (Caud), Hippocampus (Hipp), Insular cortex (Cor), Cuneus (Cune), brain stem (Stem), and superior frontal gyrus (Gyrus)). and testing."}, {"section_title": "Conclusion", "text": "In this paper, we present a novel diffeomorphic image registration network with efficient training process and inference. In contrast to traditional learning-based registration methods that are defined in the high dimensional imaging space, our model is fully developed in a low dimensional bandlimited space with the diffeomorphic property of transformation fields well preserved. Based on the fact that current networks are majorly designed in real-valued spaces, we are the first to develop a decoupled-network to solve the complex-valued optimization with the support of rigorous math foundations. Our model substantially lowers the computational complexity of the neural network and significantly reduces the time consumption on both training and testing, while preserving a comparable registration accuracy. The theoretical tools developed in our work is flexible/generic to a wide variety of the state-of-the-art networks, e.g., FCN, or RNN. To the best of our knowledge, we are the first to characterize the diffeomorphic deformations in Fourier space via network learning. This work also paves a way for further speeding up unsupervised learning for registration models. 1 "}, {"section_title": "DeepFLASH", "text": "VoxelMorph Quicksilver Figure 7 . Comparison of average GPU memory usage on our method and learning-based baselines for both training and testing processes. "}]