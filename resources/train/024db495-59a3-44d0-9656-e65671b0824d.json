[{"section_title": "Abstract", "text": "Diffeomorphic image registration algorithms are widely used in medical imaging, and require optimization of a highdimensional nonlinear objective function. The function being optimized has many characteristics that are relevant for optimization but are typically not well understood. Due to that complexity, most authors have used a simple gradient descent, but it is not often discussed how step sizes are chosen or if line searches are used. Further, if a system is to be robust to a range of input images, that may differ to varying degrees, the optimization must be adaptable. Here, we present two methods of adaptable gradient descent with line searches, and test how they affect image registration. The optimization schemes are deployed for geodesic shooting in diffeomorphisms -an approach that is used to quantify anatomical changes, such as atrophy, in longitudinal image pairs. We evaluate the optimization schemes on their convergence characteristics and based on how well the resulting atrophy scores correlate with diagnostic group and mini mental state exam (MMSE) scores. We find that the Barzilai-Borwein method with a backtracking line search outperforms other optimization schemes in convergence time and adaptability by a wide margin. We also find that the variable optimization schemes do not significantly affect the ability to measure atrophy with clinical significance."}, {"section_title": "INTRODUCTION", "text": "The LDDMM (large deformation diffeomorphic metric mapping) framework for diffeomorphic image registration is described in significant procedural detail in the seminal paper by Beg et al. [1] . LDDMM proposes encoding the shape difference evident in two images of the same anatomy as a point on a manifold of diffeomorphisms. The objective of the algorithm is to construct a path on that manifold beginning at the identity and ending at the diffeomorphism that optimally matches the two images; Beg et al. show that at optimality the path is a geodesic. In the geodesic shooting formulation, the path is parameterized by an initial momentum vector field, from which the entire geodesic can be reconstructed by integrating the appropriate Euler-Poincar\u00e9 differential equation (EPdiff) [2, 3, 4, 5, 6] . Also, Miller et al. [2] show that at optimality, the initial momentum vector field is proportional to the spatial gradient of the moving image. Hence, the objective of geodesic shooting in diffeomorphisms (GSiD) is to find a scalar momentum field that parameterizes an optimal matching between the given images.\nAn implementation of GSiD can be viewed as having three mathematical components: (1) construction of the model itself, which can include decisions about representation [6] and selection of parameters that dictate properties of the space of diffeomorphisms [7] , (2) numerical integration of differential equations [3] , and (3) an optimization procedure for the initial momentum field. The majority of work in the field has been in areas (1) and (2), with substantially less attention to paid to (3) . With the exception of [5] , most studies report using gradient descent with some step size , though details of the procedure including the determination of , are typically omitted. Very little information relevant to optimization is known about the GSiD objective function, such as its smoothness and curvature characteristics. Further, it is not known how variable these characteristics are to different inputs. Nonetheless, to build a GSiD system robust to variable inputs, some optimization procedure must be selected.\nWe consider here gradient descent with three different procedures to determine the step size : (1) a static step size, (2) a secant method line search, and (3) the Barzilai-Borwein method [8] . Methods (2) and (3) compute the step size at every iteration using limited local curvature data estimated from the objective function; hence, is adaptable to the inputs and the particular iteration of the optimization."}, {"section_title": "METHODS", "text": ""}, {"section_title": "GSiD", "text": "A complete discussion of the GSiD model is beyond the scope of this paper; for a thorough discussion of the following equations see [3] . For a moving image I and fixed image J, the GSiD objective function is:\nwhich must be minimized with respect to the initial scalar momentum field P 0 . A given initial momentum provides the initial conditions for the EPdiff equation(s), which govern the time evolution of the momentum and moving image:\nThe third equation states the relationship between momentum and velocity, where K plays the role of an inertia; K is a smoothing kernel and K(w) is taken to mean the convolution of vector field w with K. The path of diffeomorphisms \u03c6 t is constructed from v(x, t) according to the ODE:\nThis yields the geodesic path of diffeomorphisms \u03c6 t , where the end point \u03c6 1 is used to match I and J. The matching residual\n1 , which resides in the coordinate system of J, must be brought back to the coordinate system of I while respecting the geodesicity of the whole path \u03c6 t . This is done by integrating the adjoint system backwards in time with initial conditions\u00ce\nP 0 completes the gradient of equation (1) with respect to P 0 . In a gradient descent scheme, that gradient is used to update P 0 :\nis one of the few user selected parameters in the GSiD model. A poor selection of can result in intractable compute times (if the user insists on running to convergence), subconvergent results (if the optimization is stopped early due to time considerations), or numerical instability and divergence (if is too large). We are concerned in particular with the application of GSiD to longitudinal MRI time series of the brain to quantify atrophy. In that application, deformations are typically very low amplitude even relative to the spatial resolution of the images. Despite that, atrophy of as little as 5% in critical brain areas can have a significant impact on quality of life [9] . Hence, it is crucial to measure longitudinal deformations with the highest degrees of accuracy and precision possible. In such a case, the selection of can be critical to ensuring accurate and unbiased measurements."}, {"section_title": "Adaptable gradient descent steps", "text": "The simplest option is to select a priori a static value for which is fixed throughout the optimization. This value may perform well for some instances of data, and poorly for others. Even for a fixed input, it may perform well for a subset of iterations and poorly for others. We include this option as a baseline for comparison with more intelligent choices. The secant line search method: Suppose we would like to optimize a function f (x) by gradient descent. Then, for iteration k, we would like to minimize f (x k \u2212 k f (x k )) with respect to k . Take the truncated Taylor expansion (we temporarily omit the subscript k):\nIf used directly, the second-order term will require the Hessian matrix of f . GSiD is a very high-dimensional optimization, hence the Hessian matrix f is intractable. We can replace the second-order term in the Taylor expansion with a finite difference approximation on the gradients:\nSubstitute (7) into (6), apply the remaining partial derivative, and further differentiate each side with respect to . You will arrive at the expression:\nFinally, we set this equal to zero and solve for . Also, to use this formula for GSiD we must account for the metric in the space of momenta; the inner products must include the operator K. With these two final steps we arrive at the formula:\nWhere f k = f (x k ). Essentially, the secant method approximates the objective function in the gradient direction as a parabola, the curvature of which is estimated by formula (7).\nBecause the function may not be well estimated locally as a parabola, for a given gradient descent iteration k, formula (8) is applied iteratively giving a series of steps k , which leverages every gradient computation efficiently. \u03c3 0 k is set to a default value. This line search is stopped after a certain number of fixed iterations or when the magnitude of the update f k falls below a threshold. Note, though we must evaluate multiple gradients during the line search iterations, we only move in the direction f k until the line search is stopped and we move to gradient descent iteration k + 1. The Barzilai-Borwein method: We derive the method assuming\nThe gradient is then f = Ax \u2212 b and the Hessian is f = A. Newton's method, a second-order optimization that accounts for the curvature of the objective function, proceeds as x k+1 = x k \u2212 A \u22121 f k . (For a symmetric positive definite quadratic form, this will converge in a single step and is equivalent to Gaussian elimination). The objective of the Barzilai-Borwein (BB) method is to let be determined by the simplest possible approximation to Newton's method:\nFor the quadratic form, A satisfies As k = y k . So, we will let be the solution to the least squares problem:\nwhich has the closed-form solution:\nAgain, to apply this to GSiD we must account for the metric in the space of momenta:\nSimilar to the secant method, the BB method approximates second-order information, but it does not require a second gradient computation. Even so, in some places formula (9) is likely to be a very poor approximation. It is well known that as a result, BB step sizes do not provide monotonic optimization; that is, occasionally k is too large. However, for nonlinear optimization, some degree of nonmonotonicity may be desired as it may help escape spurious local minima. Hence, the BB method is often coupled with a backtracking line search [10] . In our case, k is iteratively cut in half until the first Wolfe condition is satisfied:\nwhere max (k\u2212M,0) \u2264 j \u2264 k. M controls the degree of monotonicity (we use M = 10) and \u03b3 is related to our expectation of the objective function's local curvature. \u03b3 is typically chosen to be small (we use \u03b3 = 10 \u22124 ). Fig. 1 . Region of interest with significant atrophy in AD, used here to compute atrophy scores"}, {"section_title": "EXPERIMENTAL RESULTS", "text": "We took 100 randomly chosen subjects from the ADNI-2 longitudinal MRI dataset -available at adni.loni.usc.edu -and registered their baseline scans to their 24-month follow-up scans using GSiD. We did these registrations under 5 different experimental conditions: static step sizes of 0.001, 0.01, and 0.1, the secant method with 0 k = 0.01, and the BB method with 0 = 0.01. For all approaches, the optimization was stopped when the gradient magnitude (relative to the initial gradient magnitude) fell below a chosen threshold, or after 300 iterations, whichever came first. Before GSiD, the images were preprocessed according to the protocol detailed in [11, 12] .\nAfter GSiD, the Jacobian determinants of the deformations mapping the baseline to the 24 month followup images were moved to a common coordinate system. The Jacobian determinants were averaged in a region where the rate of atrophy is significantly associated with Alzheimer's Disease (AD), a stat-ROI, (Fig. 1) to produce a scalar value atrophy score that represents the percent volume loss within the region for each subject [9] . The region was constructed from a non-overlapping data set from that evaluated here. Figures 2 and 3 show convergence characteristics of the five optimizations strategies. Contrary to equation (1), we did not use sum of squared differences to drive the registration. We used the squared Local Correlation Coefficient (LCC) which is also used in [13] ; LCC increases as the images become better matched. Curves that do not extend the full 300 iterations are instances that stopped early due to the gradient magnitude stopping criterion. The largest static step size clearly causes oscillations in all instances. The smallest static step size did not permit any instances to complete be-fore reaching 300 iterations, it is likely that many instances are sub-convergent. The middle static step size appears to be a good compromise, but for many instances, the gradient magnitude oscillates. Apparently, none of the static step sizes is appropriate for all instances of the data or through all iterations of the optimization. The secant and BB methods show better convergence characteristics, with more instances finishing early. However, for the secant method not all instances converged. The spikes in the gradient magnitude for the BB method are due to the nonmonotonicity discussed above.\nA good first question to ask is whether the choice of optimization procedure had a significant impact on atrophy scores. Figure 4 shows the p-values from paired t-tests between the measured atrophy scores for all pairs of optimization approaches. All five optimization procedures produced atrophy measurements that were significantly different from the others. Figure 3 also shows the average number of iterations and the number of instances that failed to converge due to numerical instability. In practice, the failed instances would have to be rerun with the parameters adjusted by hand. The BB method clearly had the fastest convergence, and was sufficiently adaptable that no instances failed to converge.\nAtrophy measurements such as these have been shown to correlate with diagnostic category and performance on cognitive tests. The data set included subjects from four diagnostic categories: healthy controls (HC), early mild cognitive impairment (eMCI), late mild cognitive impairment (lMCI), and Alzheimer's disease (AD). Each subject also had a mini mental state exam (MMSE) administered at the 24 month follow up time point. The MMSE scores from 0 -30, where scores Figure  4 also shows Pearson's correlation coefficients between atrophy scores and diagnostic group and also between atrophy scores and MMSE scores for each of the five optimization approaches. The correlations appear sufficiently similar across optimization approaches to suggest that faster or more adaptable optimization approaches do not compromise the ability to measure clinically meaningful atrophy."}, {"section_title": "ACKNOWLEDGEMENTS", "text": "The authors would like to thank Dr. Christian Clason for a helpful discussion on nonlinear optimization. This work was supported, in part, by NIH grant U54 EB020403 to the ENIGMA Center for Worldwide Medicine, Imaging Genomics."}]