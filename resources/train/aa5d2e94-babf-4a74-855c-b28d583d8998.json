[{"section_title": "Abstract", "text": "Groupwise registration has become more and more popular due to its attractiveness for unbiased analysis of population data. One of the most popular approaches for groupwise registration is to iteratively calculate the group mean image and then register all subject images towards the latest estimated group mean image. However, its performance might be undermined by the fuzzy mean image estimated in the very beginning of groupwise registration procedure, because all subject images are far from being well-aligned at that moment. In this paper, we first point out the significance of always keeping the group mean image sharp and clear throughout the entire groupwise registration procedure, which is intuitively important but has not been explored in the literature yet. To achieve this, we resort to developing the robust mean-image estimator by the adaptive weighting strategy, where the weights are adaptive across not only the individual subject images but also all spatial locations in the image domain. On the other hand, we notice that some subjects might have large anatomical variations from the group mean image, which challenges most of the state-of-the-art registration algorithms. To ensure good registration results in each iteration, we explore the manifold of subject images and build a minimal spanning tree (MST) with the group mean image as the root of the MST. Therefore, each subject image is only registered to its parent node often with similar shapes, and its overall transformation to the group mean image space is obtained by concatenating all deformations along the paths connecting itself to the root of the MST (the group mean image). As a result, all the subjects will be well aligned to the group mean image adaptively. Our method has been evaluated in both real and simulated datasets. In all experiments, our method outperforms the conventional algorithm which generally produces a fuzzy group mean image throughout the entire groupwise registration."}, {"section_title": "Introduction", "text": "Groupwise registration has become more and more popular in recent years due to its attractiveness for unbiased analysis of population data (Crum et al., 2004; Maintz and Viergever, 1998; Zitov\u00e1 and Flusser, 2003) . Compared to the pairwise registration, groupwise registration can simultaneously estimate the transformation fields for all subjects without explicitly specifying an individual subject as a template, thus avoiding any possible bias (introduced by template selection) in the subsequent data analysis.\nOne of the most popular groupwise registrations was proposed by Joshi et al. (Joshi et al., 2004) in 2004. In their method, the groupwise registration is implemented by iteratively constructing the group mean image and estimating the transformation fields of all subjects towards the estimated tentative group mean image. However, this method has several limitations. One major drawback of this method is that it equally treats all subjects during the construction of the group mean image, which can be very fuzzy especially in the beginning of groupwise registration, since all subjects at that moment are not well aligned. As a result, the fuzzy group mean image fails to provide clear guidance to the subsequent pairwise registrations and leads to 1) the loss of anatomical details which can be hardly recovered from the initial fuzzy group mean image; 2) the degradation of the alignment in each round of groupwise registration due to the difficulty of establishing reliable correspondences between sharp subject images and the fuzzy group mean image during the iterative registration procedure; and 3) the slow convergence of the groupwise registration due to the lack of clear and consistent information from the fuzzy group mean image to guide the registration.\nSeveral follow-up papers (Fletcher et al., 2009; Ma et al., 2008) have been published recently. To be robust with the outlier subjects, Fletcher et al. (Fletcher et al., 2009 ) extended Joshi's method to the Riemannian manifold and proposed to use the geometric median of the group to handle the possible outliers that may deviate the Fr\u00e9chet mean far away from the real population center. Rather than averaging on image intensity, Ma et al. (Ma et al., 2008) proposed a Bayesian-based approach to estimate the atlas by iteratively deforming an initial guess to the center of the population. In this way, the final atlas is sharp but at the expense of the bias in choosing an individual subject as the start point.\nGenerally, these methods still used an equal weight for all subjects to build the group mean image. Also, their goal is the robust estimation of the group mean image, not the groupwise registration.\nHowever, the importance of keeping the sharpness of the group mean image during the groupwise registration is still not addressed.\nAnother limitation of the conventional groupwise registration method lies in the pairwise registrations used in each round of groupwise registration, used to align each subject to the latest estimated group mean image. As well known, good pairwise registration helps estimate the clear group mean image which can be used to better guide the next round of groupwise registration. However, in case of large inter-subject variations, it is difficult to register two faraway subjects with different anatomical structures (Hamm et al., 2009; Tang et al., 2009) . In light of this, several methods have been proposed to improve the registration. For example, Tang et al. (Kim et al., 2010; Tang et al., 2009) proposed to generate an intermediate template sufficiently similar to each subject for improving the registration.\nSince the deformation from the template to any intermediate template is pre-known in the training stage, the final registration can be completed by compositing the deformation from the template to the intermediate template with the deformation from the intermediate template to the subject under registration.\nIn addition, Hamm (Hamm et al., 2009 ) presented the tree-based method for groupwise registration. In their method, the pseudo-geodesic median image is selected as the root template after learning the intrinsic manifold of the whole data set. Since a fixed image (i.e., the root image) is used as the final template to register all other subjects, the bias is inevitably introduced in this scenario due to the possible discrepancy between the selected template and the real population center. However, this method benefits from the tree-based organization of images for registration. Specifically, since the subjects are organized in the tree-based hierarchy by considering each subject image as the node, any pair of neighboring images in the tree is similar to each other. Therefore, even for the subject having large anatomical differences from the root subject, it can be still well-aligned through the registration path from its node to the root.\nThe goal of this paper is to outline the limitations of the conventional groupwise registration (Joshi et al., 2004) and then propose solutions to improve its performance. Specifically, we will first point out the importance of always keeping a sharp group mean image during the groupwise registration. To achieve the sharp group mean image without introducing bias, we generalize the conventional groupwise registration method by defining a new objective function. Specifically, we treat each subject adaptively throughout the registration. Only the registered subjects that are close enough to the tentatively-estimated group mean image will be involved in updating the group mean image, since equally treating the subjects in the early stage will lead to the irreversible loss of structural details especially when most subjects are not well aligned in the beginning. As the registration progresses, subjects are more likely to agglomerate to the population center. Then, more subjects will be allowed to participate into the construction of the group mean image and their contributions will gradually become similar to others. Working under this scenario, the group mean image in our method will gradually approach to the population center, as will be shown by our experimental results on simulated dataset.\nThe other contribution of this paper is that we improve the registration accuracy of each subject to the group mean image by a tree-based registration. In our method, we do not assume small anatomical differences between individual brain images. As mentioned above, registering two subjects with large differences usually challenges the state-of-the-art registration algorithms, and the bad registration results will undermine the sharpness of the group mean image. We resort to employing a tree-based hierarchical registration method (Hamm et al., 2009; Jia et al., 2010b) to register each subject to the latest estimated group mean image. Specifically, considering each subject as a node in the tree, we can set the sharp group mean image, instead of any individual subject, as the root of the minimal spanning tree (built upon the image distances of each possible pair of subjects). The benefit of using the treebased registration is that the registration accuracy can be greatly improved, since each subject will be registered only to its nearby subject (with similar anatomy) and its complete registration to the group mean image can be estimated by compositing all deformation fields along its path to the group mean image (the root of tree).\nIn our previous work, we proposed a robust groupwise registration method, called ABSORB, in (Jia et al., 2010a) . To overcome the limitation of fuzzy group mean in the conventional method (Joshi et al., 2004) , ABSORB perform the registration in the conservative way: each subject will only deform w.r.t.\nits neighboring subjects within a learned image manifold. The advantage is that the global structure, or the distribution of subject images in their intrinsic high-dimensional space, is always preserved during the groupwise registration procedure. However, the computation time is much longer than the conventional method. In this paper, we attack the problem of fuzzy mean image in a different way where we replace the fuzzy group mean image with the sharp one to deterministically guide the registration. Therefore, we are able to achieve much faster groupwise registration than ABSORB and even with better registration performance as will be shown in the experimental results.\nIn experiments, we demonstrate the advantage of our method by integrating with the Diffeomorphic Demons registration algorithm (Vercauteren et al., 2009) , and also compare its performance with the tree-based registration method (Hamm et al., 2009) , the conventional groupwise registration method, and ABSORB (Jia et al., 2010a) . Extensive experiments on 16 NIREP Data (Christensen et al., 2006) and 40 LONI LPBA40 data show that our proposed method outperforms the tree-based method, the conventional groupwise registration method, and ABSORB in terms of both registration accuracy and consistency.\nIn the following, we will present our improved method for groupwise registration in Section 2. After that, our proposed method will be intensively evaluated and further compared with other three groupwise registration methods in Section 3. We conclude in Section 4."}, {"section_title": "Method", "text": "In the framework of unbiased groupwise registration (Joshi et al., 2004) , the deformation fields are estimated by iteratively registering N subjects to the latest estimated group mean image. In the t-th round of registration (t=1,\u2026,T), the group mean image is generated by averaging upon the intensity of the current warped subjects = ( )| ( ) = 0 , = 1, \u2026 , , = 1, \u2026 , , \u2208 \u211b 3 w.r.t.\nthe current estimated transformation fields = | = 1, \u2026 , , = 1, \u2026 , . Each is calculated by considering \u22121 as the template and 0 (affine aligned subject) as the moving images. It is worth noting that 0 are only the initial affine transformations. Fig. 1 illustrates the framework of the conventional unbiased groupwise registration (Joshi et al., 2004) .\nThe dashed arrows denote the pairwise registrations in each round of registration, which are used to deform each subject to the common space of the current group mean image. The solid arrows indicate the evolution of the group mean image with the progress of registration, where the group mean image gradually marches from a gray rectangle (in the first round of groupwise registration) to a final pink circle (in the later round of groupwise registration), as shown in Fig. 1 . Here, the red star denotes the real population center. The convergence of this groupwise registration is guaranteed according to the convexity of the distance function (Joshi et al., 2004) . However, this algorithm is not robust to the outlier subjects (i.e., less registered subjects, especially in the beginning of groupwise registration), although its finally estimated group mean image (the pink circle) might be close to the real population center. We will explain this clearly in the following.\nIn the conventional groupwise registration (Joshi et al., 2004) , the problem of estimating the group mean image is formulated as a statistical estimation problem:\nwhere the term , is the distance between the identity transformation and (Avants and Gee, 2004; Miller, 2004; Miller et al., 2002; Vercauteren et al., 2009) . By fixing the transformation field , the estimation of the group mean image is obtained as\n, which is the simple average of the warped images according to the current-estimated deformations. It is obvious that this kind of method assumes only one center in the population. The work dealing with multiple centers can be found in (Blezek and Miller, 2007; Sabuncu et al., 2009; Wang et al., 2010) .\nAs pointed in (Fletcher et al., 2009) , the major drawback of this method is the poor robustness to the outliers because the contributions (or the weights) are the same for not only all subjects in the population, but also all voxels in each subject. Therefore, even single outlier image will dramatically mislead the estimation and lead to the fuzzy group mean image. In the following, we will first point out in Section 2.1 the importance of always keeping the sharpness of the group mean image throughout the entire groupwise registration procedure. Then, we will propose an improved objective function in Section 2.2, and optimize it in Section 2.3. Finally, we will summarize our proposed groupwise registration method in Section 2.4."}, {"section_title": "Importance of Always Keeping Sharpness of the Group Mean Image during Registration", "text": "Unbiased groupwise registration method (Joshi et al., 2004) seeks to iteratively estimate the group mean image and register each subject to the tentative group mean image. However, the initial group\n, generated right after the linear alignment, is generally very fuzzy, since the subjects 0 are not well aligned in the beginning of registration. According to our knowledge, few articles have addressed the importance of keeping the sharpness of the group mean image during the registration. Indeed, the fuzzy group mean image would undermine the groupwise registration performance in two ways: 1) it is difficult to register an individual subject with clear anatomical structures to the group mean image with fuzzy structures; 2) a fuzzy group mean image will challenge the convergence of optimization since it might not provide sufficient anatomical information to guide the registration. The importance of the sharp group mean image in groupwise registration is demonstrated in Fig. 2 by 61 toy images, which are distributed in three branches. Each branch (with 20 images) is generated from the same base image with a red box in Fig. 2 (a) , to represent one type of cortical folding. For clarity, only three images (i.e., 1 st , 10 th , and 20 th ) in each branch are shown as examples. Before registration, the group mean image is very blurry (as shown in Fig. 2(b) ). If the groupwise registration starts from this fuzzy group mean image, it will result in an unsatisfactory group mean image (as shown in Fig. 2(b) ), since the fuzzy group mean image is not able to informatively guide the groupwise registration of individual images.\nThis toy example shows the importance of always keeping the sharpness of the group mean image during the groupwise registration. The fundamental reason why the conventional method fails is illustrated in Fig. 3 . For easy explanation, we project all 61 images in Fig where the warped subjects are not close to each other and also far away from the real population center.\nInstead of equally weighting all subjects, we propose to adaptively weight subjects based on their distances to the latest estimated group mean image. In the above example (Fig. 3) , the distance metric between two images is the sum of squared differences on image intensity. Our idea has been demonstrated through Fig. 3 (d)-(f). Specifically, given an estimated group mean image \u22121 from the previous round of registration, the contribution of each subject in constructing a new group mean image should be dynamically determined according to its tentative warping result \u22121 . For each warped subject \u22121 , the closer of its distance to \u22121 is, the larger weight it should have to contribute in the construction of . To estimate , adaptive weightings for all subjects can be determined based on the distances of those warped subjects to the previous group mean image \u22121 . However, the way on how to obtain 0 in the first round of registration is still unclear. Since we do not have much knowledge on the population center in the beginning, we first select the median image among 0 as the 0 by performing the following operations:\nwhere is the distance measurement between two images. Although the advanced geodesic distance can be used here, we turn to use the Euclidian distance due to its simplicity. It is clear that has the minimum sum of distances to all other subjects. Setting 0 as the median image has the advantage of closeness to the population center. Therefore, we use as the reference image to calculate the weight for each 0 in the first round of groupwise registration according to , 0 . Fig image is more reasonable and much clearer than that by the conventional method, and importantly all subjects have agglomerated very closely to the real population center. In the following section, we will detail our algorithm for achieving the sharp group mean image and improving the overall registration performance."}, {"section_title": "Objective Function of Our Groupwise Registration", "text": "As demonstrated in Section 2.1, different subjects should have different dynamic weights, instead of equal and fixed weights, during the groupwise registration. On the other hand, each anatomical region in each subject may have its own difference from the respective region in the group mean image.\nTherefore, applying the same weight (generally obtained from the entire subject) to all anatomical regions of the same subject may lead to different fuzziness across different regions of the group mean image. To mathematically formulate these problems and solve them together, we propose two strategies below.\nFirst, we propose a distance measurement for each voxel w.r.t. the current group mean image and the warped subject image as:\nwhere denotes a local image patch centered at voxel , with the neighborhood size . The term measures the overall intensity difference between the corresponding local image patches (centered at )\nin the images and , by visiting all voxels in the neighborhood ( ). Although other advanced geodesic distance (defined in the manifold) can be employed, the simple intensity difference is used here for easy computation. On the other hand, recall that = 0 , thus the distance measurement in our method is also the function of transformation field , albeit implicit. It is worth noting that approaches to the image distance between two entire images when is large enough, while becomes voxel-wise difference in Eq. 3 when converges to 1. Since the registration results are usually refined from global shape to local shape, the value of is large in the initial round of registration and then gradually decreases with the progress of registration. We will describe the way to dynamically change the size of in Eq. 8 of Section 2.3.\nSecond, to treat each subject differently, we introduce a hidden variable ( . . =1 = 1, \u2200 \u2208 3 ) to indicate the contribution of each warped subject in the construction of the group mean image at a particular voxel . In the initial rounds of registration, all subjects are not well aligned (especially right after affine registration). If we equally weight all subjects (i.e., the entropy of the weighting set | = 1, \u2026 , is high), it will lead to a fuzzy mean image as demonstrated in Fig.   2 . To keep the sharp group mean image throughout registration, only those warped subjects that are close enough to the currently estimated group mean image \u22121 are qualified to have large weights , while other subjects are penalized with small weights . With the progress of registration, all subjects will likely agglomerate to the population center. At that moment, all s, as long as they are close enough to the group mean image, will contribute almost equally to the construction of the group mean image, thus providing opportunity to estimate an unbiased group mean image. Since all subjects are already well aligned, very little fuzziness will be introduced to the group mean image. In this paper, the dynamic changes of weights | = 1, \u2026 , from strictly binary to loosely uniform are controlled by requiring the entropy of the weighting set | = 1, \u2026 , to increase with the progress of registration.\nBy replacing the distance measurement with Eq. 3 and adding the dynamic control of weights of subjects to the objective function, we arrive at a new objective function for groupwise registration as:\nwhere the scalar controls the penalty of large distance from to . is used to balance the strength of regularization in the objective function. Compared with the objective function in the conventional method (Eq. 1), our formulation generalizes the objective function in (Joshi et al., 2004) by introducing the adaptive weights for not only each subject but also each spatial location in the common space. We will show its important role when explaining the solution to Eq. 4 in Section 2.3."}, {"section_title": "Optimization Scheme", "text": "It is non-trivial to simultaneously optimize in Eq. 4 with many parameters. Instead, we resort to decoupling it with two sub-problems, i.e., alternatively (Sub-Problem 1, SP 1 ) estimate the group mean image and (Sub-Problem 2, SP 2 ) estimate the transformation fields for all subjects. First, given the warping results \u22121 (w.r.t. \u22121 ) in the last round of registration, compute the optimal . Then the mean image in the current round can be estimated according to . Second, using \u22121 as the initialization, we employ the pairwise registration algorithm (e.g., Diffeomorphic Demons (Vercauteren et al., 2009) \nThe optimal solution to in Eq. 5 can be immediately calculated by setting 1 = 0.\nAfter removing the constant, the estimation of weight on each voxel is given as:\nwhere at location is highly related with two parameters: the temperature and the neighborhood size . Here the parameter is used to control the fuzzyness of the mean image, acting as the inverse temperature in the annealing system based on our observations in Section 2.1. Initially, the degree of is low, i.e., the contribution of particular subject in constructing the group mean image will decrease in the exponential way unless it is very close to the current group mean image. This strategy is used to keep the group mean image sharp. With the progress of groupwise registration, all subjects become closer to the population center; at that time, the temperature will be increased to encourage equal weighting of all warped subjects . Given the overall number of iterations , the temperature in theth round is determined as:\nwhere 0 is the initial temperature and \u2206 denotes the step length of temperature increase. In all of our experiments, we set 0 = 1 and \u2206 = max 0 , , where is the median image among 0 .\nTo cater for the possible misalignment, especially in the initial rounds of groupwise registration, we use the neighborhood size to adaptively control the scale, i.e., from global to local, in measuring the image similarity. Therefore, the weight used for averaging warped images is different across not only the subjects but also spatial locations in the group mean image space. The value of in the -th round of registration is given as:\nwhere 0 is the whole image size. When the iteration increases to , = 1 and in Eq. 3 becomes the voxelwise intensity difference.\nAfter determining the weight for each subject at each location by Eq. 6, the calculation of the group mean image ( ) at each location is straightforward by setting 1 = 0 (with the derivation given in the Appendix I):\nwhere is the total number of pixels in the local image patch . It is clear that (1) the group mean image is the weighted average of all currently registered subjects in the common space; (2) the weight is adaptive to each subject according to its contribution calculated in Eq. 6; (3) the weight is also locally adaptive since the is computed from the local patch discrepancy.\nIt is worth noting that 1 in the first round of registration is the equally weighted average of affine aligned subjects in the conventional groupwise registration (Joshi et al., 2004) , which could be very fuzzy (see Fig. 2 (b) ). In our method, however, 1 is the weighed mean image of all warped subjects, where the weights are calculated by taking the median image as the reference. Moreover, no bias is introduced to our method for the following reasons: 1) is only used as the reference to calculate the contribution of each subject, instead of using it as a direct template for registration; 2) we gradually increase the temperature to ensure that all warped subjects have the opportunity to equally contribute to the construction of the group mean image as long as they are well registered. This argument will be further supported by the experimental results below. \nHere we assume each is independent. Therefore, the solution to each is a well-known optimization problem of quadratic objective function as discussed in many gradient-based registration algorithms (Vercauteren et al., 2008 (Vercauteren et al., , 2009 ). The regularization term ( , ) is related with the pairwise registration algorithm used in our method. For example, , denotes the geodesic distance in LDDMM method (Beg et al., 2005) whose velocity is the function of time starting from template to subject. In this paper, we use Diffeomorphic Demons (Vercauteren et al., 2009) as the pairwise registration component. Therefore, the regularization term on each transformation field is defined as the geodesic distance but with constant velocity.\nUsually the transformation field is independently solved by taking as the template in registration.\nBy taking those 61 toy images in Fig. 2 as examples, the procedure of registering each \u22121 to is shown in Fig. 4 (a) . However, there might exist large anatomical variations among the subjects.\nAssuming all subjects reside on the manifold, it is relatively easy for the pairwise registration algorithm to align two nearby subjects than two faraway subjects. In light of this, we employ a treebased registration method (Fig. 4 (b) ), where each subject will only register to its nearby subject on the manifold. To achieve it, we first define the measurement of distance between two subjects and as:\nwhere . is defined in Eq. 3 with the neighborhood size . Let = \u22121 , as a set of images under registration in Step 2 (SP 2 ) of the -th round of groupwise registration. The distance between any two subjects in can be calculated by Eq. 11. Then, a fully connected graph can be built by considering each subject as the node and the manifold distance as the edge weight. Next, the minimal spanning tree (MST) is extracted from the graph, using Kruskal's algorithm (Kruskal, 1956) , where is set as the root node since the goal of step 2 (SP 2 ) is to calculate the transformation field from each subject \u22121 to . In this way, all images can be organized into a tree structure where only similar images are connected. The advantage of using the tree-based registration is obvious: It allows the subjects to be aligned more robustly and accurately to the current group mean image, especially for the subjects faraway from the population center. Fig. 4 (b) demonstrates the procedure of MST-based registration in our method. In registering each subject \u22121 with , the pairwise registration algorithm will be employed between \u22121 and if\nis directly connected with (root node). Otherwise, the registration is performed sequentially along the path determined during the construction of the MST. For clearly describing SP 2 in our method, we briefly summarize it as follows:\n1. Calculate the distance between any pair of images in the set according to Eq. 11;\n2. Construct the fully connected graph;\n3. Extract the MST by setting as the root node; 4. For each subject \u22121 \u2208 \u22121 , = 1, . . , :\n(a) If the transformation field from \u22121 to is already computed, then exit; (b) Otherwise, transverse from node \u22121 to by composing all transformation fields from the current node to its parent node and then the next level of parent node until reaching the root node .\n(c) Obtain the overall transformation field for \u22121 by composing all transformation fields along the path from \u22121 to . This overall transformation field will be used as a good initialization to estimate more accurate transformation field between \u22121 and ."}, {"section_title": "Summary", "text": "Compared to the l me \u210e , he advantages of our method are: 1) the group mean image is a weighted average of aligned subjects (Eq. 9), instead of a simple arithmetic average. Weights are adaptively determined not only for each aligned subject , but also for each image location ; 2) the contribution of each subject is dynamically adjusted throughout the groupwise registration in the annealing scenario; 3) the sharpness of the group mean image is always preserved throughout the registration; 4) the registration accuracy in each round of groupwise registration has been improved by using the MST-based hierarchical registration framework.\nFor comparison, we first summarize the conventional method as follows:\nAssume 0 is the set of affine aligned subjects. 6. Loop from step 3 to step 5 until convergence or reaching the abortion criterion ( = )."}, {"section_title": "Compute the group mean image", "text": "Our new groupwise registration method is summarized as follows:\n1. Calculate the median image among the population by Eq. 2; 2. Set = 1, 0 = 1, \u2206 = 0 , , and 0 the whole image size; 11. Set \u2190 + 1;\n12. Loop from step 6 to step 11 until convergence or reaching the abortion criterion ( = ).\nThe diagrams of the conventional method and our groupwise registration method are shown in Fig. 5 (a) and (b), respectively. As summarized in the conventional method, the construction of group mean image and the registration of each subject to the group mean image are integrated to help each other for reaching the goal of groupwise registration. Our method improves each of these two steps, i.e., building the sharp mean image by dynamic and adaptive weighting of warped subjects and also performing registration of each subject to the group mean image by the tree-based method. Thus, our method can produce better results as detailed below."}, {"section_title": "Experiments", "text": "In our experiments, we have extensively evaluated the performance of our groupwise registration method in atlas construction and ROI labeling. For comparison, we set the tree-based registration method (Hamm et al., 2009) , the conventional groupwise registration method (Joshi et al., 2004) , and the ABSORB (Jia et al., 2010a) as the baseline methods. It is worth noting that the tree-based method is not the groupwise registration method, since it needs to first set an individual image as the root and then register all other subjects to the root image. The latter two methods are both groupwise registration methods. To be fair, Diffeomorphic Demons algorithm (Vercauteren et al., 2009 ) is used as the pairwise registration component in all these four methods (including our method). Also, we use the same iteration number for both the conventional method and our method.\nWe first evaluate the group mean image and the overlap ratios on WM, GM, and ventricle (VN) for 18 elderly subjects. Then, we compare the overlap ratios of aligned ROIs using NIREP dataset (http://www.nirep.org/) and LPBA40 dataset (http://www.loni.ucla.edu/Atlases/LPBA40), which have 32 and 54 manually delineated labels for each brain image, respectively.\nThe overlap ratio of ROIs is an important criterion to judge the registration performance. Here we use the Jaccard Coefficient metric (Jaccard, 1912) to measure the alignment of two regions with same label.\nFor the two registered regions and , the Jaccard Coefficient is defined as:\nwhere \u2022 denotes the volume of the underlying region. Since there is no template with labeling information in the groupwise registration, we need to vote a reference image before calculating the overlap ratio on each ROI. Here, we vote the tissue assignment of each voxel with the majority of all tissue labels at the same location from all the aligned subjects. Then, the Jaccard Coefficient between each registered subject image and the voted reference will be calculated. It is worth noting that we use this procedure to evaluate the overlap ratio for all four registration methods. In the following experiments, we report the average score of Jaccard Coefficients as the overlap ratio for each tissue label and ROI. Conventional groupwise registration method starts from a very fuzzy group mean (with its 3D rendering shown in blue box of Fig. 7) . On the contrary, our method begins with a clear group mean image (as shown in red box of Fig. 7) , which is close to the population center. The evolutions of the group mean image by the conventional and our registration methods are provided in the top and bottom rows, respectively. It is clear that, although the final group mean images are similar by both methods, ours is much sharper than that by the conventional method. Also, this experiment has demonstrated that our method will not introduce bias in the final group mean image since the group mean images by two methods (ours and the conventional unbiased registration method) are very similar. To better evaluate the group mean images by these two methods, we show six transverse views in Fig. 8 ."}, {"section_title": "Experiment on 18 Elderly Brains", "text": "To quantitatively measure the registration accuracy by overlap ratio, we first vote a reference image based on the warped results of all (tissue-segmented) subject images, as mentioned in the beginning of this section. Then, the overlap ratio is calculated between each warped subject image and the reference image one by one. Table 1 reports the overlap ratio on white matter (WM), gray matter (GM), and ventricle (VN) by the tree-based method and three groupwise registration methods, respectively. The average overlap ratio on three tissues (WM, GM, and CSF) is 68.12% by the tree-based method, which is lower than any of the groupwise registration method. This demonstrates the advantage of groupwise registration over the tree-based registration method which has bias in selection of template and thus may affect registration of a group of subjects. For the groupwise registration methods, the overlap ratio is 78.07% by our method and 70.84% by the conventional method, indicating a 7.23% improvement.\nCompared to the ABSORB method, the overlap ratio by our method is also slightly better, with 2%\nimprovement. The standard deviations on three tissues by these four methods are also reported in the Table 1 . Accordingly, we show the maps of overlap on WM, GM, and VN by the tree-based method, the conventional method, the ABSORB method, and our method in Fig. 9 (a) - (d), respectively.\nAlthough the evolution of the group mean image can be visually inspected in Fig. 7 , we further quantitatively plot the evolution curves of the tissue overlap ratio during the groupwise registration by the conventional method and our method. To demonstrate the advantage of employing the adaptive and dynamic weighting strategy (controlled by the local distance measurement and the gradually decreased temperature in Eq. 6), we also set the median image as the initial group mean and then allows the conventional groupwise registration method to perform the rest of registration. We call this method as \"pseudo sharp mean\" method. Fig. 10 shows the evolution curves of overlap ratio of white matter ( Fig. 10(a) ), gray matter ( Fig. 10(b) ), and ventricle ( Fig. 10(c) ) with respect to the iteration number. It can be observed that the performance of the conventional method and the \"pseudo sharp mean\" method is comparable and their overlap ratios are much lower than ours, not only in the end of registration but also during the whole registration procedure. Specifically, the \"pseudo sharp mean\" method still produce worse results, compared to ours, although it has the same performance in the first iteration as our method's. The reason is that, even using the median image as the initial group mean image in the \"pseudo sharp mean\" method, the subsequently constructed group mean images by simple averaging the warped subjects are still fuzzy, thus suffering the same problem as the conventional method.\nBesides providing the evaluation on overlap ratios, we further quantitatively evaluate the registration consistency according to the entropy of tissue probability on each brain voxel across 18 aligned subjects. Note that lower entropy indicates more consistent registration results across individual subjects. The average entropy value is 0.72 after affine registration. After non-rigid registration, the average entropy value is 0.54 by the tree-based method, 0.51 by the conventional method, 0.42 by ABSORB, and 0.34 by our method. Again, our groupwise registration method achieves the best performance in terms of registration consistency."}, {"section_title": "Experiment on NIREP Data", "text": "In this experiment, we align 16 brain subjects in NIREP dataset (Christensen et al., 2006) After calculating the overlap ratio for each ROI after the registration of 16 images, the overall overlap ratio is 61.69% by the tree-based method, 61.25% by the conventional groupwise registration method, 65.31% by ABSORB, and 66.66% by our groupwise registration method (which achieves the highest overlap ratio among all four methods). Fig. 11 shows the overlap ratio in each ROI by the three groupwise registration methods with blue for the conventional method, green for ABSORB, and red for our method, respectively. Furthermore, we use the blue \" \u2020\" and red \"*\" to designate the significant improvement of overlap ratio (with the p-value less than 0.05 in t-test) on ROIs by our groupwise registration method, compared to the conventional method and ABSORB, respectively. It can be observed from Fig. 9 that our method outperforms the conventional method in all ROIs, demonstrating the importance of always keeping the sharpness of the group mean image during the entire registration procedure. Compared with ABSORB, our method has obtained significant improvements on 20 out of 32 ROIs."}, {"section_title": "Experiment on LONI LPBA40 Data", "text": "In this experiment, we use the LONI LPBA40 dataset with 40 brain images and 54 manually labeled ROIs in each brain image. Similarly, we employ the tree-based registration method and three groupwise registration methods to align these 40 brain images, respectively. The overall overlap ratio is 66.95% by the tree-based method, 66.36% by the conventional method, 69.50%\nby ABSORB, and 70.36% by our method. Fig. 12 shows the overlap ratios in all 54 ROIs by the three groupwise registration methods, with blue for the conventional method, green for ABSORB, and red for our method, respectively. Also, the blue \" \u2020\" is used to denote the significant improvement on ROIs achieved by our method over the conventional method, while the red \"*\" is used to denote the significant improvement by our method over ABSORB. It can be observed that our method outperforms the conventional method on most ROIs. On the other hand, although our method produces slightly better overlap ratio than ABSORB, the improvement on each ROI is not significant after performing t-test. However, as we will show below, our method is faster; it uses only around 1/3 computation time of ABSORB."}, {"section_title": "Computation Time", "text": "We perform all of the above experiments on Dell workstation (with 8 Xeon CPU@2.66GHz and 32 G DDR memory). The computation time of the tree-based method, the conventional method, ABSORB, and our method is provided in Table 2 . It is worth noting that we set the same number of iterations (10 rounds) for the conventional method and our method. For ABSORB, we choose its optimal parameters.\nOur method is faster than ABSORB, but slightly slower than the conventional method, and much slower than the tree-based method since it performs only 1 round of registration for the whole group."}, {"section_title": "Discussion", "text": "MST-based strategy is used in each round of our groupwise registration method to improve the robustness of registration results. In order to evaluate the contribution of MST in our method, we apply our groupwise registration method, with and without MST (by keeping all other same parameters), to 18 elderly brains, NIREP data set, and LONI LPBA 40 data set, respectively. Table 3 shows their overall average overlap ratio and the standard deviation. Obviously our groupwise registration method with MST consistently achieves better registration accuracy than the counterpart without MST, demonstrating the advantage of employing MST in our complete method.\nParticularly, we notice that the improvement on registration accuracy is much more in the data set of 18 elderly brains than the other two data sets (NIREP and LONI LBPA40). One explanation is that the anatomical shape variations in 18 elderly brains (see in Fig. 6 ) are much larger than those in NIREP and LBPA40 data sets. Our method can fully take the advantage of MST to hierarchically register each subject to the group mean image by composting multiple segments of transformation fields from the underlying node (individual subject) to the root of the tree (group mean image). The minimal spanning tree used in the first round of our groupwise registration is shown in Fig. 13 . Obviously each pair of neighboring nodes in the tree has similar anatomical shape. In brief summary, this experiment strongly demonstrates the importance of using MST-based registration in each round of groupwise registration, especially in case of large anatomical variations in the data set."}, {"section_title": "Conclusion", "text": "We have demonstrated the importance of always keeping a sharp group mean image during the entire groupwise registration procedure. In order to improve the overall registration performance of the whole population, we generalize a popular unbiased groupwise registration method in this paper. In our new framework, different subjects are adaptively weighed to construct the sharp group mean image, according to their similarities to the previous-estimated group mean image. Also, we utilize a treebased registration to improve the registration quality in each round of groupwise registration. Based on these two innovative formulations, our groupwise registration method has achieved much better results than other state-of-the-art groupwise registration methods, and the tree-based registration method, using simulated and real data.\nIn the current method, we only use the intensity-based registration method, i.e., Diffeomorphic\nDemons (Vercauteren et al., 2009) , as a pairwise registration component in each round of groupwise registration. However, minimizing the intensity difference does not necessarily mean the good anatomical correspondences across subjects. In our future work, we will first integrate other featurebased registration methods, e.g., HAMMER in (Shen, 2007) , into our groupwise registration framework. Second, since it is very important to process the large population data efficiently in many clinical applications, we will improve the overall registration speed by optimizing the program and using the learning-based method for fast predication of deformation field as we did for our pairwise registration method (Kim et al., 2010) . Finally, we will also apply our groupwise registration method to various neuroscience studies, such as atlas building for early human brain development (Kazemi et al., 2007) and Alzheimer's Disease study using ADNI data (ADNI, 2004) ."}, {"section_title": "Appendix I: Estimation of group mean image", "text": "After calculating the weight for each subject at each location and removing all un-necessary terms with , the objective function 1 in SP 1 becomes:\nHere and denote the arbitrary spatial location in the common space.\ndenotes a local (spherical) image patch, thus \u2200 \u2208 ( ) \u21d2 \u2208 ( ). is the overall similarity in the local image patch. The estimation of can be calculated by requiring the derivative\nAs the result, we get: Fig. 1 . The schematic illustration of the unbiased groupwise registration algorithm (Joshi et al., 2004) .\nIn each round of groupwise registration, all subject images will be registered onto the latest estimated group mean image (shown by dashed arrows), to obtain a new updated group mean image. With the evolution of the group mean image (shown by gray rectangle in the beginning to the red circle in the final), all subjects will be warped closely to the population center. considering each subject as the tree node. In our registration, each subject will be sequentially registered to its parent nodes one by one until it reaches the root node (i.e., the group mean image ). Fig. 9 . The overlap of VN, GM, and WM by the tree-based method, the conventional method, the ABSORB method, and our groupwise registration method.\n(a) Evolution curves of overlap (b) Evolution curves of overlap (c) Evolution curves of overlap ratio on white matter ratio on gray matter ratio on ventricle Fig. 10 . The evolution curves on tissue overlap ratio during the registration. From left to right shows the evolution curve of overlap ratio on white matter, gray matter, and ventricle, respectively. In each figure, the evolution curves by the conventional method, pseudo sharp mean method, and our method are displayed in blue, green, and red, respectively. Each node in the MST is corresponding with a subject image shown in Fig. 6 ."}]