[{"section_title": "Abstract", "text": "Image segmentation is an important task in many medical applications. Methods based on convolutional neural networks attain state-of-the-art accuracy; however, they typically rely on supervised training with large labeled datasets. Labeling medical images requires significant expertise and time, and typical hand-tuned approaches for data augmentation fail to capture the complex variations in such images.\nWe present an automated data augmentation method for synthesizing labeled medical images. We demonstrate our method on the task of segmenting magnetic resonance imaging (MRI) brain scans. Our method requires only a single segmented scan, and leverages other unlabeled scans in a semi-supervised approach. We learn a model of transformations from the images, and use the model along with the labeled example to synthesize additional labeled examples. Each transformation is comprised of a spatial deformation field and an intensity change, enabling the synthesis of complex effects such as variations in anatomy and image acquisition procedures. We show that training a supervised segmenter with these new examples provides significant improvements over state-of-the-art methods for oneshot biomedical image segmentation."}, {"section_title": "Introduction", "text": "Semantic image segmentation is crucial to many biomedical imaging applications, such as performing population analyses, diagnosing disease, and planning treatments. When enough labeled data is available, supervised deep learning-based segmentation methods produce stateof-the-art results. However, obtaining manual segmentation labels for medical images requires considerable expertise and time. In most clinical image datasets, there are very few manually labeled images. The problem of limited labeled data is exacerbated by differences in image acquisition procedures across machines and institutions, which can produce wide variations in resolution, image noise, and tissue appearance [45] .\nTo overcome these challenges, many supervised biomedical segmentation methods focus on hand-engineered preprocessing steps and architectures [53, 57] . It is also common to use hand-tuned data augmentation to increase the number of training examples [2, 55, 57, 63, 65] . Data augmentation functions such as random image rotations or random nonlinear deformations are easy to implement, and are effective at improving segmentation accuracy in some settings [55, 57, 63, 65] . However, these functions have limited ability to emulate real variations [26] , and can be highly sensitive to the choice of parameters [25] .\nWe address the challenges of limited labeled data by learning to synthesize diverse and realistic labeled examples. Our novel approach to data augmentation leverages unlabeled images. Using learning-based registration methods, we model the set of spatial and appearance transforma-tions between images in the dataset. These models capture the anatomical and imaging diversity in the unlabeled images. We synthesize new examples by sampling transformations and applying them to a single labeled example.\nWe demonstrate the utility of our method on the task of one-shot segmentation of brain magnetic resonance imaging (MRI) scans. We use our method to synthesize new labeled training examples, enabling the training of a supervised segmentation network. This strategy outperforms state-of-the art one-shot biomedical segmentation approaches, including single-atlas segmentation and supervised segmentation with hand-tuned data augmentation."}, {"section_title": "Related work 2.1. Medical image segmentation", "text": "We focus on the segmentation of brain MR images, which is challenging for several reasons. Firstly, human brains exhibit substantial anatomical variations [28, 59, 76] . Secondly, MR image intensity can vary as a result of subject-specific noise, scanner protocol and quality, and other imaging parameters [45] . This means that a tissue class can appear with different intensities across imageseven images of the same MRI modality.\nMany existing segmentation methods rely on scan preprocessing to mitigate these intensity-related challenges. Pre-processing methods can be costly to run, and developing techniques for realistic datasets is an active area of research [14, 73] . Our augmentation method tackles these intensity-related challenges from another angle: rather than removing intensity variations, it enables a segmentation method to be robust to the natural variations in MRI scans.\nA large body of classical segmentation methods use atlas-based or atlas-guided segmentation, in which a labeled reference volume, or atlas, is aligned to a target volume using a deformation model, and the labels are propagated using the same deformation [6, 13, 22, 32] . When multiple atlases are available, they are each aligned to a target volume, and the warped atlas labels are fused [36, 41, 68, 78] . In atlas-based approaches, anatomical variations between subjects are captured by a deformation model, and the challenges of intensity variations are mitigated using pre-processed scans, or intensity-robust metrics such as normalized cross-correlation. However, ambiguities in tissue appearances (e.g., indistinct tissue boundaries, image noise) can still lead to inaccurate registration and segmentations. We address this limitation by training a segmentation model on diverse realistic examples, making the segmenter more robust to such ambiguities. We focus on having a single atlas, but if more than one segmented example is available, our method can leverage them.\nSupervised learning approaches to biomedical segmentation have gained popularity in recent years. To mitigate the need for large labeled training datasets, these methods often use data augmentation along with hand-engineered preprocessing steps and architectures [2, 40, 53, 57, 63, 65, 82] .\nSemi-supervised and unsupervised approaches have also been proposed to combat the challenges of small training datasets. These methods do not require paired image and segmentation data. Rather, they leverage collections of segmentations to build anatomical priors [21] , to train an adversarial network [39] , or to train a novel semantic constraint [29] . In practice, collections of images are more readily available than segmentations. Rather than rely on segmentations, our method leverages a set of unlabeled images."}, {"section_title": "Spatial and appearance transform models", "text": "Models of shape and appearance have been used in a variety of image analyses. Parametric spatial transform models have been used to align and classify handwritten digits [31, 44, 50] . In medical image registration, a spatial deformation model is used to establish semantic correspondences between images. This mature field spans optimization-based methods [4, 7, 67, 70] , and recent learning-based methods [8, 9, 20, 42, 62, 72, 80] .\nMany medical image registration methods focus on intensity-normalized images or intensity-independent objective functions, and do not explicitly account for variations in image intensity. For unnormalized images, models of intensity transforms have used to remove bias field effects from MRI [44, 79] . Spatial and appearance transform models have been used together to register objects that differ in shape as well as texture. Many works build upon the framework of Morphable Models [38] or Active Appearance Models (AAMs) [15, 16] , in which statistical models of shape and texture are constructed. AAMs have been used to localize anatomical landmarks [17, 58] and perform segmentation [52, 56, 77] . We build upon these concepts by using convolutional neural networks to learn models of unconstrained spatial and intensity transformations. Rather than learning transform models for the end goal of registration or segmentation, we sample from these models to synthesize new training examples. As we show in our experiments, augmenting a segmenter's training set in this way can produce more robust segmentations than performing segmentation using the transform models directly.\nWe describe the differences between scans using a combination of spatial and intensity transformations. Specifically, we define a transformation \u03c4 (\u00b7) from one volume to another as a composition of a spatial transformation \u03c4 s (\u00b7) and an intensity or appearance transformation \u03c4 a (\u00b7), i.e., \u03c4 (\u00b7) = \u03c4 s (\u03c4 a (\u00b7)).\nWe assume a spatial transformation takes the form of a smooth voxel-wise displacement field u. Following the medical registration literature, we define the deformation function \u03c6 = id + u, where id is the identity function.\nWe use x \u2022 \u03c6 to denote the application of the deformation \u03c6 to x. To model the distribution of spatial transformations in our dataset, we compute the deformation that warps atlas x to each volume y (i) using \u03c6 (i) = g \u03b8 s (x, y (i) ), where g \u03b8 s (\u00b7, \u00b7) is a parametric function that we describe later. We write approximate inverse deformation of y (i) to x as \u03c6 \u22121 (i) = g \u03b8 s (y (i) , x).\nWe model the appearance transformation \u03c4 a (\u00b7) as per-voxel addition in the spatial frame of the atlas. We compute this per-voxel volume using the function\nis a volume that has been registered to the atlas space using our learned spatial model. In summary, our spatial and appearance transformations are:"}, {"section_title": "Few-shot segmentation of natural images", "text": "Few-shot segmentation is a challenging task in semantic segmentation and video object segmentation. Existing approaches focus mainly on natural images. Methods for few-shot semantic segmentation incorporate information from prototypical examples of the classes to be segmented [24, 69] . Few-shot video segmentation is frequently implemented by aligning objects in each frame to a labeled reference frame [37, 75] . Other approaches leverage large Figure 2 : An overview of the proposed method. We learn independent spatial and appearance transform models to capture the variations in our image dataset. We then use these models to synthesize a dataset of labeled examples. This synthesized dataset is used to train a supervised segmentation network. labeled datasets of supplementary information such as object appearances [11] , or incorporate additional information such as human input [60] . Medical images present different challenges from natural images; for instance, the visual differences between tissue classes are very subtle compared to the differences between objects in natural images."}, {"section_title": "Data augmentation", "text": "In image-based supervised learning tasks, data augmentation is commonly performed using simple parameterized transformations such as rotation and scaling. For medical images, random smooth flow fields have been used to simulate anatomical variations [51, 63, 64] . These parameterized transformations can reduce overfitting and improve test performance [34, 43, 51, 63, 64] . However, the performance gains imparted by these transforms vary with the selection of transformation functions and parameter settings [25] .\nRecent works have proposed learning data augmentation transformations from data. Hauberg et al. [31] focus on data augmentation for classifying MNIST digits. They learn digit-specific spatial transformations, and sample training images and transformations to create new examples aimed at improving classification performance. We learn an appearance model in addition to a spatial model, and we focus on the problem of MRI segmentation.\nOther recent works focus on learning combinations of simple transformation functions (e.g., rotation and contrast enhancement) to perform data augmentation for natural images [18, 61] . These simple transformations are insufficient for capturing many of the subtle variations in MRI data."}, {"section_title": "Method", "text": "We propose to improve one-shot biomedical image segmentation by synthesizing realistic training examples in a semi-supervised learning framework.\nLet {y (i) } be a set of biomedical image volumes, and let the pair (x, l x ) represent a labeled reference volume, or atlas, and its corresponding segmentation map. In brain MRI segmentation, each x and y is a grayscale 3D volume. We focus on the challenging case where only one labeled atlas is available, since it is often difficult in practice to obtain many segmented volumes. Our method can be easily extended to leverage additional segmented volumes.\nTo perform data augmentation, we apply transformations \u03c4 (k) to the labeled atlas x. We first learn separate spatial and appearance transform models to capture the distribution of anatomical and appearance differences between the labeled Figure 3 : We use a convolutional neural network based on the U-Net architecture [63] to learn each transform model. The application of the transformation is a spatial warp for the spatial model, and a voxel-wise addition for the appearance model. Each convolution uses 3 \u00d7 3 \u00d7 3 kernels, and is followed by a LeakyReLU activation layer. The encoder uses max pooling layers to reduce spatial resolution, while the decoder uses upsampling layers.\natlas and each unlabeled volume. Using the two learned models, we synthesize labeled volumes {(\u0177 (k) ,l (k) y )} by applying a spatial transformation and an appearance transformation to the atlas volume, and by warping the atlas label maps using the spatial transformation. Compared to singleatlas segmentation, which suffers from uncertainty or errors in the spatial transform model, we use the same spatial transformation to synthesize the volume and label map, ensuring that the newly synthesized volume is correctly labeled. These synthetic examples form a labeled dataset that characterizes the anatomical and appearance variations in the unlabeled dataset. Along with the atlas, this new training set enables us to train a supervised segmentation network. This process is outlined in Fig. 2 .\nDice score Pairwise Dice improvement "}, {"section_title": "Learning", "text": "We aim to capture the distributions of the transformations \u03c4 s and \u03c4 a between the atlas and the unlabeled volumes. We estimate the functions g \u03b8 s (\u00b7, \u00b7) and h \u03b8 a (\u00b7, \u00b7) in Eqs. (1) and (2) using separate convolutional neural networks, with each network using the general architecture outlined in Fig. 3 . Drawing on insights from Morphable Models [38] and Active Appearance Models [16, 17] , we optimize the spatial and appearance models independently. For our spatial model, we leverage VoxelMorph [8, 9, 20] , a recent unsupervised learning-based approach with an open-source implementation. VoxelMorph learns to output a smooth displacement vector field that registers one image to another by jointly optimizing an image similarity loss and a displacement field smoothness term. We use a variant of VoxelMorph with normalized cross-correlation as the image similarity loss, enabling the estimation of g \u03b8 s (\u00b7, \u00b7) with unnormalized input volumes.\nWe use a similar approach to learn the appearance model. Naively, one might define h \u03b8 a (\u00b7, \u00b7) from Eq. (2) as a simple per-voxel subtraction of the volumes in the atlas space. While this transformation would perfectly reconstruct the target image, it would include extraneous details when the registration function \u03c6 \u22121 is imperfect, resulting in image details in x + \u03c8 that do not match the anatomical labels. We instead design h \u03b8 a (\u00b7, \u00b7) as a neural network that produces a per-voxel intensity change in an anatomically consistent manner. Specifically, we use an image similarity loss as well as a semantically-aware smoothness regularization. Given the network output \u03c8 (i) = h \u03b8 a (x, y (i) \u2022 \u03c6 \u22121 ), we define a smoothness regularization function based on the atlas segmentation map:\nwhere c x is a binary image of anatomical boundaries computed from the atlas segmentation labels l x , and \u2207 is the spatial gradient operator. Intuitively, this term discourages dramatic intensity changes within the same anatomical region.\nIn the total appearance transform model loss L a , we use mean squared error for the image similarity loss L sim (\u0177, y) = ||\u0177 \u2212 y|| 2 . In our experiments, we found that computing the image similarity loss in the spatial frame of the subject was helpful. We balance the similarity loss with the regularization term L smooth :\nwhere \u03bb a is a hyperparameter."}, {"section_title": "Synthesizing new examples", "text": "The models described in Eqs. (1) and (2) enable us to sample spatial and appearance transformations \u03c4\nby sampling target volumes y (i) , y (j) from an unlabeled dataset. Since the spatial and appearance targets can be different subjects, our method can combine the spatial variations of one subject with the intensities of another into a single synthetic volume\u0177. We create a labeled synthetic example by applying the transformations computed from the target volumes to the labeled atlas:\nThis process is visualized in steps 3 and 4 in Fig. 2 . These new labeled training examples are then included in the labeled training set for a supervised segmentation network."}, {"section_title": "Segmentation network", "text": "The newly synthesized examples are useful for improving the performance of a supervised segmentation network. We demonstrate this using a network based on the state-ofthe-art architecture described in [66] . To account for GPU memory constraints, the network is designed to segment one slice at a time. We train the network on random slices from the augmented training set. We select the number of training epochs using early stopping on a validation set. We emphasize that the exact segmentation network architecture is not the focus of this work, since our method can be used in conjunction with any supervised segmentation network."}, {"section_title": "Implementation", "text": "We implemented all models using Keras [12] and Tensorflow [1] . The application of a spatial transformation to an image is implemented using a differentiable 3D spatial transformer layer [8] ; a similar layer that uses nearest neighbor interpolation is used to transform segmentation maps. For simplicity, we capture the forward and inverse spatial transformations described in Section 3.1 using two identical neural networks. For the appearance transform model, we use the hyperparameter setting \u03bb a = 0.02. We train our transform models with a single pair of volumes in each batch, and train the segmentation model with a batch size of 16 slices. All models are trained with a learning rate of 5e \u22124 . Our code is available at https://github.com/xamyzhao/brainstorm."}, {"section_title": "Experiments", "text": "We demonstrate that our automatic augmentation method can be used to improve brain MRI segmentation. We focus on one-shot segmentation of unnormalized scans -a challenging but practical scenario. Intensity normalization methods such as bias field correction [27, 71, 74] can work poorly in realistic situations (e.g., clinical-quality scans, or scans with stroke [73] or traumatic brain injury)."}, {"section_title": "Data", "text": "We use the publicly available dataset of T1-weighted MRI brain scans described in [8] . The scans are compiled from eight databases: ADNI [54] , OASIS [46] , ABIDE [48] , ADHD200 [49] , MCIC [30] , PPMI [47] , HABS [19] , and Harvard GSP [33] ; the segmentation labels are computed using FreeSurfer [27] . As in [8] , we resample the brains to 256 \u00d7 256 \u00d7 256 with 1mm isotropic voxels, and affinely align and crop the images to 160 \u00d7 192 \u00d7 224. We do not apply any intensity corrections, and we perform skull-stripping by zeroing out voxels with no anatomical label. For evaluation, we use segmentation maps of the 30 anatomical labels described in [8] .\nWe focus on the task of segmentation using a single labeled example. We randomly select 101 brain scans to be available at training time. In practice, the atlas is usually selected to be close to the anatomical average of the population. We select our atlas to be the most similar training example to the anatomical average computed in [8] . This atlas is the single labeled example that is used to train our transform models; the segmentation labels of the other 100 training brains are not used. We use an additional 50 scans as a validation set, and an additional 100 scans as a held-out test set. [23] , evaluated on a held-out test set of 100 scans. We report the mean Dice score (and standard deviation in parentheses) across all 30 anatomical labels and 100 test subjects. We also report the mean pairwise improvement of each method over the SAS baseline."}, {"section_title": "Segmentation baselines", "text": "Single-atlas segmentation (SAS): We use the same stateof-the-art registration model [8] that we trained for our method's spatial transform model in a single-atlas segmentation framework. We register the atlas to each test volume, and warp the atlas labels using the computed deformation field [6, 13, 22, 32, 41] . That is, for each test image y (i) , we compute \u03c6 (i) = g \u03b8 s (x, y (i) ) and predict label\u015d l\nData augmentation using single-atlas segmentation (SAS-aug): We use SAS results as labels for the unannotated training brains, which we then include as training examples for supervised segmentation. This adds 100 new training examples to the segmenter training set."}, {"section_title": "Hand-tuned random data augmentation (rand-aug):", "text": "Similarly to [51, 63, 64] , we create random smooth deformation fields by sampling random vectors on a sparse grid, and then applying bilinear interpolation and spatial blurring. We evaluated several settings for the amplitude and smoothness of the deformation field, including the ones described in [63] , and selected the settings that resulted in the best segmentation performance on a validation set. We synthesize variations in imaging intensity using a global intensity multiplicative factor sampled uniformly from the range [0.5, 1.5], similarly to [35, 40] . We selected the range to match the intensity variations in the dataset; this is representative of how augmentation parameters are tuned in practice. This augmentation method synthesizes a new randomly transformed brain in each training iteration."}, {"section_title": "Supervised:", "text": "We train a fully-supervised segmentation network that uses ground truth labels for all 101 examples in our training dataset. Apart from the atlas labels, these labels are not available for any of the other methods. This method serves as an upper bound. "}, {"section_title": "Variants of our method", "text": "Independent sampling (ours-indep): As described in Section 3.3, we sample spatial and appearance target images independently to compute \u03c4\na . With 100 unlabeled targets, we obtain 100 spatial and 100 appearance transformations, enabling the synthesis of 10, 000 different labeled examples. Due to memory constraints, we synthesize a random labeled example in each training iteration, rather than adding all 10, 000 new examples to the training set.\nCoupled sampling (ours-coupled): To highlight the efficacy of our independent transform models, we compare ours-indep to a variant of our method where we sample each of the spatial and appearance transformations from the same target image. This results in 100 possible synthetic examples. As in ours-indep, we synthesize a random example in each training iteration.\nOurs-indep + rand-aug: When training the segmenter, we alternate between examples synthesized using ours-indep, and examples synthesized using rand-aug. The addition of hand-tuned augmentation to our synthetic augmentation could introduce additional variance that is unseen even in the unlabeled set, improving the robustness of the segmenter. "}, {"section_title": "Evaluation metrics", "text": "We evaluate the accuracy of each segmentation method in terms of Dice score [23] , which quantifies the overlap between two anatomical regions. A Dice score of 1 indicates perfectly overlapping regions, while 0 indicates no overlap. The predicted segmentation labels are evaluated relative to anatomical labels generated using FreeSurfer [27] . Table 1 shows the segmentation accuracy attained by each method. Our methods outperform all baselines in mean Dice score across all 30 evaluation labels, showing significant improvements over the next best baselines rand-aug (p < 1e-15 using a paired t-test) and SAS-aug (p < 1e-20)."}, {"section_title": "Results", "text": ""}, {"section_title": "Segmentation performance", "text": "In Figs. 4 and 5 , we compare each method to the singleatlas segmentation baseline. Fig. 4 shows that our methods attain the most improvement on average, and are more con-sistent than hand-tuned random augmentation. Fig. 5 shows that ours-indep + rand-aug is consistently better than each baseline on every test subject. Ours-indep alone is always better than SAS-aug and SAS, and is better than rand-aug on 95 of the 100 test scans. Fig. 6 shows that rand-aug improves Dice over SAS on large anatomical structures, but is detrimental for smaller ones. In contrast, our methods produce consistent improvements over SAS and SAS-aug across all structures. We show several examples of segmented hippocampi in Fig. 7 ."}, {"section_title": "Synthesized images", "text": "Our independent spatial and appearance models enable the synthesis of a wide variety of brain appearances. Fig. 8 shows some examples where combining transformations produces realistic results with accurate labels."}, {"section_title": "Discussion", "text": "Why do we outperform single-atlas segmentation? Our methods rely on the same spatial registration model that is used for SAS and SAS-aug. Both ours-coupled and SAS-aug augment the segmenter training set with 100 new images.\nTo understand why our method produces better segmentations, we examine the augmented images. Our method warps the image in the same way as the labels, ensuring that the warped labels match the transformed image. On the other hand, SAS-aug applies the warped labels to the original image, so any errors or noise in the registration results in a mis-labeled new training example for the segmenter. Fig. 9 highlights examples where our method synthesizes image texture within the hippocampus label that is more + + Atlas and labels , Sampled appearance and spatial transform targets ( ) , ( ) Synthesized image and labels ( , ) , ( , ) Figure 8 : Since we model spatial and appearance transformations independently, we are able to synthesize a variety of combined effects. We show some examples synthesized using transformations learned from the training set; these transformations form the bases of our augmentation model. The top row shows a synthetic image where the appearance transformation produced a darkening effect, and the spatial transformation shrunk the ventricles and widened the whole brain. In the second row, the atlas is brightened and the ventricles are enlarged.\nconsistent with the texture of the ground truth hippocampus, resulting in a more useful synthetic training example.\nExtensions Our framework lends itself to several plausible future extensions. In Section 3.1, we discussed the use of an approximate inverse deformation function for learning the appearance transformation in the reference frame of the atlas. Rather than learning a separate inverse spatial transform model, in the future we will leverage existing work in diffeomorphic registration [3, 5, 10, 20, 81] . We sample transformations from a discrete set of spatial and appearance transformations. This could be extended to span the space of transformations more richly, e.g., through interpolation between transformations, or using compositions of transformations.\nWe demonstrated our approach on brain MRIs. Since the method uses no brain-or MRI-specific information, it is feasible to extend it to other anatomy or imaging modalities, such as CT."}, {"section_title": "Conclusion", "text": "We presented a learning-based method for data augmentation, and demonstrated it on one-shot medical image segmentation.\nWe start with one labeled image and a set of unlabeled examples. Using learning-based registration methods, we model the set of spatial and appearance transformations between the labeled and unlabeled examples. These transformations capture effects such as non-linear deformations and variations in imaging intensity. We synthesize new labeled examples by sampling transformations and applying them to the labeled example, producing a wide variety of realistic new images. . When the spatial model (used by both methods) produces imperfect warped labels, SAS-aug pairs the warped label with incorrect image textures. Our method still produces a useful training example by matching the synthesized image texture to the label.\nWe use these synthesized examples to train a supervised segmentation model. The segmenter out-performs existing one-shot segmentation methods on every example in our test set, approaching the performance of a fully supervised model. This framework enables segmentation in many applications, such as clinical settings where time constraints permit the manual annotation of only a few scans. In summary, this work shows that:\n\u2022 learning independent models of spatial and appearance transformations from unlabeled images enables the synthesis of diverse and realistic labeled examples, and\n\u2022 these synthesized examples can be used to train a segmentation model that out-performs existing methods in a one-shot scenario."}]