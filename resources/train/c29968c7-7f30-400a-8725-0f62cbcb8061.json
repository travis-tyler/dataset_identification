[{"section_title": "Abstract", "text": "We consider the problem of segmenting a biomedical image into anatomical regions of interest. We specifically address the frequent scenario where we have no paired training data that contains images and their manual segmentations. Instead, we employ unpaired segmentation images to build an anatomical prior. Critically these segmentations can be derived from imaging data from a different dataset and imaging modality than the current task. We introduce a generative probabilistic model that employs the learned prior through a convolutional neural network to compute segmentations in an unsupervised setting. We conducted an empirical analysis of the proposed approach in the context of structural brain MRI segmentation, using a multi-study dataset of more than 14,000 scans. Our results show that an anatomical prior can enable fast unsupervised segmentation which is typically not possible using standard convolutional networks. The integration of anatomical priors can facilitate CNN-based anatomical segmentation in a range of novel clinical problems, where few or no annotations are available and thus standard networks are not trainable. The code is freely available at http://github.com/adalca/neuron."}, {"section_title": "Introduction", "text": "Biomedical image segmentation plays a crucial role in many applications, such as population analysis, disease progression modelling, or treatment planning. Convolutional neural networks (CNNs), a class of deep learning methods, have been employed to derive powerful biomedical segmentation algorithms, showing promise of overcoming limitations in previous methods [3, 4, 29, 34] . However, CNNbased approaches most often depend on (large-scale) training data, particularly in the form of image scans paired with segmentations. These annotations are often costly and challenging to obtain because they require the tedious effort of a trained expert, taking several expert hours per scan."}, {"section_title": "Contributions", "text": "To our knowledge, there has not been a theoretically rigorous effort to integrate rich probabilistic anatomical priors with a CNN-based segmentation model in a computationally effective manner. We introduce a generative model for biomedical segmentation that employs a deep anatomical prior. We describe a principled derivation that follows directly from our generative model. We demonstrate that this yields intuitive cost functions and simpler models. We use an auto-encoding variational CNN to characterize the anatomical prior, and an encoder-decoder CNN to provide fast segmentation of medical images in unsupervised settings.\nWe demonstrate the method in an unsupervised biomedical image segmentation setting where paired annotations are not available. Our proposed strategy is general and computationally efficient, provides a natural framework for sampling possible subject-specific segmentations of a scan, and provides uncertainty estimates for these segmentations."}, {"section_title": "Related Work", "text": ""}, {"section_title": "Segmentation Convolutional Neural Networks", "text": "CNN-based segmentation approaches generally rely on fully convolutional architectures applied to image data. They extract hierarchical and multi-resolution features that are in turn combined to compute a semantic segmentation [23, 29, 31, 34] .\nA popular discriminative segmentation architecture, Unet [29] , involves a convolutional encoder or downsampling network, followed by a convolutional decoder or upsampling network, and skip-connections between layers. The encoder captures relevant features of the input image at different resolutions. The decoder then synthesizes a high-resolution segmentation, using the skip connections to achieve voxel-level precision. While the exact architecture of these networks, such as the number of layers and levels, size of convolution kernels, or application of batch normalization vary, they typically involve millions of parameters and necessitate large datasets and data augmentation techniques to train.\nCNN-based segmentation models have two major shortcomings: the dependency on annotated data, limiting their use in unsupervised settings; and their lack of anatomical knowledge. The latter limits the network's ability to be faithful to known anatomical shapes during segmentation.\nIn our work, we use CNN architectures to learn anatomical priors and segment medical images. The prior eliminates the burden of providing paired example segmentations."}, {"section_title": "Priors for Convolutional Neural Networks", "text": "A clinical expert performing manual delineation relies on spatial coordinates and prior knowledge about anatomy, and may use a template of the structures to constrain the task. This process draws on the anatomical similarity across patient scans. This is in stark contrast with typical computer vision problems that have led to many popular CNN architectures, where object location, shape, and appearance can be unpredictable.\nConvolutional methods are often limited in incorporating domain expertise. For example, U-Net [29] and its derivatives produce segmentation algorithms that do not exploit location information or other explicit anatomical priors. A CNN might have difficulty differentiating two distinct objects that are consistently in two specific parts of the scan, if they have the same intensity and context (as in bilateral structures in two hemispheres) 1 . While increasingly more complex networks that extend receptive fields may tease out object differences in supervised settings, the problem would be trivial if we consider anatomical knowledge like spatial location. Furthermore, in these modalities, image contrast can be weak or noisy in certain regions resulting in uncertainty of the segmentations. An anatomical prior can resolve these ambiguities, while making the segmentation task easier.\nA popular strategy to explicitly employ prior structure in CNNs for biomedical image segmentation is to use a conditional random field (CRF) as a post-processing step [13, 30, 34] . However, CRFs only capture local constraints, and add to the computational burden. Location information has been included as a feature in patch-based CNN segmentation networks [34] . While this addition carries prior location information, it is network-specific, increases the parameter burden on the network, and does not capture shape information.\nRecent methods have employed shape priors for neural network solutions in supervised problems [26, 28] . In particular, they often design a series of networks that learn representations of images and segmentations in a supervised 1 Assuming that the field of view of the network is constrained to not include the other object's vicinity setting. They propose ad-hoc cost functions that encourage the computed segmentations to be similar to both the learned shape and the ground truth. These methods attempt to correct segmentations produced by standard CNNs by adding a prior constraint.\nConvolutional image generative models, such as generative adversarial nets, have grown in popularity. They have recently been applied to biomedical image segmentations [16, 24] in a supervised setting where standard loss functions are combined with adversarial losses. A series of recent papers in the computer vision community removes the requirement for paired data by introducing a cycle dependency [37] . However, these methods are less applicable in medical image segmentation with many anatomical labels, as an image signal can pass through the rich networks at low cost, leading to a perfect cycle loss, circumventing the required constraints [37] .\nVariational Bayes auto-encoders have been used for various tasks to learn probabilistic generative models, and often use convolutional networks [18] . Our method builds on these models to combine anatomical priors with image generation."}, {"section_title": "Classical Generative Models", "text": "Encoding and exploiting prior knowledge is common in generative models. Our inspiration comes from classical atlas-based probabilistic segmentation methods that estimate the maximum a posteriori (MAP) probability based on a generative model involving a prior probability and likelihood [5, 10, 17, 27, 32, 33, 35] .\nThe prior term captures knowledge of underlying anatomy and usually involves a probabilistic atlas and a spatial deformation that models geometric variation. The spatial deformation can be explicitly solved using a registration algorithm or accounted for in a unified segmentation framework [1] .\nThe likelihood models the physical process that yields medical image intensities, sometimes called the appearance model, conditioned on the latent anatomy. These appearance models are often simpler, relying on additive and/or multiplicative Gaussian or Rician noise models [35] . Model parameters are most often estimated using training data, such as annotated image pairs, for example using maximum likelihood.\nGiven a new image, most popular segmentation algorithms use numerical non-convex optimization and can take several hours per image on a modern CPU.\nIn our model, we draw on ideas from classical modelbased biomedical segmentation algorithms, convolutional neural networks (CNNs) used in semantic segmentation, and recent developments in variational Bayes approximations using neural networks. In our experiments, we consider the segmentation of structural brain MRI scans into | | = {\u00b5, } Figure 1 . A graphical representation of our generative model. Circles indicate random variables and rounded squares represent parameters. Shaded circles represent observed quantities and the plates indicate replication. xi is the acquired image. The image intensities are generated from a normal distribution parametrized by \u00b5 l and \u03c3 l for each anatomical label l in the label map s. Anatomical priors are controlled by the variable z and categorical parameters \u03b8 s|z .\ncortical and subcortical regions of interest (ROIs). Our results show that the proposed anatomical prior enables rapid unsupervised segmentation. While complex, specialized tools exist for segmenting some specific scan modalities or particular diseases, they do not generalize to other modalities and can take hours to process one scan. Our goal is to provide a first general approach to biomedical image segmentation in an unsupervised setting."}, {"section_title": "Generative Model", "text": "We let x be an (MR) 3D volume, and assume it is generated from a 3D anatomical segmentation map s. We will use x[j] and s[j] to denote the image intensity and label at voxel j, respectively.\nWe use a generative model to describe the spatial distribution, shape, and appearance of anatomical structures. Figure 1 provides a graphical representation.\nThe prior captures our knowledge about spatial distributions and shape of anatomy. We let z be a latent variable representing an embedding of these shapes, and model the prior probability of this embedding as normal with mean 0 and an identity covariance matrix: (1) where N (\u00b7; \u00b5, \u03a3) is the normal distribution parametrized by mean \u00b5 and covariance \u03a3.\nWe let s be drawn from a categorical prior distribution determined by the low-dimensional embedding z via p \u03b8 s|z (s|z):\nwhere f j,l (\u00b7; \u03b8 s|z ) is the probability of label l at voxel j.\nFinally, given the label map s, the intensity observations are generated via p \u03b8 x|s (x|s), sampled at each voxel from a normal distribution:\nwhere \u03b8 z|s = {\u00b5 l , \u03c3 l }, and \u03b4(s[j] = l) is the indicator function that evaluates to 1 if s[j] = l and 0 otherwise.\nThe joint likelihood is therefore p \u03b8 (x, s|z) = p \u03b8 x|s (x|s)p \u03b8 s|z (s|z), where \u03b8 = {\u03b8 s|z , \u03b8 x|s }. Intuitively, the embedding z determines the possible anatomical shapes in s, which in turn determine the possible observed images x.\nWe describe the learning procedure in the next section. Given learned parameters, to obtain the segmentation s i given a new image x i , we perform MAP estimation:"}, {"section_title": "Learning", "text": "In this section, we describe a learning strategy that uses convolutional neural networks to estimate anatomical representations and optimize posterior segmentation distributions. This procedure is applicable to broad modelling choices for the probability distributions described above. We also discuss a separate learning procedure for the anatomical prior, uncertainty estimation, and implementation.\nWithout assuming voxel independence of the segmentation map given an image, estimating the posterior probability p \u03b8 (s|x) is intractable since it involves integrating over the latent variable z. Estimating p \u03b8 (z|x, s) is similarly intractable, making the Expectation Maximization algorithm not pertinent.\nWe first introduce an encoding probability q \u03c6 (z|x, s) as an approximation to the intractable p \u03b8 (z|x, s), similar to [18] . Consider the KL divergence between the approximate distribution q \u03c6 (z|x, s) and the true posterior p \u03b8 (z|x, s):\nRearranging terms, we obtain\nSince the KL divergence of the approximate and true posterior of z is non-negative, the second term is referred to as the variational lower bound of the model evidence or joint probability. For a given approximate distribution q \u03c6 (z|x, s), we can estimate \u03b8 by optimizing the lower bound:\nWe model the approximating posterior q \u03c6 (z|x, s) as a normal that depends on the image only:\nwhere \u03a3 z|x is diagonal. We estimate the parameters of the approximating distribution using convolutional neural networks. We design an encoding convolutional neural network enc \u03c6 (x) that takes as input x and outputs the parameters of the approximating posterior distribution \u00b5 z|x (x), and \u03a3 z|x (x). This network learns how to embed an entire (MR) image into the most likely low-dimensional anatomical embedding z and its variance.\nConditioned on z, the probability of the segmentation can be computed with a decoder network dec \u03b8 s|z (z) that takes z as input and outputs the parameters f (z; \u03b8 s|z ) of the segmentation categorical distribution p \u03b8 s|z (s|z). The parameters \u03b8 s|z of this decoder can be learned using a separate set of segmentations, as described below.\nThe final part of the generative model, the appearance or likelihood model, can also be learned with a neural network that takes a segmentation probability map as input and computes the parameters \u00b5 l . We separately estimate \u03c3 l , assuming additive zero mean Gaussian noise in an image, using a difference of Laplacian filters [15] ."}, {"section_title": "Auto-Encoding Anatomical Prior", "text": "In this work, we learn a prior independently from an unpaired segmentation dataset. This enables the flexibility of having an external description of the anatomy that need not be available in the current data. Unfortunately, as before, estimating the probability distribution p(s) is intractable. Following a derivation similar to the previous section and to the auto-encoding variational Bayes framework, we introduce an approximation q \u03c8 (z|s) to the posterior p(z|s) as a normal distribution:\nwhere \u03a3 z|s is diagonal, leading to the following lower bound:\nThis can be optimized using a Stochastic Gradient Variational Bayes (SGVB) estimator that uses mini-batches. The reparametrization trick enables us to sample z k \u223c q \u03c6 (z|s), leading to an approximation of the expectation\nThe loss L i (\u03b8, \u03c6; s i ) for each data point s i and sample\nWe design an encoding network enc \u03c8 (s) that takes a segmentation map as input and outputs the parameters \u00b5 z|s and \u03a3 z|s . Importantly, we learn the parameters of the encoding network given only a set of segmentations {s i }, which can be derived from other imaging modalities and/or datasets. The segmentation prior therefore does not require paired training data in the traditional sense. For example, we can use a prior computed using publicly available annotated datasets such as [19] in a problem that involves a different imaging modality than in the current task."}, {"section_title": "Unsupervised Learning", "text": "We assume we have learned a segmentation prior using the Auto-Encoding Anatomical Prior described in the previous section. In particular, we will utilize the decoder component of the prior model, namely p \u03b8 s|z (s|z).\nIf we had annotated pairs {x i , s i }, we could jointly learn model parameters \u03b8 x|s , and variational parameters \u03c6 by optimizing the evidence lower bound objective (7), similar to the previous section. For each sample {x i , s i } and sample z k \u223c q \u03c6 (z|x i , s i ), the loss function would be\nresulting in terms of KL divergence, segmentation map categorical cross-entropy, and intensity-based mean squared error, respectively. During training, these terms would ensure that the probability q \u03c6 (z|x i ) stays close to the standard normal, while explaining the segmentations, and that the model parameters \u03b8 x|s = {\u00b5 l , \u03c3 l } capture the relationship between the segmentations and the images.\nHowever, in this paper we tackle the unsupervised setting, where annotated pairs {x i , s i } are not available, and we only have the images {x i }. Therefore, we cannot compute the categorical cross entropy term in (12) . Instead, we marginalize over the segmentation s in the second term of the variational lower bound (7):\nwhere we used Jensen's inequality. We therefore arrive at the following upper bound of the loss function:\nwhere we used the factorization of p \u03b8s|z (s|z) over voxels from (2) , and sample z k \u223c q \u03c6 (z|x i )."}, {"section_title": "Inference and uncertainty", "text": "Given a new image x, we approximate s = arg max s p \u03b8 (s|x) by first obtaining \u00b5 z using the encoder enc \u03b8 z|x (x), and taking the maximum segmentation at each voxel s = arg max s dec \u03b8 s|z (\u00b5 z ). The operations are fast, since both are feed-forward neural networks.\nThis model also enables sampling segmentations conditioned on a particular image and enables estimation of uncertainty. Given an input image x i , we can create samples z k \u223c q \u03c6 (z|x) and s k \u223c p \u03b8 s|z (s|z k ), simulating different plausible segmentations for a given subject. We can estimate the uncertainty of our segmentation given a new image x i using"}, {"section_title": "Implementation", "text": "A CNN can be seen as a hierarchical function, a set of concatenated functions, or layers. For example, CNNs often map some input image x to an output probability\u015d p :\nwhere \u2022 denotes concatenation, f i is often some nonlinear function such as a rectified linear unit or ReLU or maxpool [12] applied to (linear) convolutions of the output of the previous layer f i\u22121 (with f 0 = x).\nT1w scan T2-FLAIR scan Figure 3 . Example T1w and T2-FLAIR images highlighting the difference in anatomical differences, tissue contrast and scan quality.\nAlthough we operate on 3D images, we use a 2D architecture in our experiments. We experimented with 3D architectures as well, but found little gain while facing significant challenges related to limitations between GPU memory, batch size, the number of features, and the number of labels possible. Each encoder consists of five downsampling levels of one convolution layer each, with 3x3 convolution kernels with elu activations, and 32 features for each kernel. The final layer is dense, with 1000-long encoding of the means and standard deviations representations.\nThe decoder is a mirror of this design, but upsamples instead of downsampling and ends with a sigmoid activation. In addition, we use a final layer that implements a pixelwise spatially-varying voxel-wise (location) prior p loc (s), which is multiplied with dec(z) (in practice, we add the logarithms). As is common in the atlas-based segmentation literature, the prior p loc (s) was computed as the frequency of labels in the held out prior dataset, in affine-normalized coordinate system. This layer discourages any extreme decodings of z but does not capture shape properties, which is encoded in dec(z).\nWe implement the normal probability p(x|s) with a single linear layer. We also find it useful to pre-train the image encoder using an image variational auto-encoder similar to the segmentation one. The encoder weights are used as initialization only. During training, we used the Adadelta optimizer [36] .\nFor the latent encoding layers representing \u00b5 z and \u03a3 z , we introduce an activation function that discourages the sample activations from being too large, helping limit numerical issues stemming in sampling from these layers during the reparametrization trick. We use concepts from the softsign and tanh activations to define our function as act(x) = softsign \u03b1 (x) log(2 + \u03b1 * |x|)."}, {"section_title": "Experiments", "text": "We demonstrate our model on two datasets. For the first dataset, we obtain ground truth segmentations using a specialized algorithm with intense computational requirements, combined with manual work and QC [9] . We use a subset of these segmentations to learn the prior probability parameters. We treat the rest of the dataset as unsupervised, where we only use the ground truth segmentations as validation. For the second dataset we do not have ground truth, offering a realistic scenario. Figure 3 shows example images from the two datasets, highlighting the difference, and the difficulty of the task."}, {"section_title": "Data T1w scan dataset", "text": "We gathered a large-scale multi-site, multi-study dataset of more than 14,000 T1-weighted brain MRI scans from eight publicly available datasets: including data from ADNI [25] , OASIS [20] , ABIDE [7] , ADHD200 [22] , MCIC [11] , PPMI [21] , HABS [6] , and Harvard GSP [14] . Subject age ranges, health states, and acquisition details vary with each dataset, but all scans were resampled to a 256x256x256 grid with 1mm isotropic voxels, and all images cropped to 160x192x224 to eliminate entirely-background voxels.\nWe carry out standard pre-processing steps, including affine spatial normalization using FreeSurfer for each scan [9] . All MRIs were also segmented with FreeSurfer -a task that takes several CPU hours per scan. We also applied quality control (QC) using visual inspection to catch gross errors in segmentation results.\nWe partitioned the data into a prior training subset of 5,000 images, where we only used the annotations. The rest of the data was treated as an unannotated dataset, where QCed segmentations were only used for validation.\nWhile developing the network architectures we partitioned the rest of the data into training, validation and test sets. Once the architecture was fixed, we reported results on the test dataset by training and evaluating the model in an unsupervised fashion."}, {"section_title": "T2-FLAIR scan dataset", "text": "We also gathered a dataset of more than 3800 T2-FLAIR scans, a significantly different MR modality, from the ADNI cohort. These scans exhibit significantly different tissue properties compared to the T1w images, lower acquisition quality, and exhibit 5mm slice spacing (Figure 3 ). They provide a good test of our hypothesis that priors learned are useful for segmenting image data with different tissue properties. To our knowledge there is no automatic method to obtain detailed anatomical segmentations for these images. We affinely align these images to the same space as the T1 ground truth prediction images using mutual information based affine registration with ANTs [2] . We perform brain extraction using an inhouse developed neural network-based algorithm that uses a UNet architecture and extensive data augmentation.\nIn the set of annotations that we used to train the prior, we avoided including any annotations coming from ADNI subjects whose T2-FLAIR scans are in this dataset."}, {"section_title": "Evaluation", "text": "We evaluate our results both visually and quantitatively. For the T1w dataset, we use a volume overlap measure, Dice, to quantify the automatic segmentation results [8] :\n. (17) where s is the predicted segmentation map, and s t indicates the ground truth (FreeSurfer) label at each location. A Dice score of 1 indicates perfect segmentation. We experimented segmenting in the unsupervised setting with standard UNet architectures, using the image MSE and mutual information loss functions. Because of the many structures that share similar intensities, these architectures are not able to produce sensible segmentations that resemble the correct segmentations, and we omit them from these results. Classical unsupervised methods that include sophisticated prior anatomical information take a significant amount time to run, and for T1w we regard FreeSurfer results as an optimistic bound for the T1w data. However, as these methods tend to be focused on specific modalities, there is no annotation tool for cortical and subcortical regions in T2-FLAIR. We evaluate the T2-FLAIR segmentation visually in Figure 5 ."}, {"section_title": "Results", "text": "At test time, a new subject only needs to be affinely registered to a template, after which the proposed CNN model evaluates a segmentation estimate. The entire process takes less than a few seconds on an NVidia Titan X GPU. Fig. 4 shows a series of example segmentations for the T1w dataset demonstrating that our method is able to estimate approximate anatomical structures, reproducing the general location as well as the shape of structures. Fine details, such as details of cortex folding, is not easily captured by the prior encoding, leading to smooth segmentation predictions. Fig. 6 illustrates the average Dice measure across several anatomical regions for T1 scans. We focus on the most prevalent (larger) structures, which can also be evaluated in detail in the visualizations of Figure 4 . Fig. 5 shows results of our algorithm on T2-FLAIR scans. Even with the significantly lower image quality and different tissue contrasts, our algorithm is able to use the prior information to predict plausible segmentations, even given challenging images in this unsupervised scenario."}, {"section_title": "Discussion", "text": "Our method is able to detect anatomical structures that are guided by image contrast while respecting anatomical shapes according to the prior. Rapid, zero-shot segmentation is a challenging task, and has not been tackled by previous methods. As such, the absence of prior results makes it difficult to fully interpret current results. The detailed FreeSurfer results are an upper bound, which any model is unlikely to achieve in the unsupervised setting. We omit showing results from lower bound (simplistic) baselines, such as the unsupervised U-Net model described above, since these models yielded nonsensical segmentations. To the best of our knowledge, our results are the first for zeroshot neural-network based segmentation of brain structures. "}, {"section_title": "Conclusion", "text": "In this paper, we introduced a generative probabilistic model that employs a prior model learned through a convolutional neural network to compute segmentations in an unsupervised setting. We can interpret the anatomical prior as encouraging the neural network to predicting segmentation maps that come from a known distribution characterized by z while simultaneously producing images that agree with the observed scan. We demonstrate that our model enables segmentation using convolutional networks leading to rapid inference in a setting where segmentation is traditionally not possible, or takes hours to obtain for a single scan. The integration of priors promises to facilitate accurate anatomical segmentation in a variety of novel clinical problems with limited dataset availability."}]