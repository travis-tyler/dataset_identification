[{"section_title": "Abstract", "text": "We propose a novel method for the automatic segmentation of brain MRI images by using discriminative dictionary learning and sparse coding techniques. In the proposed method, dictionaries and classifiers are learned simultaneously from a set of brain atlases, which can then be used for the reconstruction and segmentation of an unseen target image. The proposed segmentation strategy is based on image reconstruction, which is in contrast to most existing atlas-based labeling approaches that rely on comparing image similarities between atlases and target images. In addition, we * Corresponding author. Tel: +44 20 7852 1982\nEmail address: t.tong11@imperial.ac.uk (Tong Tong) 1 Data used in the preparation of this article were obtained from the ADNI database (www.loni.ucla.edu/ADNI). As such, the investigators within the ADNI contributed to the design and implementation of ADNI and/or provided data but did not participate in analysis or writing of this report. A complete listing of ADNI investigators can be found at: www.loni.ucla.edu/ADNI/Collaboration/ADNI Authorship list.pdf "}, {"section_title": "Introduction", "text": "The accurate and robust labeling of anatomical structures is an essential step in quantitative brain magnetic resonance imaging (MRI) analysis. Many clinical applications rely on the segmentation of MRI brain structures, which enables us to describe how brain anatomy changes during aging or disease progression. Since manual labeling by clinical experts is subject to inter and intra rater variability and is also a highly laborious task, an automated technique is desirable to enable a routine analysis of brain MRIs in clinical use.\nDespite the large number of existing techniques (Chupin et al., 2007; van der Lijn et al., 2008; Aljabar et al., 2009; Wolz et al., 2010; Collins and Pruessner, 2010; Coup\u00e9 et al., 2011; Wang et al., 2011a) , it still remains a challenging task to develop fast and accurate automated segmentation methods due to the complexity of subcortical structures.\nMany automated methods have been introduced to extract cortical and subcortical structures in the past decade. Among them, atlas-based methods have been shown to outperform other state-of-the-art algorithms (Collins et al., 1995; Babalola et al., 2009 ). In atlas-based label propagation, an atlas is matched to the target image using image registration. The segmentation of the target image is then achieved by warping the atlas label to the target image space. Segmentation errors produced by atlas-based methods can be classified into random errors and systematic errors Wang et al., 2011a) . Random errors, which may be caused by image noise or subject variation, can be reduced by using multiple atlases (Rohlfing et al., 2004; Heckemann et al., 2006) or by selecting the most similar atlases for a given unseen image (Barnes et al., 2008; Aljabar et al., 2009; Artaechevarria et al., 2009) . Systematic errors occur consistently as the disagreement between manual and automatic segmentations exhibits a systematic pattern, which may be caused by consistent errors in the registration, partial volume effects or bias in the manual labeling of the atlases. For example, a manual segmentation protocol may follow a specific anatomical criterion to assign labels to different voxels. However, an automatic method may employ a slightly different criterion, which causes systematic labeling errors.\nRecent work has been proposed to reduce such errors such as intensity models (van der Lijn et al., 2008; Wolz et al., 2009; Lotjonen et al., 2010) or a learning-based method (Wang et al., 2011a) . Several label fusion techniques have also been used to improve segmentation accuracy of the multi-atlas segmentation method such as majority voting (Kittler, 1998; Aljabar et al., 2009; Collins and Pruessner, 2010) , STAPLE (Warfield et al., 2004) and local weighted label fusion (Artaechevarria et al., 2009; Sabuncu et al., 2010; Khan et al., 2011; Wang et al., 2011c,b) . However, multi-atlas segmentation requires pairwise, accurate registrations between atlas and target, which can result in a significant computational burden.\nRecently, nonlocal patch-based segmentation techniques have been proposed Rousseau et al., 2011) to avoid the need of accurate non-rigid registration in order to gain computational efficiency.\nInstead of fusing propagated label maps as in multi-atlas segmentation, this method obtains a label for every voxel by using similar image patches from coarsely aligned atlases. First, image patches are extracted in a predefined neighborhood around a particular voxel and across the training atlases.\nThen, weights are given to these patches according to the similarity between the target patch and the extracted atlas patches. The final label of the target voxel is estimated by fusing the labels of the central voxels in the template patch library. Such a technique allows one-to-many correspondences to select the most similar patches for label fusion, and a validation on hippocampus segmentation demonstrates a high accuracy of this approach.\nAlthough the local weighting label fusion strategy (Artaechevarria et al., 2009; Sabuncu et al., 2010; Khan et al., 2011; Wang et al., 2011c,b) or the nonlocal patch-based technique Eskildsen et al., 2011; Rousseau et al., 2011) can produce accurate segmentation results, these methods are based on the similarity of image patches extracted from each atlas. However, image similarities over small image patches may not be an optimal estimator (Wang and Yushkevich, 2012) . In this paper, we propose a novel segmentation method based on image patch reconstruction. The proposed approach uses discriminative dictionary learning methods (Zhang and Li, 2010; Jiang et al., 2011; Yang et al., 2011a) and sparse coding techniques (Wright et al., 2009 ). These methods have been successfully applied to different problems in face recognition (Wright et al., 2009; Zhang and Li, 2010; Jiang et al., 2011; Yang et al., 2011a) . To the best of our knowledge, these methods have never been used in subcortical brain segmentation.\nThe proposed method learns discriminative appearance dictionaries and is different from the recent work in (Zhang et al., 2012) , which learns shape dictionaries for liver segmentations. In the proposed method, we abandon the conventional idea to compare the similarity between patches in a neighborhood. Instead, a dictionary and a linear classifier are learned from the template patch library simultaneously for every voxel in the target image.\nThe surrounding patch of the target voxel can be reconstructed by the corresponding dictionary and the label of the target voxel will be estimated by the corresponding classifier. Moreover, a new strategy has been proposed to implement the method in an efficient way by learning dictionaries offline and performing segmentation online.\nIn the remainder, we will first introduce the methodology of discriminative dictionary learning and how we apply it to the segmentation of brain MR images. The proposed method was evaluated on hippocampus segmentations on 202 ADNI images (Mueller et al., 2005) and 80 healthy ICBM subjects (Mazziotta et al., 1995) . We studied the influence of different parameters and compared the performance of the proposed methods with that of the nonlocal patch-based technique. The performance of different methods has been compared on different subject groups of the ADNI dataset. Finally, we discuss the strengths and weaknesses of the proposed method and conclude the paper."}, {"section_title": "Materials and Methods", "text": ""}, {"section_title": "Datasets", "text": "Two different datasets were used for hippocampus segmentations. Images obtained from the Alzheimer's Disease Neuroimaging Initiative (ADNI) database (www.loni.ucla.edu/ADNI) (Mueller et al., 2005) and images obtained from the International Consortium for Brain Mapping (ICBM) database (Mazziotta et al., 1995) were used to evaluate the proposed approach.\nIn the ADNI study, brain MR images are acquired at regular intervals from approximately 200 cognitively normal older individuals, 400 people with Mild Cognitive Impairment (MCI), and 200 people with early AD. A more detailed description of the ADNI study is given in Appendix A. The subgroup we used consists of 202 subjects obtained from different scanners (68 normal subjects, 93 subjects with MCI and 41 patients with AD). An overview of these 202 subjects is shown in Table 1 . These 202 images were selected because their reference segmentations are available through ADNI. The selected subgroup is representative of the whole ADNI dataset as no significant difference was observed on age and MMSE scores between the selected group and the whole dataset on Students t-test (p > 0.1). A commercially available high dimensional brain mapping tool (Medtronic Surgical Navigation Technologies, Louisville, CO) was used to carry out semi-automated hippocampal volumetry for defining these reference segmentations. These label maps were inspected and if necessary manually corrected by qualified reviewers (Hsu et al., 2002 For a direct comparison with the previously published patch-based method, the proposed method was also evaluated on a subset of the ICBM dataset, which consists of 80 healthy subjects (Mazziotta et al., 1995) . The T1-weighted data were acquired at the Montreal Neurological Institute on a Philips Gyroscan 1.5 T scanner with 3D spoiled gradient-echo acquisition with TR=17 ms, TE=10ms, flip angle=30\n\u2022 , and a resolution of 1 mm 3 voxels. The 80 subjects consist of 39 males and 41 females of similar ages (mean age: 25.09 \u00b1 4.9 years). The MR images were manually segmented by an expert directly in stereotaxic space using the protocol described in (Pruessner et al., 2000) . The resulting segmentations obtained an intraclass reliability coefficient (ICC) of 0.900 for inter-rater reliability (4 raters) and 0.925 for intra-rater reliability (5 repeats). "}, {"section_title": "Overview of the method", "text": "The basic assumption of non-local means patch-based segmentation is that the central voxels of similar patches are considered to belong to the same structure . This method assigns higher weights to similar patches and smaller weights to dissimilar patches. As a result, similar patches from each training atlas contribute more to the final label estimation.\nThe assumption of our method is that the target patch which will be labeled can be represented by a few template patches from the same structure in a low-dimensional manifold or by a few representative atoms from a learned dictionary. After the coding of the target patch, the target voxel is labeled based on the coding coefficients and the dictionary. Therefore, there are two phases for labeling a voxel in the proposed method: coding and classification.\nIn the proposed method, a different dictionary is learned for labeling each different target voxel, which means that the learned dictionaries are voxel based. Based on different types of dictionaries used for coding, we divided our proposed method into two groups: Sparse Representation Classification (SRC) and Discriminative Dictionary Learning for Segmentation (DDLS).\nFor SRC, the whole template patch library is directly defined as the dictionary for sparse coding. In this predefined dictionary, each atom is a patch extracted from an atlas image and we then know the corresponding labels of all the atoms. After the target patch is coded by this predefined dictionary, the labeling of the target voxel is done by assessing which group of patches provides the minimal reconstruction error.\nHowever, the direct way of using all the training patches as the dictionary may result in a huge size for the dictionary, increasing the coding complexity. In addition, this predefined dictionary may not fully exploit the discriminative information in the training patch library. In this paper, we also extend the proposed SRC method by learning discriminative dictionaries for segmentation. In this DDLS method, a small-sized dictionary and a linear classifier are learned from the template training patch library, which will provide reconstructive and discriminative information for MR brain segmentation work. Figure 1 demonstrates the proposed segmentation process for one target voxel and compares the major differences with non-local means patch-based methods.\nIn the proposed SRC and DDLS approaches, the coding procedure by dictionaries replaces the patch similarity weighting in the patch-based segmentation strategy. However, each subject is segmented by learning specific dictionaries from the atlas database, which will be computationally expensive. The ultimate goal of our work is to learn fixed dictionaries and classifiers offline. Then, segmentations can be performed online by using the fixed dictionaries and classifiers. In order to do this, we also proposed a Fixed Discriminative Dictionary Learning for Segmentation (F-DDLS) strategy, which could enable a significant speed-up in the segmentation phase. This F-DDLS strategy has been evaluated on the ICBM dataset and different subject groups of the ADNI dataset."}, {"section_title": "Sparse Representation Classification", "text": "The SRC method uses a template patch library as a predefined dictionary.\nFirst, the extraction of a patch library from atlases will be introduced. Then, this predefined dictionary will be used for the reconstruction of a target patch and the sparse coding process will be introduced. Finally, the sparse representation of the target patch and the labels of center voxels of template patches will be used for estimating the label of the target voxel.\nConstruction of patch library: First, atlas selection is carried out for every target subject based on the sum of squared intensity differences (SSD) in a template space as done in . Then for labeling a target voxel in the target image, the surrounding patch (illustrated by the red box overlaid on the target image in Figure 1 ) is extracted and denoted as the target patch p t in this paper. A search volume V i (illustrated by the blue box overlaid on the atlas images in Figure 1 ) is defined in each atlas image. All template patches in the search volume across a set of similar atlases are extracted to form a patch library. The number of patches in the patch library is proportional to the search volume size and typically contains thousands of patches. Each patch in the library is a volume. We denote each patch as a column vector and group all the patches together as a matrix P L .\nSuppose that the patch library contains n patches, then the patch library can be represented as\nInspired by work in face recognition (Wright et al., 2009) , we propose to use a sparse representation classification strategy for patch selection and weighting. In the SRC method, the patch library is directly considered as a dictionary, so the target patch p t will approximately lie in the subspace spanned by the training patches in the library P L :\nSince the SRC method imposes a constraint that the representation is sparse, most of the coefficients a i will be zero. Let a = [a 1 , a 2 , \u00b7 \u00b7 \u00b7 , a n ] \u2208 R n , then the sparse solution can be obtained by solving the following equation:\nwhere the l 0 -norm denotes the number of nonzero coefficients, which is the sparse constraint of this equation. The linear system p t = P L a is underdetermined since n > m, so this equation does not have a unique solution. It is difficult to approximate the sparsest solution of an underdetermined system of linear equations because the problem is NP-hard. In general, if the solution of Equation (2) is sparse enough, then it can be shown to be equivalent to the solution of the following l 1 -minimization problem (Wright et al., 2009 ):\nEquation (3) can be solved efficiently by several sparse coding methods (Yang et al., 2010) . In Wright et al. (2009) , Equation (3) was solved using the Lasso method (Tibshirani, 1996) . The L 1 Lasso is a relaxed version of Equation (3). However, if the number of predictors (n) is much higher than the number of observations (k), the Elastic Net (EN) approach always outperforms the Lasso method for achieving a satisfactory variable selection (Zou and Hastie, 2005) . Considering that the number of patches in the library is much higher than the number of patches selected for representation, our case belongs to this 'large n small k' problem. To achieve robust sparse representations, EN (Zou and Hastie, 2005) has been used for obtaining the sparse coding coefficients:\nEquation (4) adds a coefficient magnitude penalty to the objective function in Equation (3), which is a convex combination of L 1 lasso and L 2 ridge penalties. EN encourages a grouping effect while keeping a similar sparsity of representation (Zou and Hastie, 2005) . This grouping effect, which selects groups of highly correlated variables, is helpful for the final classification and could thus improve the segmentation performance.\nAfter we obtain the sparse solution, the labeling of the target voxel is based on the coding coefficients\u00e2 and the selected patches for representation.\nThe main idea is that the sparse nonzero coefficients should concentrate on the training patches with the same class label as the target patch. This means that the training patches from the correct class will yield the minimal reconstruction error when the coding coefficients are computed using training patches from all classes. There are two key points in our assumption. First, the coding coefficients are very sparse. In fact, both the training patches from the correct class and the wrong class can represent the target patch very well if enough training patches from each class are given. However, when the sparsity is imposed on the coding coefficients, each class can only use a few patches to represent the target patch. In this case, the training patches from the correct class are likely to represent the target patch with less error. Second, the coding coefficients are computed using all classes, which also helps for classification. This is because the training patches from each class will compete to represent the target patch in the same process.\nThese two points were verified in Yang et al. (2011b) . Therefore, the labeling of the target voxel is achieved by comparing which class of training patches gives the minimal reconstruction error. The residual (reconstruction error) with the sparse coefficients\u00e2 j associated to each structure/class j is described as:\nThe label value v for the center voxel of target patch p t is assigned as the class with the minimum residual over all classes:\nIn our case, the patches associated with non-zero coefficients are divided into two groups (C = 2): patches belonging to the hippocampus and patches belonging to the background. If the patches belonging to the hippocampus can represent the target patch p t with a smaller reconstruction error, then the target voxel is labelled as hippocampus, and vice versa."}, {"section_title": "Discriminative Dictionary Learning", "text": "In the above SRC scheme, a large number of training patches are directly used as the predefined dictionary, which will increase the computational burden on the sparse coding process. Also, this predefined dictionary may not fully exploit the discriminative information in the training patch library.\nThese drawbacks may be overcome by learning a small-sized task-specific dictionary. Several methods have been proposed for learning a small-sized dictionary (Mairal et al., 2008 (Mairal et al., , 2009b Zhang and Li, 2010; Jiang et al., 2011; Yang et al., 2011a ) that has good reconstructive power and discriminative ability. In particular, the method proposed in (Zhang and Li, 2010) incorporated the classification error into the objective function of the K-SVD algorithm, which allows to learn the dictionary and the classifier by the same optimization procedure simultaneously. In this paper, we used a similar idea as described in (Zhang and Li, 2010) for our segmentation purpose. Let\ndenote the training patch library, containing n patches. A reconstructive dictionary with K atoms can be learned from the input patch library P L by solving the following problem:\nwhere\nis the sparse coding coefficient matrix of the input patch library, and T is a sparsity constraint parameter. In Equation (7), the objective function includes the reconstruction error term and the sparsity constraint term without considering the discriminative power. Thus, the learned dictionary is not suitable for our classification task. To address this problem, a linear classifier f (\u03b1, W ) = W \u03b1 as in (Zhang and Li, 2010) was added to the objective function for learning dictionaries with both reconstructive and discriminative power. The objective function can then be defined as follows:\nwhere the classification error term H \u2212 W \u03b1 2 2 is added to Equation (7). H represents the labels of the central voxels of the patches in the library P L .\nEach column of H is a label vector corresponding to a template patch. Each In (Zhang and Li, 2010; Jiang et al., 2011) , the problem of Equation (8) was solved by using the K-SVD algorithm since only one dictionary was required for the face recognition task under study. However, due to the high anatomical variability across subjects' brain scans, it is difficult to achieve good segmentation performance by just learning one dictionary and a single global classifier. Therefore, in our work, a dictionary and a corresponding classifier are learned for every target voxel. In this case, there will be thousands of dictionaries to be learned for every target subject and it will be very computationally expensive if the K-SVD algorithm is used for solving Equation (8). Here, we use an online dictionary learning algorithm as proposed in (Mairal et al., 2009a) , which has faster performance and generates better dictionaries than classical batch learning algorithms. Appendix B shows how Equation (8) is solved by using the online dictionary learning algorithm.\nAfter Equation (8) is solved, a dictionaryD t and a classifier\u0174 are learned for every target voxel. Figure 2 shows an example of the learned dictionar\u0177 D t . For labeling the target voxel, the surrounding patch p t is first extracted.\nThen, the sparse representation\u03b1 t of the target patch p t is computed by solving the following problem:\nEquation (9) is a relaxed version of Equation (3). Finally, we can estimate the label value v of the target voxel by using the linear predictive classifier:\nFigure 2: An example of a learned dictionary. The dictionary has 16x16 atoms of size 5 3 .\nThis figure shows a slice of this dictionary.\nwhere h t is the class label vector for the target voxel. The label value v of the target voxel is decided by the index of the largest element in label vector h t . Ideally, h t will be {0, 0, \u00b7 \u00b7 \u00b7 , 1, \u00b7 \u00b7 \u00b7 , 0, 0} with only one non-zero element, indicating the label of the class. In our binary segmentation, there are only two elements in label vector h t , the values of which indicate the probability belonging to hippocampus and the probability belonging to the background respectively."}, {"section_title": "Experiments and Results", "text": "The proposed methods were applied to 202 images from the ADNI database and 80 images from the ICBM database. The ADNI images were preprocessed by the ADNI pipline described in (Jack et al., 2008) and the ICBM images were preprocessed as described in . All images were linearly registered to the MNI152 template space by using affine registrations. Image intensities were then normalized by using the method proposed in (Nyul and Udupa, 2000) . After that, intensities were rescaled to the interval [0 100]. Finally, a leave-one-out procedure was used in our validation and the most similar subjects were selected by comparing the squared intensity differences (SSD) in the MNI152 template space as described in Section 2.3.\nFor the ADNI images, all segmentations were performed in the native image space because the reference segmentations of the hippocampus are defined in native space. Transforming the labels and MR images into template space would decrease label accuracy due to interpolation artefacts of the target reference segmentations. After atlas selection in the MNI152 template space, we affinely transformed the selected atlases and labels to the native space of the target image to perform the segmentation in the target coordinate system.\nFor the ICBM images, all the segmentations were performed in the MNI152 template space as the labels are defined in the template space. The influence of different parameters were studied on segmenting the hippocampus on the 202 ADNI images. After the optimal parameters were estimated, both datasets were used to compare the performance of different methods.\nFor learning dictionaries, the parameter \u03b2 1 in Equation (B.2) was set to 1 and \u03b2 2 was set to 0.15 for all experiments. \u03b2 2 was determined via cross validation according to the parameter settings described in (Mairal et al., 2012) . During parameter optimization, when a certain parameter was optimized, the other parameters were set to fixed values. Since neighborhood voxels share most of the template patches and will have very similar dictionaries and classifiers, we used a sampling strategy to train the dictionaries in order to achieve a better performance. Dictionaries are trained for every n (n > 1) voxels rather than every voxel. In theory, this strategy will achieve an approximate n 3 speedup for the training process. In order to label target voxels without a corresponding dictionary, we use neighbor dictionaries to perform sparse coding for its target patch. Since neighborhood voxels share most of their template patches and will have very similar dictionaries and classifiers, this sampling strategy will not result in a dramatic degradation of the segmentation accuracy. In our 3D segmentation work, we used 6 nearest neighbor dictionaries for sparse coding for all experiments. By using the same classification strategy, we could obtain 6 class label vectors for the target voxel. The final label value is estimated by using the average of these label vectors. Finally, all the experiments were evaluated by computing the Dice coefficient between the reference segmentations and the automated segmentations."}, {"section_title": "Influence of Parameters for Dictionary Training", "text": "First, experiments were carried out to study the influence of the dictionary size K (the number of atoms in each dictionary) on segmentation accuracy. for each target image. We found that the larger the size of dictionaries was, the higher the achieved overlap value was. However, the improvement using K > 256 over K = 256 is not significant and more time is required for learning a larger size of dictionaries. Considering the trade-off between computational time and segmentation accuracy, we chose K = 256 for the following experiments according to the results shown in Figure 3 .\nSince a sampling strategy was used for learning dictionaries, the influence of the sampling step size l on segmentation accuracy was also studied. The sampling step size l means that dictionaries are trained for every lth voxel.\nAs expected, the smaller sampling step size we used for learning dictionaries, the more dictionaries we could get and the higher median Dice index could be achieved. However, we could gain more computational efficiency by learning fewer dictionaries. Based on the results shown in Figure 4 , a sampling step size of 3 (every third voxels for learning dictionaries) is a good choice for balancing the speed and accuracy of the proposed method."}, {"section_title": "Influence of Patch Size and Neighborhood Size", "text": "The influence of patch size and neighborhood size was also studied on the ADNI dataset. The patch size is related to the local geometry and the neighborhood size reflects the anatomical variability .\nThe Dice coefficient distributions over varying patch and neighborhood sizes are presented in Figure 5 and 6. The best median Dice coefficient was obtained with a patch size of 5 \u00d7 5 \u00d7 5 and a neighborhood size of 7 \u00d7 7 \u00d7 7.\nTherefore, we used these parameter settings for all other experiments. voxels and a search volume of 7 \u00d7 7 \u00d7 7 voxels. The median Dice coefficient is 0.864 when using 30 subjects for offline training and the remaining 172 subjects for online testing."}, {"section_title": "Influence of the number of training atlases", "text": "We also studied the impact of the number of training atlases on the performance of the proposed method. The results for varying numbers of training atlases out of the 202 ADNI images are shown in Figure 7 . As can be seen, increasing the number of training atlases provides higher median\nDice overlap values. The best median Dice coefficient is 0.879 by selecting 25 atlases, which is a small improvement in comparison with a median Dice value of 0.872 by using 10 atlases. As can be seen in Figure 7 , the median Dice coefficient stabilizes around 10 atlases, which is similar to the trends reported in Rousseau et al., 2011) . Therefore, we selected 10 atlases in our experiments as this produces comparable results with a significantly lower computational burden comparing to selecting 25 atlases, making the method more efficient and attractive."}, {"section_title": "Fixed Discriminative Dictionary Learning for Segmentation", "text": "The ultimate goal of our work is to learn fixed dictionaries offline. Then the learned dictionaries can be used to efficiently perform segmentation online. In order to do this, we randomly selected a subgroup of the whole dataset as the training atlases. Then discriminative dictionaries were trained from these randomly selected training atlases. Finally, the same testing procedure as described in Section 2.4 was performed to segment the remaining testing subjects. The F-DDLS strategy was evaluated on the 80 healthy ICBM subjects. 40 images were randomly selected for training dictionaries and classifiers. The remaining 40 atlases were used for testing. The experiment was repeated 10 times. The results are presented in Figure 8 . The for training. The other results were obtained by using the 10 most similar atlases in a leave-one-out procedure. The Patch-based and SRC methods were implemented by using a patch size of 7 \u00d7 7 \u00d7 7 voxels and a search volume of 9 \u00d7 9 \u00d7 9 voxels. The DDLS and F-DDLS methods were implemented by using a sampling step size of 3, a patch size of 5 \u00d7 5 \u00d7 5 voxels and a search volume of 7 \u00d7 7 \u00d7 7 voxels.\naverage median Dice coefficient is 0.887. These results indicate that the proposed F-DDLS strategy can be performed in a computationally more efficient way, while yielding comparable segmentation results. In particular, each unseen subject can be segmented in less than 1 minute by using the proposed F-DDLS strategy."}, {"section_title": "Discriminative Dictionary Learning for Segmentation using Fixed Training Dataset", "text": "For the ICBM dataset, all images were transformed to MNI template space and the reference segmentations were then carried out in this space.\nSince label images and MRIs are in the same space for the whole dataset, fixed dictionaries can directly be learned in this common space. For the ADNI dataset, the segmentations were performed in the target image space because the reference segmentation is defined in this space. We used a work-around to simulate a common space for the whole dataset: after randomly selecting a fixed training subgroup, dictionaries were learned after warping the training images to the testing target image space. Although the learned dictionaries were not fixed in different spaces, they were learned from the fixed training dataset. Therefore, the dictionaries can be regarded as identical dictionaries transformed to different coordinate space.\nWe compared the results by using different numbers of training atlases in the fixed subgroup. The results are presented in Figure 9 . By using the simulated fixed discriminative dictionary learning strategy, the median Dice coefficient is 0.864 when using 30 subjects for training and the remaining 172 subjects for testing. Although this is slightly lower than the median Dice coefficient (0.879) by selecting 25 atlases in a leave-one-out procedure, it also demonstrates the effectiveness of the proposed method.\nWe also tested the proposed simulated F-DDLS method on different groups of data from ADNI. 30 healty subjects were randomly selected for training fixed dictionaries. Segmentations were then performed on the 41 AD subjects by using the learned dictionaries from healthy subjects. The performance of different methods on the 41 AD subjects are presented in Figure 10 . It can be seen that DDLS achieved the highest mean Dice coefficient of 0.866 for the segmentations of the 41 AD subjects, which is much higher than a mean Dice coefficient of 0.826 by using the nonlocal patch-based method. The mean Dice coefficient is 0.860 for the 41 AD subjects by using the simulated F-DDLS method, which shows that the proposed method is able to generalize from one type of data to morphologically different datasets."}, {"section_title": "Comparison with other methods", "text": "The proposed DDLS and SRC were compared with the nonlocal patchbased technique proposed in . For the proposed DDLS method, we used a sampling step size of 3, a patch size of 5 \u00d7 5 \u00d7 5 and a neighborhood size of 7 \u00d7 7 \u00d7 7 as suggested in Section 3.2. For SRC, 80 patches were selected for representation and classification. \u03bb 1 and \u03bb 2 were set to 0.15 for obtaining the sparse representation to solve Equation (4).\nThese two parameters were determined via cross validation following the parameter settings described in (Mairal et al., 2012) . For a fair comparison, the nonlocal patch-based method was carried out in the same settings (a patch size of 7 \u00d7 7 \u00d7 7 voxels and a search volume of 9 \u00d7 9 \u00d7 9 voxels) as described in . The same patch preselection process as described in obtained by randomly selecting 40 atlases for training and using the remaining 40 subjects for evluation. The experiment was repeated 10 times. The other results were obtained by using the most similar 20 atlases in a leave-one-out procedure. The Patch-based and SRC methods were implemented by using a patch size of 7 \u00d7 7 \u00d7 7 voxels and a search volume of 9 \u00d7 9 \u00d7 9 voxels. The DDLS and F-DDLS methods were implemented by using a sampling step size of 3, a patch size of 5 \u00d7 5 \u00d7 5 voxels and a search volume of 7 \u00d7 7 \u00d7 7 voxels.\nThe difference between Patch-based and DDLS is statistically significant with p<0.001 on obtained by randomly selecting 30 atlases for training and using the remaining 172 subjects for evluation. The other results were obtained by using the 10 most similar atlases in a leave-one-out procedure. The Patch-based and SRC methods were implemented by using a patch size of 7 \u00d7 7 \u00d7 7 voxels and a search volume of 9 \u00d7 9 \u00d7 9 voxels. The DDLS and F-DDLS methods were implemented by using a sampling step size of 3, a patch size of 5\u00d75\u00d75 voxels and a search volume of 7\u00d77\u00d77 voxels. The difference between Patch-based and DDLS is statistically significant with p<0.001 on Students two-tailed paired t-test.\nBest subject and SRC method in order to reduce computational time.\nFor a direct and fair comparison with the nonlocal patch-based method, hippocampus segmentations were performed on the 80 healthy ICBM subjects in the MNI152 template space. 20 atlases were selected in a leaveone-out procedure for each target image as suggested in .\nThe patch-based method obtained a median Dice value of 0.882, the proposed SRC approach obtained 0.888, and the proposed DDLS obtained 0.890. Although the SRC method produces similar results as those produced by DDLS, the latter can be implemented with a much faster speed than the SRC method (as discussed in the next section). The DDLS method obtained significantly better results than the patch-based method with a p-value 0.001 using Students two-tailed paired t-test.\nHippocampus segmentations on the 202 ADNI images were performed in the native image space. 10 atlases were selected in a leave-one-out procedure for each target image. Table 3 presents the median Dice coefficients of these three approaches. The median Dice coefficient is 0.872 by using the proposed DDLS and 0.871 by using SRC, both of which is higher than the median Dice value of 0.844 by using the nonlocal patch-based method. Figure 11 provides a visual comparison of the segmentation results by using these three methods. We also compared the performances of these three methods on four different groups of subjects. Figure 12 shows the mean Dice coefficients for the segmentations of 68 control subjects, 49 stable MCI subjects, 44\nprogressive MCI subjects and 41 AD patients. As revealed in Figure 12 , the segmentation accuracy decreases with disease progression, which indicates that smaller hippocampi, due to atrophy, are more challenging for automated segmentation approaches."}, {"section_title": "Computational time", "text": "We implemented the DDLS and SRC methods in MATLAB 7.13.0 using C/MEX code. The SPAMS software (http://spams-devel.gforge.inria.fr) was used for dictionary learning and sparse coding. Since the patch-based method is not open source, we used our version in a C++ implementation. The experiments were carried out using a single core of an Intel Core i7-2600 processor at 3.4 GHz with 8 GB of RAM. It took approximately 10 minutes for segmenting one subject by using the patch-based method with a patch size of 7 \u00d7 7 \u00d7 7, a neighborhood size of 9 \u00d7 9 \u00d7 9 and 10 similar atlases.\nThe SRC method took around 40 minutes for segmenting one subject with the same parameter settings. For the proposed DDLS method, it took 3-6 minutes to segment one subject with the suggested parameter settings (a sampling step size of 3, a dictionary size of 256, a patch size of 5 \u00d7 5 \u00d7 5, a neighborhood size of 7 \u00d7 7 \u00d7 7 and 10 similar atlases). However, if one wants to achieve more accurate results by learning more dictionaries with a larger size, it will be more time consuming. In addition, if fixed dictionaries are trained offline, it only takes less than 1 minute for segmenting one subject in the testing stage with less than a 1.5%-drop in Dice overlap compared to the results by using the DDLS method."}, {"section_title": "Discussion and Conclusion", "text": "In this work we developed a novel approach for the segmentation of subcortical brain structures. Dictionary learning and sparse coding techniques have been proposed for the segmentation of brain MRI images. In contrast to other methods that rely on intensity similarities, the proposed method is based on the minimization of patch reconstruction errors. Dictionaries and classifiers are learned from atlases in one framework simultaneously.\nThe learned dictionaries can be used for patch reconstruction and the corre- In order to reduce the computational burden of the dictionary learning process, we combined the online algorithm (Mairal et al., 2009a) with the discriminative dictionary learning approach (Zhang and Li, 2010) . We also used a sampling strategy to learn the dictionaries so that the runtime of training will be shortened significantly. The dictionary and classifier related to one target voxel are learned from patches extracted in a local search volume across the atlases. Therefore, neighborhood voxels share most of template patches and will have very similar dictionaries and classifiers. This means that neigh-borhood voxels can share dictionaries and classifiers. This may explain why the proposed sampling strategy still keeps almost the same accuracy, while generating a much faster implementation. The proposed method also uses affine registrations rather than non-rigid registrations in order to gain computational efficiency as described in the non-local means patch-based method Rousseau et al., 2011) . In the end, an unseen subject can be segmented in approximately 6 minutes while keeping a high segmentation accuracy.\nDue to different datasets for evaluation and different qualities of manual segmentations, comparison with state-of-the-art methods is always difficult.\nRecent works (Chupin et al., 2007; Barnes et al., 2008; Aljabar et al., 2009; Wolz et al., 2010; Collins and Pruessner, 2010; Coup\u00e9 et al., 2011; Wang et al., 2011a) reported Dice values greater than 0.80 for hippocampus segmentation.\nOur approach can yield results comparable or more accurate than these recent published results. Our proposed method was also evaluated on the same 80 healthy ICBM subjects as those used for validations of methods proposed in (Collins and Pruessner, 2010; Coup\u00e9 et al., 2011; Hu et al., 2011) . A median Dice value of 0.87-0.886 was achieved in these works. In comparison, our method can achieve similar or slightly improved results with a very fast implementation, especially compared to the multi-atlas method as described in (Collins and Pruessner, 2010) .\nThe results obtained on the ICBM dataset showed a higher Dice overlap In recent work (Wang et al., 2011b; Shu et al., 2012) , sparse coding techniques were also used for medical image segmentation. These methods directly used training patches as dictionaries, which are similar to the proposed SRC approach except the label fusion strategy. Weighted voting was used to fuse the labels in these approaches while the reconstruction error was used in the proposed SRC method. A further experiment was performed to compare these two different label fusion strategies. The median Dice overlaps using weighted voting as the label fusion strategy are 0.870(0.023) on the ADNI dataset and 0.887(0.019) on the ICBM dataset respectively, which are nearly identical to the results by using reconstruction error as the label fusion strategy (0.871(0.022) and 0.888(0.019) respectively). These results\nshow that both weighted voting and reconstruction error can be chosen as reliable label fusion strategies. However, it should be noted that weighted\nvoting cannot be used to estimate the labels in the proposed DDLS and F-DDLS approaches because the corresponding labels of the atoms in the dictionaries are unknown.\nAlthough the proposed method can produce accurate results in a very efficient way, there are several aspects that may improve the proposed method.\n(1) First, the proposed approach will be improved if one discriminative dictionary with a larger size is learned for every voxel without using the sampling strategy. However, this will increase the computational cost significantly.\nThe segmentation accuracy may be improved if more complicated classifiers rather than linear classifiers are learned (Mairal et al., 2008 (Mairal et al., , 2009b . Moreover, the discriminative information in the sparse coding coefficients could be also exploited and added to the objective function (Yang et al., 2011a) to improve the segmentation accuracy, although this may lead to a complicated optimization process of dictionary learning. (3) The use of non-registration instead of affine registration may also improve the segmentation results as reported in (Rousseau et al., 2011; Fonov et al., 2012) . (4) Segmentation accuracy may be improved by using intensity models (Wolz et al., 2009; Lotjonen et al., 2010) or a learning-based method (Wang et al., 2011a) to correct systematic errors of the proposed method.\nIn Section 3.4, we also used a fixed subgroup of subjects as atlases to learn dictionaries and classifiers. The aim of this experiment was trying to learn a new format of 'atlases' and 'labels'. The dictionaries are learned from atlas images, which will contain the information of atlas images and can then be considered as new 'atlases'. Also, the corresponding classifiers contain the prior information of reference segmentations and can then be considered as new 'labels'. It may take several days to learn very good representative dictionaries and optimal discriminative classifiers offline. Once learned, it is possible to segment one target image very quickly (less than 1 minute)\nby using the new format of 'atlases' (dictionaries) and 'labels' (classifiers).\nAlthough the median Dice value by using F-DDLS strategy drops slightly (less than 1.5%) compared to the results by using the DDLS method, it indicates that this may be a very potential direction for human brain labeling in future work.\nWhen comparing the DDLS and F-DDLS methods, the DDLS method can achieve a better performance because it selects the most similar atlases for segmentation while in the F-DDLS method, atlases are randomly selected for segmentation, which indicates that the proposed method will have a better performance if similar types of data are used. However, the F-DDLS still achieves promising segmentation results. This means that this approach is able to segment images reliably without explicitly choosing atlases similar to the test data. The futher experiment that was validated on different groups of datasets shows that the proposed F-DDLS method is able to generalize from one type of data to morphologically different datasets. The main reason may be that the proposed method learns dictionaries at a very localised level rather than a global one. However, It should be noted that the dictionaries were trained on the same imaging modality (T1 images) with the same manual segmentation protocol in our work. If the segmentation protocol, acquisition protocol or imaging modality changes, the dictionaries should be retrained.\nFuture research will focus on the extension of the proposed approach on the segmentation of multiple structures of brain MR images. In this paper, we just applied the proposed method to the segmentation of the hippocampus.\nHowever, it is possible to extend our proposed method to segment multiple structure by adding the corresponding label information to the label vector H in Equation (8). In addition, we plan to apply the proposed method to the measurement of hippocampal atrophy and patient classification as proposed in ."}, {"section_title": "Acknowledgments", "text": "This project is partially funded under the 7th Framework Programme by the European Commission (http://cordis.europa.eu/ist/). \nEach column of the input signalP L will thus include the original patch and its corresponding label information. Each atom of dictionaryD is always normalized. We also use the l 1 norm to achieve a sparse solution for \u03b1 in the dictionary optimization process. Equation (B.1) can be rewritten as: and can be efficiently solved by the online dictionary learning technique described in (Mairal et al., 2009a) . This online approach draws one patch from the patch library at a time for updating the dictionary. In our implementation, a mini-batch strategy (Mairal et al., 2009a) , which draws a few patches at each iteration rather than a single patch, was used to improve the convergence speed of online learning.\nAfter online dictionary learning, we obtain a dictionary and a classifier for every target voxel. The corresponding dictionary and classifier of the target patch p t can be represented as:\nwhere the learned dictionary and the corresponding classifier parameters are normalized jointly. As a result, we cannot use these dictionaries and the classifiers directly for labeling. However, the desired dictionaryD t and the classifier parameters\u0174 t can be computed fromD t :\n, . . . ,w\nThe proofs of Equation (B.4) is available in (Zhang and Li, 2010) ."}]