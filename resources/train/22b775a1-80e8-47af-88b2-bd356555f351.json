[{"section_title": "Abstract", "text": "Registration is an important task in automated medical image analysis. Although deep learning (DL) based image registration methods out perform time consuming conventional approaches, they are heavily dependent on training data and do not generalize well for new images types. We present a DL based approach that can register an image pair which is different from the training images. This is achieved by training generative adversarial networks (GANs) in combination with segmentation information and transfer learning. Experiments on chest Xray and brain MR images show that our method gives better registration performance over conventional methods."}, {"section_title": "INTRODUCTION", "text": "Important medical image analysis tasks such as atlas building, and monitoring pathological changes over multiple patient visits have deformable image registration as an essential step. Iterative gradient descent methods used in conventional registration methods are slow in practice while deep learning (DL) methods can be very fast at test time. Most DL based methods rely on large datasets for training. Since it is difficult to obtain ground truth data for registration it restricts the method's efficacy on new image types and in real world scenarios. A network trained to register a pair of chest xray images does not perform equally well on a pair of brain magnetic resonance (MR) images, or Xray images from other scanners. Although conventional registration methods are time consuming, their performance is consistent across different image types. Thus DL based methods have to be retrained for novel images. In this paper we address this challenge by proposing a DL based method that, once trained on a particular dataset, can be easily used on other image pairs without extensive retraining.\nA comprehensive review of conventional medical image registration methods can be found in [1] . Previous approaches to DL based image registration involve the use of convolutional stacked autoencoders (CAE) [2] , convolutional neural network (CNN) regressors [3, 4, 5] , and CNNs with reinforcement learning [6] . These approaches use a conventional model to generate the transformed image from the predicted deformation field which increases computation time and does not fully utilize the generative capabilities of DL methods. CNNs trained on simulated deformations were used in [7] while in [8] a parameterized registration function is learned from training data, and does not require ground truth.\nThe above methods are limited by the need of spatially corresponding patches or being too dependent on training data. Generative models can overcome some of these limitations by generating the registered image and the deformation field. In previous work [9] we used generative adversarial networks (GANs) for multimodal retinal image registration, and in [10] show the advantages of including segmentation for registration compared to conventional registration. In this paper we build on our previous works and show how segmentation information can be leveraged to design a DL registration method that does not require extensive retraining when used with different datasets. Our primary contribution is in using principles of transfer learning for achieving dataset independent registration. We show that our method, despite being trained on chest Xray images, achieves high performance levels with test images of brain MRI."}, {"section_title": "METHODS", "text": "In our proposed method the generator network, G, takes two "}, {"section_title": "T rans Seg", "text": "the segmentation mask of I T rans . Our method has two parts: 1) model training using segmentation information. We call this part segmented augmented registration (SAR); 2) model finetuning for a new test image pair using transfer learning. "}, {"section_title": "Segmentation Augmented Registration Using GANs", "text": "GANs [11] are generative models where the generator G outputs a desired image type while a discriminator D outputs a probability of the generated image matching the training data. The training database has chest Xray images and the corresponding masks of two lungs. To generate training data the floating images are first affinely aligned to the respective reference images. The aligned images are subjected to local elastic deformation using B-splines with the pixel displacements in the range of \u00b1 [1, 20] . We denote this deformation field as I Def \u2212App , the applied deformation field. The original images are I Ref and the transformed images are I F lt .G's parameters \u03b8 G are given by, \nNMI denotes normalized mutual information between I Ref and I T rans and SSIM denotes structural similarity index metric (SSIM). V GG is the L2 distance between two images using all the multiple feature maps obtained from a pretrained V GG16 network [12] . This sums up to 64\u00d72+128\u00d7 2+256\u00d72+512\u00d73+512\u00d73 = 3968 feature maps and compares information from multiple scales for better robustness. All feature maps are normalized to values between [0, 1].\nFigure 1(a) shows the generator network G which employs residual blocks, each block having two convolutional layers with 3\u00d73 filters and 64 feature maps, followed by batch normalization and ReLU activation. G also outputs a deformation field and the segmentation masks of I T rans , I Ref . The segmentation masks are obtained by fusing the weighted normalized output maps of the different convolution layers and applying Otsu's thresholding. The convolution layer outputs highlight the different anatomies of the image and the weights quantify the importance of each map. Figure 2 shows an example image, the obtained fused convolution mask and the segmented mask by Otsu's thresholding (along with a contour of the manual segmentation and the output of UNet segmentation). This shows that our segmentation mask is very similar to UNet's output.\nThe discriminator D (Figure 1 (b) ) has eight convolutional layers with the kernels increasing by a factor of 2 from 64 to 512 . Leaky ReLU is used and strided convolutions reduce the image dimension when the number of features is doubled. The resulting 512 feature maps are followed by two dense layers and a final sigmoid activation to obtain a probability map. D evaluates similarity of intensity distribution "}, {"section_title": "Adversarial Loss with Segmentation Information", "text": "In addition to the content loss (Eqn 2) we have: 1) an adversarial loss; and 2) a cycle consistency loss to ensure transformations G, F do not contradict each other. Since our generator network has multiple outputs we have additional terms for the adversarial loss. The first term matches the distribution of I T rans to I F lt and is given by:\nwhere\nis the corresponding adversarial loss for F and D X . The cycle consistency loss [13] ensures the deformation fields are reversible and is achieved by, \nwhere \u03bb = 10 controls the contribution of the two objectives. The optimal parameters are given by:"}, {"section_title": "Registering a new image", "text": "The primary advantage of our method is its ability to register a new image pair. During training the trained network G generates the segmentation masks of the input images, the registered image and the deformation field. Since we do not have applied deformation field to determine the accuracy of test image, the best way to gauge registration performance is by comparing I T rans and I Ref based on feature maps and segmentation mask output. If the input test image pair consists of lung images (with training images also of the lung) the generated outputs will be close to the desired values and there is no need for any finetuning of the weights.\nThe challenge lies in registering a completely new image pair, e.g., brain MR images which we achieve by transfer learning. In transfer learning for image classification the weights of all except the last few layers are frozen. We use a similar principle to register a new test image pair. The weights of the last convolution layer of generator G are updated iteratively based on the output of the discriminator. In the case of registering a new test image pair, the network is being finetuned. As a result, the discriminator network also comes into play. However, in this case the adversarial loss is based on the cyclic GAN and segmentation mask loss terms, i.e., the first three terms of Eqn. 5, and the deformation field loss term is excluded. The weight updates occur till the difference of cost function values for consecutive iterations is less than 1%. The update happens for 10 \u2212 30 iterations depending on the input image pair. Since the weight updates are only for the last layer and the computation is GPU based, the time taken for registration is very low, around 0.3 \u2212 0.5 seconds."}, {"section_title": "EXPERIMENTS", "text": "Our registration method was trained on the NIH ChestXray14 dataset [14] . The original dataset contains 112, 120 frontalview X-rays with 14 disease labels. To make it suitable for registration we selected images from 50 with multiple visits. The first visit image was I Ref and subsequent images were I F lt . In total we selected 906 images where each patient had minimum 3 images and maximum 8 images. The left and right lung were manually outlined in each image. All images were resized to 512 \u00d7 512 pixels before the manual annotations. For all our experiments we split the dataset into training, validation and test sets comprising of 70, 10, 20% of he images. The split was done at the patient level such that images from a single patient were in one fold only. All the reported results are for the test set. Registration performance was validated using mean absolute distance (MAD), the 95% Hausdorff Distance (HD 95 ) and Dice Metric (DM). After training on chest xray images we apply our method to brain and cardiac MR images with finetuning.\nOur method was implemented in TensorFlow using Adam [15] with \u03b2 1 = 0.93 and batch normalization. The generator network G was trained with a learning rate of 0.001 and 10 5 update iterations. Mean square error (MSE) based ResNet was used to initialize G. The final GAN was trained with 10 5 update iterations at learning rate 10 \u22123 . Training and test was performed on a NVIDIA Tesla K40 GPU with 12 GB RAM.\nWe show results for: 1) SARN et -our proposed registration network; 2) SAR NoSeg -SAR without using segmentation information; 3) F lowNet -the registration method of [4] ; 4) DIRN et -the method of [5] ; 5) V oxel Morph -the registration method of [8] ; and 6) a conventional registration method Elastix [16] . All networks were trained on lung images and applied to brain images. The average training time for an augmented dataset with 98, 000 images is 36 hours. The following parameter settings were used for Elastix: non rigid registration using normalized mutual information (NMI) as the cost function. Nonrigid transformations are modelled by B-splines [17] , embedded in a multi-grid setting. The grid spacing was set to 80, 40, 20, 10, 5 mm with the correspond- ing downsampling factors being 4, 3, 2, 1, 1."}, {"section_title": "Registration Results For Brain MRI", "text": "We use the 800 images of the ADNI-1 dataset [18] consisting of 200 controls, 400 MCI and 200 Alzheimer's Disease patients. The MRI protocol for ADNI1 focused on consistent longitudinal structural imaging on 1.5T scanners using T 1 and dual echo T 2\u2212weighted sequences. All scans were resampled to 256 \u00d7 256 \u00d7 256 with 1mm isotropic voxels. Pre-processing includes affine registration and brain extraction using FreeSurfer [19] . The atlas is an average of multiple volumes and obtained by aligning MR volumes from [19] . We show the reference image (or the atlas image) in Figure 3 (a) followed by an example floating image in Figure 3 (b). The ventricle structure to be aligned is shown in red in both images. Figures 3 (c)-(i) show the deformed structures obtained by applying the registration field obtained from different methods to the floating image and superimposing these structures on the atlas image. The deformed structures from the floating image are shown in green. In case of a perfect registration the green and red contours should coincide. Table 1 shows the results of brain registration before and after registration. Our method and [8] perform the best, with ours better. The results clearly demonstrate that our method can effectively transfer learned information from one dataset to another. All other methods have been trained on the brain images. Despite that fact our method outperforms them indicating the importance of using segmentation information in better registration. When the training and test images are of different types then the final registration output requires between 10 \u2212 30 iterations but the time is not noticeable since our experiments are done on GPUs.\nBaseline Performance Table 2 . Registration results for brain images when network is trained on brain images.\nwhich provides a fair comparison with the numbers in Table 1. Results show that transfer learning gives results similar to when the training and test images are of the same type. This proves the efficacy of our proposed transfer learning based image registration."}, {"section_title": "CONCLUSION", "text": "We propose a novel deep learning framework to register brain MR images by training on lung Xray images. We leverage segmentation information and transfer learning with generative adversarial networks. Experimental results show our approach achieves registration with almost similar accuracy as one would obtain when the training and test dataset consist of similar images."}]