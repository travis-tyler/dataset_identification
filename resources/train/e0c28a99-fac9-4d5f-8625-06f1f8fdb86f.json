[{"section_title": "Abstract", "text": "The most widely used task fMRI analyses use parametric methods that depend on a variety of assumptions. While individual aspects of these fMRI models have been evaluated, they have not been evaluated in a comprehensive manner with empirical data. In this work, a total of 2 million random task fMRI group analyses have been performed using resting state fMRI data, to compute empirical familywise error rates for the software packages SPM, FSL and AFNI, as well as a standard non-parametric permutation method. While there is some variation, for a nominal familywise error rate of 5% the parametric statistical methods are shown to be conservative for voxel-wise inference and invalid for cluster-wise inference; in particular, cluster size inference with a cluster defining threshold of p = 0.01 generates familywise error rates up to 60%. We conduct a number of follow up analyses and investigations that suggest the cause of the invalid cluster inferences is spatial auto correlation functions that do not follow the assumed Gaussian shape. By comparison, the non-parametric permutation test, which is based on a small number of assumptions, is found to produce valid results for voxel as well as cluster wise inference. Using real task data, we compare the results between one parametric method and the permutation test, and find stark differences in the conclusions drawn between the two using cluster inference. These findings speak to the need of validating the statistical methods being used in the neuroimaging field."}, {"section_title": "INTRODUCTION", "text": "Functional magnetic resonance imaging (fMRI) [1, 2] has since its beginning some 20 years ago been a popular tool for increasing the knowledge about the human brain, with some 28,000 published papers according to PubMed (fMRI in the title or abstract). The first fMRI experiments consisted of simple motor tasks, while more recent examples involve resting state fMRI to study (dynamic) brain connectivity [3, 4] . Despite the popularity of fMRI as a tool for studying brain function, the statistical methods used have rarely been validated using real data, likely due to the high cost of fMRI data collection. Validations have instead mainly been performed using simulated data [5] , but it is obviously very hard to simulate the complex spatiotemporal noise that arises from a living human subject in an MR scanner.\nThrough the introduction of international data sharing initiatives in the neuroimaging field [6, 7, 8, 9, 10, 11, 12] , it has become possible to evaluate the statistical methods using real data. Scarpazza et al. [13] for example used freely available anatomical images from 396 healthy controls [6] to investigate the validity of parametric statistical methods for voxel based morphometry [14] , when comparing a single subject to a group. Silver et al. [15] instead used image and genotype data from 181 subjects in the Alzheimer's disease neuroimaging initiative (ADNI) [10, 11] . The data were used to evaluate statistical methods common in imaging genetics, where the goal is to find genes that can explain variation in brain structure or function. Another example of the use of open data is our previous work [16] , where we investigated the validity of the SPM software for single subject fMRI analysis. A total of 1484 resting state fMRI data sets from the 1000 functional connectomes project [6] were used as null data, to test how likely it is to find significant brain activity when a subject has not performed any specific task in the MR scanner. The main conclusion was that the noise model in SPM is too simple, yielding a high degree of false positives (up to 70% incidence of any false positives, compared to the expected 5% under familywise error control). It was, however, not clear if these problems would propagate to group studies, where inter-subject variability in a per-subject response is less complex than intrasubject time series data. Another unanswered question was the statistical validity of other fMRI software packages. Here, we therefore present a statistical evaluation of the three most common fMRI software packages (SPM [17, 18] , FSL [19] , AFNI [20] ) for group inference. Specifically, we evaluate the packages in their entirety, submitting the null data to recommended suite of preprocessing steps integrated into each package.\nThe main idea of this study is the same for our previous one [16] ; to analyze null data and simply count the number analyses that give rise to any false positives. Since two groups of subjects are randomly drawn from a group of healthy controls, the null hypothesis of no group difference in brain activation is true. By performing many random group comparisons, using only healthy controls of similar age, it is possible to compute the empirical false positive rate of a two sample t-test. A similar approach has previously been used to investigate the validity of parametric statistics for voxel based morphometry [14, 21] . Using resting state fMRI data, which should not contain specific forms of brain activity, it is also possible to compute the empirical false positive rate of a one sample t-test (group activation).\nBriefly, our results show that the parametric statistical methods used in the three most common fMRI software packages are conservative for voxel-wise inference with familywise error control, where each voxel in a volume is independently tested for significance. However, the parametric methods can give a very high degree of false positives (up to 60%, compared to the nominal 5%) for cluster-wise inference [22, 23, 24] , where groups of neighboring voxels are tested simultaneously (to increase the statistical power). By comparison, the non-parametric permutation test [25, 26] is found to produce valid results for both voxel-and cluster-wise inference."}, {"section_title": "RESULTS", "text": "A total of 1,920,000 random group analyses were performed to compute the empirical false positive rates of SPM, FSL and AFNI (1,000 random analyses repeated for 128 parameter combinations, three thresholding approaches and five functions in the three softwares). The tested parameter combinations, given in Table 1 , are common in the fMRI field according to a recent review [27] . The following five software tools were tested; SPM OLS, FSL OLS, FSL FLAME1, AFNI OLS (3dttest++) and AFNI 3dMEMA. The OLS (ordinary least squares) functions only use the beta estimates from each subject in the group analysis, while FLAME1 in FSL and 3dMEMA in AFNI also consider the variance of the beta estimates. To compare the parametric statistical methods used by SPM, FSL and AFNI to a non-parametric method, all analyses were also performed using a permutation test [25, 26, 28] .\nResting state fMRI data from 396 healthy controls, downloaded from the 1000 functional connectomes project [6] , were used for all of the analyses. Resting state data should not contain systematic changes in brain activity, but our previous work [16] showed that the used (pretended) activity paradigm can have a large impact on the degree of false positives. Several different activity paradigms were therefore used; two block based (B1, B2) and two event related (E1, E2), see Table 2 . Figures 1 -3 present the main findings of the study, showing cluster-wise (Figure 1 , two-sample t-test; Figure 2 , onesample t-test) and voxel-wise ( Figure 3 ) results for a total sample size of 20 (Figures 4 -6 show corresponding results for a total sample size of 40). In broad summary, parametric software's familywise error (FWE) rates for cluster-wise inference far exceed their nominal 5% level, while parametric voxel-wise inferences are valid but often conservative, often falling below 5%. Permutation false positives are controlled at a nominal 5% except for cluster-wise inference with a one sample t-test, mainly with the Beijing data with designs B1 and E1. The impact of cluster defining threshold (CDT) was appreciable for the parametric methods, with CDT p = 0.001 having much better FWE control than CDT p = 0.01. Among the parametric software packages, FSL's FLAME1 clusterwise inference stood out as having much lower FWE, often being valid (under 5%). But with cluster-wise CDT p = 0.001, and voxel-wise inference, FLAME1 was often very conservative. Fig. 1 : Results for two sample t-test and cluster-wise inference, showing estimated familywise error rates for 4-10 mm of smoothing and four different activity paradigms (B1, B2, E1, E2), for SPM, FSL, AFNI and a permutation test. These results are for a group size of 10 (giving a total of 20 subjects). Each statistic map was first thresholded using a cluster defining threshold (CDT) (p = 0.01 or p = 0.001, uncorrected for multiple comparisons), and the surviving clusters were then compared to a FWE-corrected cluster extent threshold, p F W E = 0.05. The estimated familywise error rates are simply the number of analyses with any significant group differences divided by the number of analyses (1000). Note that the default CDT is p = 0.001 in SPM and p = 0.01 in FSL (AFNI does not have a default setting). Also note that the default amount of smoothing is 8 mm in SPM, 5 mm in FSL and 4 mm in AFNI. Results for one sample t-test and cluster-wise inference, showing estimated familywise error rates for 4-10 mm of smoothing and four different activity paradigms (B1, B2, E1, E2), for SPM, FSL, AFNI and a permutation test. These results are for a group size of 20. Each statistic map was first thresholded using a cluster defining threshold (CDT) (p = 0.01 or p = 0.001, uncorrected for multiple comparisons), and the surviving clusters were then compared to a FWE-corrected cluster extent threshold, p F W E = 0.05. The estimated familywise error rates are simply the number of analyses with any significant group activations divided by the number of analyses (1000). Note that the default CDT is p = 0.001 in SPM and p = 0.01 in FSL (AFNI does not have a default setting). Also note that the default amount of smoothing is 8 mm in SPM, 5 mm in FSL and 4 mm in AFNI. Results for two-sample (left) and one-sample (right) t-test and voxel-wise inference, showing estimated familywise error rates for 4-10 mm of smoothing and four different activity paradigms (B1, B2, E1, E2), for SPM, FSL, AFNI and a permutation test. Each statistic map was thresholded using a FWE-corrected voxel-wise threshold of p F W E = 0.05. The estimated familywise error rates are simply the number of analyses with any significant results divided by the number of analyses (1000). Note that the default amount of smoothing is 8 mm in SPM, 5 mm in FSL and 4 mm in AFNI. (a) results for two sample t-tests using Cambridge data (b) results for one sample t-tests using Cambridge data (c) results for two sample t-tests using Beijing data (d) results for one sample t-tests using Beijing data."}, {"section_title": "Fig. 4:", "text": "Results for two-sample t-test and cluster-wise inference, showing estimated familywise error rates for 4-10 mm of smoothing and four different activity paradigms (B1, B2, E1, E2), for SPM, FSL, AFNI and a permutation test. These results are for a group size of 20 (giving a total of 40 subjects). Each statistic map was first thresholded using a cluster defining threshold (CDT) (p = 0.01 or p = 0.001, uncorrected for multiple comparisons), and the surviving clusters were then compared to a FWE-corrected cluster extent threshold, p F W E = 0.05. The estimated familywise error rates are simply the number analyses with any significant group differences divided by the number of analyses (1000). Note that the default CDT is p = 0.001 in SPM and p = 0.01 in FSL (AFNI does not have a default setting). Also note that the default amount of smoothing is 8 mm in SPM, 5 mm in FSL and 4 mm in AFNI. (a) results for two sample t-tests using Cambridge data (b) results for one sample t-tests using Cambridge data (c) results for two sample t-tests using Beijing data (d) results for one sample t-tests using Beijing data."}, {"section_title": "What about other common cluster thresholding approaches?", "text": "A common thresholding approach in the fMRI field is to use a rather stringent cluster defining threshold, e.g. p = 0.001 (uncorrected for multiple comparisons), together with an arbitrary cluster extent threshold of 10 voxels (equal to a volume of 80 mm 3 for a voxel size of 2 x 2 x 2 mm) [27, 29] . Such an approach is ad-hoc, in the sense that one does not know what the (corrected) p-value is for the combined procedure. For this reason, 80,000 additional analyses (1,000 analyses repeated for four levels of smoothing, four pretended activity paradigms and five different software tools) were performed to investigate the validity of this common thresholding approach. The additional analyses were only performed for the Beijing data, for a two sample t-test using a total of 20 subjects. The resulting familywise error rates, i.e. how likely it is to detect at least one cluster of 10 voxels in the entire brain when the null hypothesis is true, are given in Figure 7 . Note that the expected degree of false positives is unknown, since the thresholding approach is ad-hoc. Also note that a cluster extent of 3 voxels was used for AFNI, as the AFNI software by default resamples the data to a voxel size of 3 x 3 x 3 mm (a cluster of 3 voxels is for AFNI thereby equal to a volume of 81 mm\n3 ). The probability of finding at least one cluster with a volume of 80 mm 3 , after an initial voxel-wise threshold of p = 0.001, is 50% -90% for all functions except FLAME1 in FSL. The common cluster thresholding approach thus corresponds to a corrected p-value of 0.5 -0.9. Using an initial voxel-wise threshold of p = 0.005 [29] is of course even more problematic."}, {"section_title": "How close are the statistical test values compared to the theoretical null distributions?", "text": "As a first step to understand the inaccuracies in the parametric methods, the test statistic values (t-or z-scores, as generated by each package) were compared to their theoretical null distributions. Figure 8 shows the histogram of all brain voxels for 1000 group analyses (see caption for details). The empirical and theoretical nulls are well-matched, except for FSL's FLAME1 which has lower variance (\u03c3 2 = 0.67) than the theoretical null. This is the proximal cause of the highly conservative results from FSL FLAME. The mixed effects variance is composed of intra-and inter-subject variance (\u03c3 2 W T N , \u03c3 2 BT W , respectively), and while other software packages do not separately estimate each (SPM, FSL OLS), FLAME estimates each and constrains \u03c3 2 BT W to be positive. In this null data, the true effect in each subject is zero and thus the true \u03c3 2 BT W = 0. Thus unless FLAME's\u03c3 2 BW T is correctly estimated to be 0, it can only be positively biased, and in fact this point was raised by the original authors [30] . Additionally, FLAME1 (the currently recommended option) uses a conservative degrees of freedom estimate in lieu of a more accurate but slow degrees of freedom estimation used Results for two-sample t-test and ad-hoc cluster-wise inference, showing estimated familywise error rates for 4-10 mm of smoothing and four different activity paradigms (B1, B2, E1, E2), for SPM, FSL and AFNI. These results are for a total of 20 subjects. Each statistic map was first thresholded using a cluster defining threshold of p = 0.001 (uncorrected for multiple comparisons), and the surviving clusters were then compared to a cluster extent threshold of 80 mm 3 . The estimated familywise error rates are simply the number of analyses with a significant result divided by the number of analyses (1000). in FLAME2's BIDET. These two factors are the most likely explanation for the observed conservativeness."}, {"section_title": "What does the spatial auto correlation function look like?", "text": "SPM and FSL depend on Gaussian random field theory (RFT) for FWE-corrected voxel-wise and cluster-wise inference. However, RFT cluster-wise inference depends on two additional assumptions. The first assumption is that the spatial smoothness of the fMRI signal is constant over the brain, and the second assumption is that the spatial auto correlation function has a specific shape (a squared exponential) [31] . To investigate the second assumption, the spatial auto correlation function was estimated and averaged using 1000 group difference maps. For each group difference map and each distance (1 -20 mm), the spatial auto correlation was estimated along x, y and z, by calculating the correlation between the original difference map and a shifted version of the difference map. The final estimate is an average of the spatial auto correlation along x, y and z. The empirical spatial auto correlation functions are given in Figure 9 . A reference squared exponential is also included, it is proportional to a Gaussian density with \u03c3 = 5 mm, corresponding to an intrinsic smoothness of 8.3 mm (FWHM). The empirical spatial auto correlation function is clearly far from a squared exponential; it has a much longer tail. This may explain why the parametric methods work rather well for a high cluster defining threshold (resulting in small clusters) and not as well for a low cluster defining threshold (resulting in large clusters)."}, {"section_title": "How do the smoothness estimates and the cluster extent thresholds differ between SPM, FSL and AFNI?", "text": "For both voxel and cluster-wise inference, the smoothness of the group difference map or group activation map needs to be estimated to calculate the RESEL (resolution element) count, a key parameter for the RFT based p-values. Group model smoothness estimates for SPM, FSL FLAME and AFNI, for 1000 group comparisons, are given in Figure 10 (see Figure  caption for details). As the preprocessing was unique to each package, it is difficult to make absolute comparisons between intrinsic noise smoothness found with each tool. However, the notably lower smoothness estimates from AFNI could be due to AFNI's use of first level (intrasubject) residuals instead of second level (intersubject) residuals like SPM and FSL. A direct comparison can be made between cluster size thresholds of FSL FLAME and a non-parametric test conducted on the FSL-preprocessed data (see Figure 11) , showing the more stringent cluster thresholds the non-parametric method uses to control the familywise error rate."}, {"section_title": "Where are the false clusters located in the brain?", "text": "To investigate if the false clusters appear randomly in the brain, all significant clusters (p < 0.05, corrected) were saved as binary maps and summed together, see Figure 13 . These maps of voxel-wise cluster frequency show the areas more and less likely to be marked as significant in a cluster-wise analysis (see Figure caption for details). Posterior cingulate was the most likely area to be covered by a cluster, while white matter was least likely.\nTo investigate the assumption of a stationary spatial smoothness, three gradient filters (oriented along x, y and z) were applied to each group difference map, and the average gradient magnitude (\u2207x) 2 + (\u2207y) 2 + (\u2207z) 2 (roughness) was calculated over all analyses (while actual analyses use the residuals, as the null hypothesis is true we can equivalently use the statistic maps). The smoothness was finally obtained as the inverse roughness, and is given in Figure 13 . Reductions in smoothness will mean that random clusters are smaller in size (reducing false positive rate) but also that there are more clusters (increasing false positive rate); how these two factors balance out are hard to predict.\nClearly, the false clusters appear in spatial patterns that match the degree of smoothness in the group difference maps. For SPM, FSL OLS and AFNI OLS, the degree of smoothness is correlated with the brain tissue type; the smoothness is generally higher for gray brain tissue compared to white brain tissue. This effect has previously been observed for VBM data [15] .\n2.6. What is the difference between parametric and nonparametric cluster-wise inference for a typical group study?\nAll of the analyses to this point have been based on resting state fMRI data, where the null hypothesis should be true. We now use task data to address the practical question of \"How will my FWE-corrected cluster p-values change?\" if a user were to switch from a parametric to a non-parametric method. We use four task data sets (rhyme judgment, mixed gambles [32] , living-nonliving decision with plain or mirrorreversed text, word and object processing [33] ) downloaded from the OpenfMRI [9] homepage. The data sets were analyzed using a parametric (the OLS option in FSL's FEAT) and a non-parametric method (the randomise function in FSL). The only difference between these two methods is that FSL FEAT-OLS relies on Gaussian random field theory to calculate the corrected cluster p-values, while randomise instead uses the data itself. The resulting cluster p-values are given in Table 3 (cluster defining threshold of p = 0.01) and Tables 4 -5 (cluster defining threshold of p = 0.001). Figure 14 summarizes these results, plotting the ratio of FWE-corrected p-values, non-parametric to parametric, against cluster size. Given the previous null data evaluations showing valid non- The test values were drawn from two sample t-tests (10 subjects per group) using the Beijing data (analyzed with the E2 paradigm and 6 mm smoothing). Note that the empirical null distribution for FLAME1 in FSL has a much lower variance compared (0.67) to a normal distribution with unit variance. For this reason, the familywise error rates are much lower for FLAME in FSL, compared to the other functions. The SACFs were estimated and averaged using 1000 group difference maps. The difference maps were generated from two sample t-tests (10 subjects per group) using the Beijing data (analyzed with the E2 paradigm and 6 mm smoothing). Note that the empirical SACFs have a much longer tail compared to the theoretical squared exponential SACF, thereby violating one of the required assumptions for parametric cluster-wise inference using Gaussian random field theory. Both SPM and FSL resample the fMRI data to a resolution of 2 mm, while AFNI instead uses a resolution of 3 mm. For this reason, the SACFs are sampled differently for AFNI. The maps show voxel-wise incidence of clusters. Image intensity is the number of times, out of 10,000 random analyses (200,000 for FSL FLAME, to account for fewer clusters per analysis), a cluster occured at a given voxel (CDT p = 0.01), for a) SPM, b) FSL and c) AFNI. Each analysis is a two sample t-test (10 subjects per group) using the Beijing data, analyzed with the E2 paradigm and 6 mm smoothing. The bright spot in the posterior cingulate corresponds to a region of high smoothness, and suggests non-stationarity as a possible contributing factor. FSL and c) AFNI. The smoothness was estimated from 10,000 difference maps generated from two sample t-tests (10 subjects per group) using the Beijing data (analyzed with the E2 paradigm and 6 mm smoothing). It is clear that the smoothness varies spatially; one of the required assumptions for parametric cluster-wise inference using Gaussian random field theory is thereby violated. Note that the bright areas (high smoothness) match the spatial maps of the false clusters; it is more likely to find a large cluster for areas with a high smoothness. The AFNI software generally results in group difference maps with a lower smoothness compared to SPM and FSL. A possible explanation is that AFNI uses higher order interpolation for motion correction and spatial normalization, which leads to a lower smoothness compared to more common linear interpolation. Also note the reduced smoothness for the iterative methods (FSL FLAME & AFNI 3dMEMA) and their corresponding non-iterative methods (FSL OLS and AFNI OLS, respectively); the voxel-by-voxel estimation of between subject variance in the iterative methods reduces the smoothness slightly. Group smoothness estimates (mm full width at half maximum) for SPM, FSL FLAME and AFNI. The smoothness estimates originate from two sample t-tests (10 subjects per group) using the Beijing data (analyzed with the E2 paradigm and 6 mm smoothing). Note that AFNI estimates the group smoothness differently compared to SPM and FSL. Also note that AFNI uses higher order interpolation for motion correction and spatial normalization, which leads to a lower smoothness compared to more common linear interpolation. Cluster extent thresholds (in cubic millimeters) for SPM, FSL FLAME, AFNI and a permutation test, for a cluster defining threshold of p = 0.01 and a familywise cluster error rate of p = 0.05. The thresholds originate from two sample ttests (10 subjects per group) using the Beijing data (analyzed with the E2 paradigm and 6 mm smoothing). Note that the permutation threshold can only be directly compared with the threshold from the FSL software, as first level results from FSL were used for the non-parametric analyses. parametric and invalid parametric cluster size inference, we take ratios larger than 1.0 as evidence of inflated (biased) significance in the parametric inferences.\nFor a cluster defining threshold of p = 0.01 and a cluster size of 400 voxels, the non-parametric cluster p-value is approximately 10 -100 times larger compared to the parametric p-value. For a cluster defining threshold of p = 0.001 and a cluster size of 100 voxels, the non-parametric cluster p-value is approximately 1.25 -10 times larger compared to the parametric p-value. For contrast 1 of the word and object processing task data set (Table 3) , one cluster has a parametric p-value of 0.0182 and a non-parametric p-value of 0.249. This matches the empirically estimated familywise error rate of FSL OLS, according to Figure 5 . These findings indicate that the problems exist also for task based fMRI data, and not only for resting state data."}, {"section_title": "DISCUSSION", "text": "Our results clearly show that the parametric statistical methods used for group fMRI analysis with the packages SPM, FSL and AFNI can produce FWE-corrected cluster p-values that are erroneous, being spuriously low and inflating statistical significance. This calls into question the validity of countless published fMRI studies based on parametric cluster-wise inference. It is important to stress that we have focused on inferences corrected for multiple comparisons in each group analysis, yet some 40% of a sample of 241 recent fMRI papers did not report correcting for multiple comparisons [27] , meaning that many group results in the fMRI literature suffer even worse false positive rates than found here [34] . A possible explanation for the lack of multiple comparison correction is that the correction methods are believed to be too conservative, resulting in familywise error rates far below the expected 5%. However, we have found that correction methods based on parametric assumptions can actually be very liberal for cluster-wise inference, yielding familywise error rates of up to 60%.\nCompared to our previous work [16] , the results presented here are more important for three reasons. First, the current study considers group analyses, while our previous study looked at single subject analyses. Group analyses are much more common in the fMRI field, and are essential for drawing conclusions that should generalize to a population. Second, we here investigate the validity of the three most common fMRI software packages [27] , while we only considered SPM in our previous study. Third, the non-parametric permutation test gives valid results for all two sample t-tests, and for 60% of the one sample t-tests. This may be due to violations of the stronger assumptions of the one-sided permutation test which assumes symmetrically distributed errors, in contrast to a two-sample permutation test that only assumes exchangeable errors [25] . In our previous study, the permutation test only performed well in some cases (mainly because single subject fMRI data contain temporal auto correlation which needs to be removed prior to permuting the volumes). For group analyses, the brain activity of each subject can be seen as independent, and thus justifies the permutation's exchangeability assumption."}, {"section_title": "Should resting state data be used to test statistical assumptions?", "text": "One possible criticism is that resting state fMRI data does not truly compromise null data, as it may be affected by consistent trends or transients, for example, at the start of the session. If this was the case, the excess false positives would appear only in certain paradigms and, in particular, least likely in the randomized event-related (E2) design. Rather, the inflated false positives were observed across all experiment types with parametric cluster size inference, implying this effect cannot be responsible."}, {"section_title": "Why is cluster-wise inference more problematic than voxel-wise?", "text": "It is clear that the parametric statistical methods work well, if conservatively, for voxel-wise inference, but not for clusterwise inference. We note that other authors have found random field theory cluster-wise inference to be invalid in certain settings under stationarity [31, 24] and non-stationarity [35, 15] . This present work, however, is the most comprehensive to explore the typical parameters used in task fMRI for a variety of software tools. Our results are also corroborated by similar experiments for structural brain analysis (voxel based morphometry, VBM) [13, 14, 15, 21, 36] [15, 37] .\nBoth SPM and FSL rely on RFT to correct for multiple comparisons. For voxel-wise inference, RFT is based on the assumption that the activity map is sufficiently smooth (roughly, at least 3 voxel FWHM [31] ), and that the spatial auto correlation function (SACF) is twice-differentiable at the origin. Further, RFT is only accurate for sufficient large statistic values (precisely, a statistic value used as a threshold would produce at most one peak under the null hypothesis on average). For cluster-wise inference, RFT additionally assumes a Gaussian shape of the SACF (i.e. a squared exponential covariance function), and that the spatial smoothness is constant over the brain. The cluster defining threshold (CDT) must also be sufficiently large, but to accomodate a different sets of approximations. First, it must be large enough to ensure that handles or voids in the clusters do not occur on average (which is much lower than needed for voxel-wise RFT accuracy), ensuring that the expected Euler characteristic is a good approximation to the (null) expected number of clusters. Second, the CDT must be large enough for the (null) distribution of cluster size to be accurate. Note that both SPM and FSL apply cluster size results for Gaussian images to T images after Gaussianizing the CDT, even though there are T image results available [38] . Hayasaka and Nichols [31] found that the proper T results did not dramatically improve the performance of the RFT cluster size inferences.\nThe 3dClustSim function in AFNI also assumes a constant spatial smoothness and a Gaussian form of the SACF (since a Gaussian smoothing is applied to each generated noise volume). The Monte Carlo approach should be accurate for any CDT as the other assumptions hold. As the familywise error rates are far above the expected 5% for cluster-wise inference, but not for voxel-wise inference, one or more of the Gaussian SACF, the stationary SACF, or the sufficiently large CDT as-sumptions must be invalid. Cluster-wise inference was discouraged for VBM already 15 years ago [14] , due to nonstationary spatial smoothness in the statistical maps. The nonstationary smoothness can be modeled [35] , but parametric methods still give invalid results for VBM with low smoothing and CDT [15] . In the fMRI field, however, the assumption of a stationary spatial smoothness has not really been investigated. Figure 9 shows that the SACF is far from a squared exponential. The empirical SACFs are close to a squared exponential for small distances, but the auto correlation is higher than expected for large distances. This could be the reason why the parametric methods work rather well for a high cluster defining threshold (p = 0.001), and not at all for a low threshold (p = 0.01). A low threshold gives large clusters with a large radius, for which the tail of the SACF is quite important. For a high threshold, resulting in rather small clusters with a small radius, the tail is not as important. Also, it could simply be that the high-threshold assumption is not satisfied for a CDT of p = 0.01. Figure 13 shows that the spatial smoothness is not constant in the brain, but varies spatially. Note that the bright areas match the spatial distribution of false clusters in Figure 12 ; it is more likely to find a large cluster for a high smoothness. The permutation test does not assume a specific shape of the SACF, nor does it assume a constant spatial smoothness, nor require a high CDT. For these reasons, the permutation test provides valid results, for two sample t-tests, for both voxel and cluster-wise inference."}, {"section_title": "Why does AFNI's Monte Carlo approach, with fewer parametric assumptions, not perform better?", "text": "As can be observed in Figures 1, 2, 4 and 5, AFNI results in familywise error rates that are high even for a cluster defining threshold of p = 0.001. There are two main factors that explain these results.\nFirstly, AFNI estimates the spatial group smoothness differently compared to SPM and FSL. AFNI averages smoothness estimates from the first level analysis, whereas SPM and FSL estimate the group smoothness using the group residuals from the general linear model [39] . The group smoothness used by 3dClustSim may for this reason be too low (compared to SPM and FSL, see Figure 10 ); the variation of smoothness over subjects is not considered.\nSecondly, a 15 year old bug was found in 3dClustSim while testing the three software packages (the bug was fixed by the AFNI group as of May 2015 1 , during preparation of this manuscript). The effect of the bug was an underestimation of how likely it is to find a cluster of a certain size (in other words, the p-values reported by 3dClustSim were too low). The main idea behind the 3dClustSim function is to generate Gaussian noise with unit variance, and then smooth it using a Gaussian lowpass filter with a size corresponding to 1 http://afni.nimh.nih.gov/pub/dist/doc/program help/3dClustSim.html the estimated group smoothness. This procedure is repeated a large number of times, to obtain an estimate of how common different cluster sizes are for Gaussian noise. The smoothed noise is rescaled back to unit variance, and 3dClustSim performs the rescaling by first estimating the variance of the smoothed noise. Due to edge effects caused by the smoothing operation the boundary of the volume is attenuated, which has two effects. First, the estimated variance used for standardization will be biased down, increasing the variance of the simulated images 2 . Second, the attenuation will reduce the chance that clusters will ever occur near the boundary, effectively reducing the search volume and under estimating the severity of the multiple testing problem.\nTogether, the lower group smoothness and the bug in 3dClustSim resulted in cluster extent thresholds that are much lower compared to SPM and FSL, see Figure 11 , which resulted in particularly high familywise error rates. Note that the cluster extent thresholds for SPM, FSL and AFNI match the degree of false positives according to Figure 1 (d) . AFNI has the lowest cluster extent thresholds, and therefore results in a higher familywise error rate compared to SPM and FSL. FSL has higher extent thresholds compared to SPM, and the familywise error rates are therefore slightly lower.\nThe familywise error rates for AFNI will be lower with the fixed 3dClustSim function, especially for high levels of smoothing (for which the bug in 3dClustSim is more noticeable). As an example of the difference between the old and the new 3dClustSim function, the new function gives a cluster extent threshold that is 15% higher compared to the old function (for a smoothness of 8 mm). These findings are rather alarming, as 3dClustSim is one of the most popular choices for multiple comparison correction [27] ."}, {"section_title": "Which parameters affect the familywise error rate for cluster-wise inference?", "text": "According to Figures 1, 2, 4 and 5, the cluster defining threshold is the most important parameter for SPM, FSL and AFNI; using a more liberal threshold increases the degree of false positives. This result is consistent with previous work [15, 24, 40] . However, the permutation test is completely unaffected by changes of this parameter. According to a recent review looking at 484 fMRI studies [24] , the used cluster defining threshold varies greatly between the three software packages (mainly due to different default settings). For SPM, p = 0.001 is the default and most common threshold (used in about 70% of the studies), followed by 20% for p = 0.005 and 5% for p = 0.01. For FSL, p = 0.01 is the default and most common choice (65% of the studies), followed by 20% for p = 0.001 and 10% greater than p = 0.01. The AFNI software does not have a default setting for the 3dClustSim function, but a threshold of p = 0.005 seems to be the most common option (used in 40% of the studies), followed by 25% for p = 0.001 and 15% for p = 0.01.\nThe amount of smoothing has a rather large impact on the degree of false positives, especially for FSL OLS. The results from the permutation test, on the other hand, do not depend on this parameter. The original fMRI data has an intrinsic SACF, which is mixed with the SACF of the smoothing kernel. The combined SACF will more closely resemble a squared exponential for high levels of smoothing, simply because the smoothing operation forces the data to have a more Gaussian SACF. The permutation test does not assume a specific form of the SACF, and therefore performs well for any degree of smoothing. It should be stressed that AFNI uses 4 mm as the default amount of smoothing, while FSL uses 5 mm and SPM uses 8 mm. Both FSL and AFNI OLS show interaction between the amount of smoothing and the fMRI data. For all software packages, the amount of smoothing has a larger effect on the block based activity paradigms, compared to the event related ones. These two effects are consistent with our previous work [16] . SPM, FSL OLS and AFNI also show interaction between the amount of smoothing and the cluster defining threshold.\nJust as for our previous study [16] , the used (pretended) activity paradigm significantly affects the degree of false positives. This was unexpected, but it means that problems that arise due to temporally correlated noise actually propagate from the single subject analysis to the group analysis. SPM, FSL and AFNI 3dMEMA show interaction between the fMRI data and the activity paradigm. This can be explained by the fact that the Beijing data sets were collected with a repetition time of 2 seconds, while the Cambridge data sets were collected with a repetition time of 3 seconds. The temporal auto correlation between two consecutive volumes increases with the sampling rate, and in our previous study about single subject fMRI analysis [16] , the sampling rate was found to be the most important factor for the degree of false positives. Block based designs are more sensitive to temporal auto correlations resembling power spectra with an 1/f appearance (f being frequency), as their power spectra are concentrated at low frequencies. The permutation test is unaffected by the used activity paradigm for two sample t-tests, but slightly affected for one sample t-tests. An unexpected result is that all software packages show significant interaction between the activity paradigm and the number of subjects.\nAll software packages are significantly affected by the analysis type; the familywise error rates are generally lower for a two-sample t-test compared to a one sample t-test. This effect can be explained by the fact that a test value that represents a difference (e.g. the difference in brain activation between two groups) can more easily be approximated with a normal distribution, compared to a test value that does not represent a difference. As can be seen in Figures 2, 3, 5 and 6 , the one-sample t-tests are problematic even for the permutation test. For both FSL OLS and AFNI, there is strong interaction between the analysis type and the fMRI data. A possible explanation is that the one sample t-tests are more problematic for fMRI data collected with a higher sampling rate, as such data have stronger temporal auto correlation between two consecutive volumes [16] .\nBoth FSL FLAME1 and AFNI OLS give a higher degree of false positives when the number of subjects increases. This is counter intuitive, as Gaussian random field theory normally works better for higher degrees of freedom. All software packages except SPM also show interaction between the fMRI data and the number of subjects."}, {"section_title": "The future of fMRI", "text": "It is not realistic to redo 28,000 fMRI studies, or to re-analyze all the data. Considering that it is now possible to evaluate common statistical methods using real fMRI data, the fMRI community should, in our opinion, focus on validation of existing methods (rather than developing new methods based on questionable assumptions). A plethora of excellent methods are available in the statistics field, but are seldom used in the neuroimaging community. A non-parametric permutation test, for example, is based on a small number of assumptions, and has here been proven to yield more accurate results than parametric methods. The main drawback of a permutation test is the increase in computational complexity, as the group analysis needs to be repeated 1,000 -10,000 times. The increase in processing time is no longer a problem; an ordinary desktop computer can run a permutation test for neuroimaging data in less than a minute [28, 41] . A single desktop computer, with a powerful graphics card, was used in this study to run all the 384,000 permutation tests (with 1,000 permutations each) in about 15 days (the processing time would be 10 -30 years if the function randomise in FSL was used instead).\nIn addition to unreliable statistical methods, the neuroimaging field also suffers from studies having low statistical power [42, 43] . One possible way to increase the statistical power is to use locally multivariate statistical methods [44, 45, 46, 47, 48 ], which do not analyze the data one voxel at a time. Multivariate statistical methods can, however, result in more complicated null distributions, making it harder to obtain p-values. More advanced clustering techniques, such as cluster mass inference [49] or threshold free cluster enhancement [50] , can also result in a higher statistical power, but it is often hard to derive a theoretical null distribution. A permutation test can estimate the null distribution of any test statistic, and can thus increase both the accuracy and the statistical power of fMRI studies."}, {"section_title": "Acknowledgment", "text": "This research was supported by the neuroeconomic research initiative at Link\u00f6ping university, and by the Swedish research council (grant 2013-5229 'statistical analysis of fMRI data'). This study would not be possible without the recent data sharing initiatives in the neuroimaging field. We therefore thank the Neuroimaging Informatics Tools and Resources Clearinghouse (NITRC) and all the researchers that have contributed with resting state data to the 1000 functional connectomes project. We would also like to thank Russ Poldrack and his colleagues for starting the OpenfMRI project (supported by NSF grant OCI-1131441) and all the researchers that have shared their task based data. The Nvidia corporation, who donated the Tesla K40 graphics card used to run all the permutation tests, is also acknowledged.\n[48] J.A. Etzel, J.M. Zacks, and T.S. Braver, \"Searchlight analysis: Promise, pitfalls, and potential,\" NeuroImage, vol. 78, pp. 261 -269, 2013.\n[49] H. Zhang, T.E. Nichols, and T.D. Johnson, \"Cluster mass inference via random field theory,\" NeuroImage, vol. 44, pp. 51 -61, 2009.\n[50] S.M. Smith and T.E. Nichols, \"Threshold-free cluster enhancement: Addressing problems of smoothing, threshold dependence and localisation in cluster inference,\" NeuroImage, vol. 44, pp. 83-98, 2009."}, {"section_title": "METHODS", "text": ""}, {"section_title": "Resting state fMRI data", "text": "Resting state fMRI data from 396 healthy controls were downloaded from the homepage of the 1000 functional connectomes project [6] (http://fcon 1000.projects.nitrc.org/fcpClassic/FcpTable.html).\nThe Beijing and the Cambridge data sets were selected for their large sample sizes (198 subjects each) and their narrow age ranges (21.2 \u00b1 1.8 and 21.0 \u00b1 2.3 years, respectively). The Beijing data were collected with a repetition time (TR) of 2 seconds and consist of 225 time points per subject, the spatial resolution is 3.125 x 3.125 x 3.6 mm 3 . The Cambridge data were collected with a TR of 3 seconds and consist of 119 time points per subject, the spatial resolution is 3 x 3 x 3 mm 3 . For each subject there is one T 1 -weighted anatomical volume which can be used for normalization to a brain template. According to the motion plots from FSL, no subject moved more than 1 mm in any direction. According to motion plots from AFNI, one Cambridge subject and three Beijing subjects moved slightly more than 1 mm. The fMRI data have not been corrected for geometric distortions, and no field maps are available for this purpose.\nSince all the subjects are healthy and of similar age, it should be impossible to find any significant brain activity differences between two randomly generated subgroups (analyses were performed separately for the Beijing data and the Cambridge data). The same approach has previously been used to test the validity of parametric statistics for voxel based morphometry [14, 21] . As the subjects have not performed any specific task in the MR scanner, it should also be impossible to find significant group activations. The data can thus be used to test both two-sample t-tests (group differences) and one sample t-tests (group activations)."}, {"section_title": "Random group generation", "text": "Each random group was created by first applying a random permutation to a list containing all the 198 subject numbers. To create two random groups of 20 subjects each, the first 20 permuted subject numbers were put into group 1, and the following 20 permuted subject numbers were put into group 2. According to the n choose k formula n! k!(n\u2212k)! it is possible to create approximately 1.31 \u00b7 10 42 such random group divisions (n = 198 and k = 40). The analyses will not be independent, but the estimate of the familywise false positive rate will still be unbiased. A total of 1000 random analyses were used to estimate the familywise false positive rate, giving a 95% confidence interval of 3.65% -6.35% for an expected false positive rate of 5%. To make a fair comparison between the different software packages, the same 1000 permutations were used for all software packages and all parameter settings."}, {"section_title": "Code availability", "text": "Parametric group analyses were performed using SPM 8 (http://www.fil.ion.ucl.ac.uk/spm/software/spm8/), FSL 5.0.7 (http://fsl.fmrib.ox.ac.uk/fsldownloads/) and AFNI (http://afni.nimh.nih.gov/afni/download/afni/releases, compiled August 13 2014, version 2011 12 21 1014). FSL can perform non-parametric group analyses using the function randomise, but we here used our BROCCOLI software [28] (https://github.com/wanderine/BROCCOLI) to lower the processing time. All the processing scripts are freely available (https://github.com/wanderine/ParametricMultisubjectfMRI) to show all the processing settings and to facilitate replication of the results. Since all the software packages and all the fMRI data are also freely available, anyone can replicate the results in this paper."}, {"section_title": "First level analyses", "text": "A first processing script was used for each software package to perform first level analyses for each subject, resulting in brain activation maps in a standard brain space (Montreal Neurological Institute (MNI) for SPM and FSL, and Talairach for AFNI). All first level analyses involved normalization to a brain template, motion correction and different amounts of smoothing (4, 6, 8 and 10 mm full width at half maximum). Slice timing correction was not performed, as the slice timing information is not available in the fMRI data sets. A general linear model (GLM) was finally applied to the preprocessed fMRI data, using different regressors for activity (B1, B2, E1, E2). The estimated head motion parameters were used as additional regressors in the design matrix, for all packages, to further reduce effects of head motion.\nFirst level analyses were for SPM performed using a Matlab batch script, mainly created using the SPM manual. The spatial normalization was done as a two step procedure, where the mean fMRI volume was first aligned to the anatomical volume (using the function 'Coregister' with default settings). The anatomical volume was aligned to MNI space using the function 'Segment' (with default settings), and the two transforms were finally combined to transform the fMRI data to MNI space at 2 mm isotropic resolution (using the function 'Normalise: Write'). Spatial smoothing was finally applied to the spatially normalized fMRI data. The first level models were then fit in the atlas space, i.e. not in the subject space.\nFor FSL, first level analyses were setup through the FEAT GUI. The spatial normalization to the brain template (MNI152 T1 2mm brain.nii.gz) was performed as a two step linear registration using the function FLIRT (which is the default option). One fMRI volume was aligned to the anatomical volume using the BBR (boundary based registration) option in FLIRT (default). The anatomical volume was aligned to MNI space using a linear registration with 12 degrees of freedom (default), and the two transforms were finally combined. The first level models were fit in the subject space (after spatial smoothing), and the contrasts and their variances were then transformed to the atlas space.\nFirst level analyses in AFNI were performed using the standardized processing script afni proc.py, which creates a tcsh script which contains all the calls to different AFNI functions. The spatial normalization was performed as a two step procedure. One fMRI volume was first linearly aligned to the anatomical volume, using the script align epi anat.py. The anatomical volume was then linearly aligned to the brain template (TT N27+tlrc) using the script @auto tlrc. The transformations from the spatial normalization and the motion correction were finally applied using a single interpolation, resulting in normalized fMRI data in an isotropic resolution of 3 mm. Spatial smoothing was applied to the spatially normalized fMRI data, and the first level models were then fit in the atlas space (i.e. not in the subject space).\nDefault drift modelling or highpass filtering options were used in each of SPM, FSL and AFNI. A discrete cosine transform with cutoff of 128 seconds was used for SPM, while highpass filters with different cutoffs where used for FSL (20 seconds for activity paradigm B1, 60 seconds for B2 and 100 seconds for E1 and E2), matching the defaults used by the FEAT GUI, and AFNI's Legende polynomial order is 4 and 3 for the Beijing and the Cambridge data, respectively (based on total scan duration). Temporal correlations were further corrected for with a global AR(1) model in SPM, an arbitrary temporal auto correlation function regularized with a Tukey taper and adaptive spatial smoothing in FSL and a voxel-wise ARMA(1,1) model in AFNI."}, {"section_title": "Group analyses", "text": "A second processing script was used for each software package to perform random effect group analyses, using the results from the first level analyses. For SPM, group analyses were only performed with the resulting beta weights from the first level analyses, using ordinary least squares (OLS) regression over subjects. For FSL, group analyses were performed both using FLAME1 (which is the default option) and OLS. The FLAME1 function uses both the beta weight and the corresponding variance of each subject, subsequently estimating a between subject variance. For AFNI, group analyses were performed using the functions 3dttest++ (OLS, using beta estimates from the function 3dDeconvolve which assumes independent errors) and 3dMEMA (which is similar to FLAME1 in FSL, using beta and variance estimates from the function 3dREMLfit which uses a voxel-wise ARMA(1,1) model of the errors).\nFor the non-parametric analyses in BROCCOLI, first level results from FSL were used and OLS regression was performed in each permutation. The largest test value across the entire brain was saved in each permutation, to empirically form the null distribution of the maximum test statistic (which is required to correct for multiple comparisons). For clusterwise inference, the cluster defining threshold was first applied and the size of the largest cluster was then saved in each permutation. A permutation test cannot be used for testing group activations (one sample t-tests), as the mean brain activity is invariant to permutations of the subjects. An alternative is to instead use random sign flipping of the subjects, justified by an assumption of symmetrically distributed errors, which is the solution that FSL and BROCCOLI use for one sample t-tests. Each non-parametric group analysis was performed using 1000 permutations or sign flips, giving a total of 192 million permutations and 192 million sign flips for all group analyses (hence the need to lower the processing time).\nVoxel-wise FWE-corrected p-values from SPM and FSL were obtained based on their respective implementations of random field theory, while AFNI FWE p-values were obtained with a Bonferroni correction for the number of voxels (AFNI does not provide any specific program for voxel-wise FWE p-values). For the non-parametric analyses, FWEcorrected p-values were calculated with the empirical null distribution of the voxel-wise maximum statistic, computed as the proportion of the null distribution being larger than a particular statistic value.\nCluster-wise FWE-corrected p-values from SPM and FSL were likewise obtained based on their implementations of random field theory. AFNI estimates FWE p-values with a simulation based procedure, 3dClustSim. SPM and FSL estimate smoothness from the residuals of the group level analysis (used for both voxel-wise and cluster-wise inference), while AFNI uses the average of the first level analyses' smoothness estimates. For the non-parametric analyses, FWE-corrected p-values were calculated as the proportion of cluster sizes in the empirically estimated null distribution being larger than each cluster in the group difference map or group activation map.\nEach group analysis was considered to give a significant result if any cluster or voxel had a FWE-corrected p-value p < 0.05."}, {"section_title": "Task based fMRI data", "text": "Task based fMRI data were downloaded from the homepage of the OpenfMRI project [9] (http://openfmri.org), to investigate how cluster based p-values differ between parametric and non-parametric group analyses. Each task dataset contains fMRI data, anatomical data and timing information for each subject. The data sets were only analyzed with FSL, using 5 mm of smoothing (the default option). Motion regressors were used in all cases, to further suppress effects of head motion. Group analyses were performed using the parametric OLS option (i.e. not the default FLAME1 option) and the non-parametric randomise function."}, {"section_title": "Rhyme judgment", "text": "The rhyme judgment dataset is available at http://openfmri.org/dataset/ds000003. The 13 subjects were presented with pairs of either words or pseudowords, and made rhyming judgments for each pair. The fMRI data were collected with a repetition time of 2 seconds and consist of 160 time points per subject, the spatial resolution is 3.125 x 3.125 x 4 mm 3 . The data were analyzed with two regressors; one for words and one for pseudo words. A total of four contrasts were applied; words, pseudowords, wordspseudowords, pseudowords -words. For a cluster defining threshold of p = 0.01, a t-threshold of 2.65 was used. For a cluster defining threshold of p = 0.001, a t-threshold of 3.95 was used."}, {"section_title": "Mixed-gambles task", "text": "The mixed-gambles task dataset is available at http://openfmri.org/dataset/ds000005. The 16 subjects were presented with mixed (gain/loss) gambles, and decided whether they would accept each gamble. No outcomes of these gambles were presented during scanning, but after the scan three gambles were selected at random and played for real money. The fMRI data were collected using a 3 T Siemens Allegra scanner. A repetition time of 2 seconds was used and a total of 240 volumes were collected for each run, the spatial resolution is 3.125 x 3.125 x 4 mm 3 . The dataset contains three runs per subject, but only the first run was used in our analysis. The data were analyzed using four regressors; task, parametric gain, parametric loss and distance from indifference. A total of four contrasts were applied; parametric gain, -parametric gain, parametric loss, -parametric loss. For a cluster defining threshold of p = 0.01, a t-threshold of 2.57 was used. For a cluster defining threshold of p = 0.001, a t-threshold of 3.75 was used."}, {"section_title": "Living-nonliving decision with plain or mirror-reversed text", "text": "The living-nonliving decision task dataset is available at http://openfmri.org/dataset/ds000006a. The 14 subjects made living-nonliving decisions on items presented in either plain or mirror-reversed text. The fMRI data were collected using a 3 T Siemens Allegra scanner. A repetition time of 2 seconds was used and a total of 205 volumes were collected for each run, the spatial resolution is 3.125 x 3.125 x 5 mm 3 . The dataset contains six runs per subject, but only the first run was used in our analysis. The data were analyzed using five regressors; mirror-switched, mirror-repeat, plain-switched, plain-repeat and junk. A total of four contrasts were applied; mirrored versus plain (1,1,-1,-1,0) , switched versus non-switched (1,-1,1,-1,0) , switched versus non-switched mirrored only (1,-1,0,0,0) and switched versus non-switched plain only (0,0,1,-1,0). For a cluster defining threshold of p = 0.01, a t-threshold of 2.615 was used. For a cluster defining threshold of p = 0.001, a t-threshold of = 3.87 was used."}, {"section_title": "Word and object processing", "text": "The word and object processing task dataset is available at http://openfmri.org/dataset/ds000107. The 49 subjects performed a visual one-back task with four categories of items: written words, objects, scrambled objects and consonant letter strings. The fMRI data were collected using a 1.5 T Siemens scanner. A repetition time of 3 seconds was used and a total of 165 volumes were collected for each run, the spatial resolution is 3 x 3 x 3 mm 3 . The dataset contains two runs per subject, but only the first run was used in our analysis. The data were analyzed using four regressors; words, objects, scrambled objects, consonant strings. A total of six contrasts were applied; words, objects, scrambled objects, consonant strings, objects versus scrambled objects (0,1,-1,0) and words versus consonant strings (1,0,0,-1). For a cluster defining threshold of p = 0.01, a t-threshold of 2.38 was used. For a cluster defining threshold of p = 0.001, a t-threshold of 3.28 was used. "}]