[{"section_title": "Abstract", "text": "Abstract. Many successful segmentation algorithms are based on Bayesian models in which prior anatomical knowledge is combined with the available image information. However, these methods typically have many free parameters that are estimated to obtain point estimates only, whereas a faithful Bayesian analysis would also consider all possible alternate values these parameters may take. In this paper, we propose to incorporate the uncertainty of the free parameters in Bayesian segmentation models more accurately by using Monte Carlo sampling. We demonstrate our technique by sampling atlas warps in a recent method for hippocampal subfield segmentation, and show a significant improvement in an Alzheimer's disease classification task. As an additional benefit, the method also yields informative \"error bars\" on the segmentation results for each of the individual sub-structures."}, {"section_title": "Introduction", "text": "Many segmentation algorithms in medical image analysis are based on Bayesian modeling, in which generative image models are constructed and subsequently \"inverted\" to obtain automated segmentations. Such methods have a prior that makes predictions about where anatomical structures typically occur throughout the image, such as Markov random field models or probabilistic atlases [1, 2] . They also include a likelihood term that models the relationship between segmentation labels and image intensities, often incorporating explicit models of imaging artifacts [3] . Once the prior and likelihood have been specified, the posterior distribution over all possible segmentations can be inferred using Bayes' rule. It is then possible to search for the segmentation that maximizes this posterior, or to directly estimate from it the volumes of specific structures.\nAlthough these methods are clearly \"Bayesian\", an issue that is usually overlooked is that they only apply Bayesian analysis in an approximate sense. In particular, these models typically have many free parameters for which suitable values are unknown a priori. In a true Bayesian approach, such parameters need to be integrated over when inferring the segmentation posterior. But, in practice, their optimal values are first estimated and only the resulting point estimates are used to compute the segmentation posterior instead. In recent years generative models have started to include deformable registration methods that warp probabilistic atlases into the domain of the image being analyzed, often adding thousands of free parameters to the model [4] [5] [6] [7] . Since many plausible atlas warps beside the truly optimal one may exist, computing segmentations based on a single warp may lead to biased results. Furthermore, the numerical optimizers computing such high-dimensional atlas warps may not necessarily find the global optimum, further contributing to segmentation errors.\nIn this paper, we investigate the effect of using a more accurate approximation of the segmentation posterior in Bayesian segmentation models than the point estimates of the free model parameters. In particular, we will approximate the integral over atlas deformations in a recently proposed method for hippocampal subfield segmentation [7] using Markov chain Monte Carlo (MCMC) sampling, and compare the results to those obtained using the most probable warp only. We show that MCMC sampling yields hippocampal subfield volume estimates that better discriminate controls from subjects with Alzheimer's disease, while providing informative \"error bars\" on those estimates as well.\nTo the best of our knowledge, the issue of integrating over free parameters in Bayesian segmentation models has not been addressed before in the literature. The closest work related to the techniques used in this paper infers the posterior distribution of deformation fields in the context of computing location-specific smoothing kernels [8] , quantifying registration uncertainties [9] , or constructing Bayesian deformable models [10] ."}, {"section_title": "Methods", "text": ""}, {"section_title": "Baseline Segmentation Method", "text": "We start from the Bayesian method for hippocampal subfield segmentation [7] that is publicly available as part of the FreeSurfer software package 1 . In this method, a segmentation prior is defined in the form of a tetrahedral mesh-based probabilistic atlas in which each mesh vertex has an associated vector of probabilities for the different hippocampal subfields and surrounding tissues (fimbria, presubiculum, subiculum, CA1, CA2/3, CA4/DG, hippocampal fissure, white matter, gray matter, and CSF). The resolution and topology of the mesh are locally adaptive to the level of shape complexity of each anatomical region, e.g., it is coarse in uniform regions and fine around convoluted boundaries. The mesh can be deformed according to a probabilistic model on the location of the mesh nodes p(x) \u221d exp(\u2212\u03c6(x)), where x is a vector containing the coordinates of the mesh nodes, and \u03c6(x) is an energy function that penalizes mesh positions in which the tetrahedra are deformed [11] . This function goes to infinity if the Jacobian determinant of any tetrahedron's deformation approaches zero, and therefore ensures that the mesh topology is preserved. For a given x, the prior probability p i (k|x) of tissue k occurring in voxel i is obtained by interpolating the probability vectors in the vertices of the deformed mesh. Assuming conditional independence of the labels between voxels given x, the prior probability of a segmentation is then given by p(l|x)\n. . , K} is a segmentation of an image with I voxels into K tissue types.\nFor the likelihood, we model the intensity of voxels in tissue k as a Gaussian distribution with parameters \u03bc k , \u03c3\n, where the vector y = (y 1 , . . . , y I )\nT contains the image intensities, and \u03b8 = (\u03bc 1 , \u03c3\nT represents the Gaussian distribution parameters. A non-informative prior for \u03b8 (i.e., p(\u03b8) \u221d 1) completes the model. Given an image to segment, the posterior over possible segmentations is given by p(l|y) = \u03b8 x p(l|y, x, \u03b8)p(x, \u03b8|y)dxd\u03b8, which takes into account the contribution of all possible values for the model parameters {x, \u03b8}, each weighted by their posterior probability p(x, \u03b8|y). In [7] , this integral is approximated by estimating the parameters with maximal weight {x,\u03b8} = arg max {x,\u03b8} p(x, \u03b8|y), and using the contribution of those parameters only, yielding\nThe segmentation maximizing this approximate posterior is obtained by simply assigning each voxel to the tissue class that maximizes Eq. (2). Furthermore, the volume of class k also has an (approximate) posterior distribution, with mean\nand variance \u03b3"}, {"section_title": "Incorporating Parameter Uncertainty", "text": "The approximation of Eq. (1) will be a good one if the posterior of the model parameters, p(x, \u03b8|y), is very peaked around {x,\u03b8}. Although this is a reasonable assumption for the Gaussian distribution parameters \u03b8 -one cannot alter them much without considerably decreasing the likelihood of the model -assuming a sharp peak for the mesh position x is not necessarily accurate, since moving vertices in areas with low image contrast does not drastically change p(x, \u03b8|y). We therefore propose to use a computationally more demanding but more accurate way of approximating p(l|y). Specifically, we propose to draw a number of samples x(n), n = 1, . . . , N from the posterior distribution p(x|y,\u03b8) using Monte Carlo sampling, and approximate the segmentation posterior by\nwhere in the first step we have used the mode approximation in the direction of \u03b8, as before, but in the second step the remaining integral is approximated by summing the contributions of many possible atlas warps (with more probable warps occurring more frequently), rather than by the contribution of a single point estimatex only. Given enough samples, this approximation can be made arbitrarily close to the true integral.\nOnce N samples x(n) are available, it follows from Eqs. (3) (4) (5) that the approximate posterior for the volume of tissue class k has mean and variance\nrespectively, where"}, {"section_title": "MCMC Sampling", "text": "In order to obtain the required samples x(n), we use a MCMC sampling technique known as the Hamiltonian Monte Carlo (HMC) method [12] , which is more efficient than traditional Metropolis schemes because it uses gradient information to reduce random walk behavior. Specifically, it facilitates large steps in x with relatively few evaluations of the target distribution p(x|y,\u03b8) and its gradient, by iteratively assigning a random momentum to each component of x, and then simulating the Hamiltonian dynamics of a system in which \u2212 log p(x|y,\u03b8) acts as an internal \"force\". In our implementation, we discretize the Hamiltonian trajectories using the so-called leapfrog method [12] , and simulate the Hamiltonian dynamics for a number of time steps sampled uniformly from [1, 50 ] to obtain a proposal for the Metropolis algorithm. Discretization step sizes that are adequate for some tetrahedra might be too large or small for others, leading to either slow convergence or too many rejected moves. We therefore use the following heuristic stepsize for each vertex:\n, where \u03b7 is a global adjustment factor and \u2202 2 /x 2 j denotes the second derivatives with respect to the three spatial coordinates of vertex j. Two samples of p(x|y,\u03b8) obtained using the proposed scheme are displayed in Fig. 1 ."}, {"section_title": "Experiments and Results", "text": "To investigate the effect of approximating the true posterior over the segmentations using parameter sampling instead of point estimates, we compared the performance of the estimated subfield volumes for both methods (Eq. (3) vs. Eq. (6)) in an Alzheimer's disease classification task 2 . In particular, we collected the volume estimates for all seven subfields (averaged over the left and right hemispheres) into a feature vector v for each subject, and trained and tested a simple multivariate classifier to discern between elderly controls (EC) and Alzheimer's disease patients (AD) in the corresponding feature space. We also compared the variance (\"error bars\") on the subfield volume estimates for both methods (Eq. (4) vs. Eq. (7)), and investigated the effect of incorporating this information in the training of the classifier as well."}, {"section_title": "Data and Experimental Set-Up", "text": "The 400 baseline T 1 scans from controls and AD subjects available in ADNI 3 where used in this study. The MRI pulse sequence is described elsewhere 3 . The volumes were preprocessed and parsed into 36 brain structures using FreeSurfer. We discarded 17 subjects for which FreeSurfer crashed. The demographics for the remaining 383 were: 56.2% controls (age 76.1 \u00b1 5.6), 43.8% Alzheimer's (age 75.5 \u00b1 7.6); 53.6% males (age 76.1 \u00b1 5.6), 46.4% females (age 75.9 \u00b1 6.8).\nAfter the segmentation of subcortical structures, the FreeSurfer hippocampal subfield segmentation routine (Section 2.1) was executed. The output {x,\u03b8} was used to initialize the HMC sampler, which was then used to generate N = 50 samples per subject. The parameter \u03b7 was tuned so that the average Metropolis rejection rate was approximately 25%. To decrease the correlation between successive samples, we recorded x at the end of every 200th Hamiltonian trajectory (chosen by visual inspection of the autocorrelation of subsequent runs). We allowed 300 initial \"burn-in\" runs before collecting samples. The running time of the sampling was roughly three hours."}, {"section_title": "Classification and ROC Analysis", "text": "We used a Quadratic Discriminant Analysis (QDA) classifier, which assumes that the feature vectors v in each group are normally distributed according to N (v|\u03bc EC , \u03a3 EC ) and N (v|\u03bc AD , \u03a3 AD ), respectively. The means and covariances were estimated from the available training samples. In testing, a subject was classified as EC or AD by thresholding the likelihood ratio N (v|\u03bc EC , \u03a3 EC )/ N (v|\u03bc AD , \u03a3 AD ) \u2276 \u03bb. The corresponding ROC curve (i.e., true positive rate vs. false positive rate) was obtained by sweeping the threshold \u03bb, and the area under the curve (A z ) was then used as a measure of performance. The ROCs were computed using cross-validation with two randomly selected folds.\nWe also analyzed the accuracy when the volume of the whole hippocampus is thresholded to separate EC from AD. We compared two estimates of the volume: (1) the sum of the volumes of the subfields; and (2) the estimate from the FreeSurfer pipeline. Finally, to assess the effect of sampling on training and testing separately, we conducted an experiment in which the classifier was trained on point estimate volumes and evaluated on MCMC volumes, and vice versa. Fig. 2 shows the ROC curves and the areas under them (A z ) for the different methods. Also shown are the p-values of paired DeLong statistical tests [14] that evaluate if the differences in A z are significant. At p = 0.05, sampling significantly outperformed point estimates in all cases (subfields and whole hippocampus). At the operating point closest to (0, 1), sampling provides a \u223c 2% increase in classification accuracy. Using all the subfields performed significantly better than the whole hippocampal volume alone. All methods based on the subfield analysis outperformed the standard FreeSurfer hippocampal segmentation."}, {"section_title": "Results", "text": "When the QDA was trained on the point estimate subfield volumes and tested on those obtained with sampling, we obtained A z = 0.875, and when the roles were switched, A z = 0.876. These values are better than when point estimate volumes were used for both training and testing, but worse than when sampling was used throughout, indicating that MCMC sampling is beneficial for both obtaining better discriminative directions and classifying individual subjects.\nWe also compared the variances of the hippocampal subfield volume posteriors ( Table 1 ). The point estimates (Eq. (4)) clearly underestimate them, especially for the larger subfields; e.g., the standard error for CA2-3 is 0.4% of its volume, unrealistic given the poor image contrast (Fig. 1) . In contrast, sampling (Eq. (7)) produces values between 5% and 10%, better reflecting the uncertainty in the estimated volumes.\nIn an attempt to take the MCMC volumetry uncertainty estimates into account in the classifier, we also trained a QDA by simply using all contributing volumes v k (n), n = 1, . . . , N = 50 in Eq. (6) for each subject -effectively using 50 times more training samples than there are training subjects. The ROC and the corresponding A z are displayed in Fig. 2 (labeled as \"error bars\") , showing a modest further improvement compared to when the classifier is trained using the mean values only. Although the improvement was not statistically significant (p \u2248 0.1), the ROC seems to be consistently better in the region that is closest to (0,1), where the operating point of the classifier would be typically defined."}, {"section_title": "Discussion", "text": "In this paper we proposed to approximate the segmentation posterior in probabilistic segmentation models more faithfully by using Monte Carlo samples of their free parameters. We demonstrated our technique by sampling atlas warps in a Bayesian method for hippocampal subfield segmentation, and showed a significant improvement in an Alzheimer's disease classification task. The method is general and can also be applied to other Bayesian segmentation models. It yields realistic confidence intervals on the segmentation results of individual structures, which we believe will convey important information when these techniques are ultimately applied in clinical settings. Furthermore, such confidence information may also help select the most suitable scanning protocol for imaging studies investigating the morphometry of specific anatomical structures. \"SF\" stands for subfields, \"WH\" for whole hippocampus, \"pe\" for point estimate, \"sp\" for sampling, \"eb\" for sampling with error bars (i.e. using all volumes v k (n) in Eq. (6)), and \"FS\" for FreeSurfer."}]